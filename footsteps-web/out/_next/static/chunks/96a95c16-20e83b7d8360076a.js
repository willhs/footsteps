"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[813],{7673:(t,e,i)=>{var r,s=Object.defineProperty,o=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,a=Object.prototype.hasOwnProperty,l={};((t,e)=>{for(var i in e)s(t,i,{get:e[i],enumerable:!0})})(l,{AmbientLight:()=>ty,Attribute:()=>iU,AttributeManager:()=>i8,COORDINATE_SYSTEM:()=>E,CompositeLayer:()=>rO,Controller:()=>e0,Deck:()=>ib,DeckRenderer:()=>it,DirectionalLight:()=>tT,FirstPersonController:()=>r1,FirstPersonView:()=>r3,FirstPersonViewport:()=>rJ,FlyToInterpolator:()=>sm,Layer:()=>rL,LayerExtension:()=>sp,LayerManager:()=>eA,LightingEffect:()=>tI,LinearInterpolator:()=>eH,MapController:()=>e4,MapView:()=>e6,OPERATION:()=>R,OrbitController:()=>r6,OrbitView:()=>r9,OrbitViewport:()=>rW,OrthographicController:()=>se,OrthographicView:()=>sr,OrthographicViewport:()=>rH,PointLight:()=>ei,PostProcessEffect:()=>ec,TRANSITION_EVENTS:()=>eD,Tesselator:()=>sv,TransitionInterpolator:()=>eW,UNIT:()=>A,VERSION:()=>_,View:()=>ek,Viewport:()=>tK,WebMercatorViewport:()=>t1,_CameraLight:()=>er,_Component:()=>ry,_ComponentState:()=>rP,_GlobeController:()=>sa,_GlobeView:()=>sh,_GlobeViewport:()=>rF,_LayersPass:()=>tj,_PickLayersPass:()=>eu,_SunLight:()=>eo,_applyStyles:()=>sw,_compareProps:()=>ro,_count:()=>rl,_deepEqual:()=>eC,_fillArray:()=>eM,_flatten:()=>eS,_memoize:()=>O,_mergeShaders:()=>rh,_removeStyles:()=>sy,assert:()=>eG,createIterable:()=>iL,fp64LowPart:()=>tN,getShaderAssembler:()=>t_,gouraudLighting:()=>w.gouraudLighting,log:()=>p,phongLighting:()=>w.phongLighting,picking:()=>tu,project:()=>J,project32:()=>Q,shadow:()=>tp}),t.exports=((t,e,i,r)=>{if(e&&"object"==typeof e||"function"==typeof e)for(let l of n(e))a.call(t,l)||l===i||s(t,l,{get:()=>e[l],enumerable:!(r=o(e,l))||r.enumerable});return t})(s({},"__esModule",{value:!0}),l);var h=i(2489),c=i(5828),p=new(i(7658)).Log({id:"deck"}),d={attributeUpdateStart:-1,attributeManagerUpdateStart:-1,attributeUpdateMessages:[]},u={};function f(t){u=t}function g(t,e,i,r){p.level>0&&u[t]&&u[t].call(null,e,i,r)}u=(t=>({"layer.changeFlag":(e,i,r)=>{t.log(3,`${e.id} ${i}: `,r[i])()},"layer.initialize":e=>{t.log(1,`Initializing ${e}`)()},"layer.update":(e,i)=>{if(i){let i=e.getChangeFlags();t.log(2,`Updating ${e} because: ${Object.keys(i).filter(t=>i[t]).join(", ")}`)()}else t.log(4,`${e} does not need update`)()},"layer.matched":(e,i)=>{i&&t.log(4,`Matched ${e}, state transfered`)()},"layer.finalize":e=>{t.log(1,`Finalizing ${e}`)()},"compositeLayer.renderLayers":(e,i,r)=>{i?t.log(2,`Composite layer rendered new subLayers ${e}`,r)():t.log(4,`Composite layer reused subLayers ${e}`,r)()},"layerManager.setLayers":(e,i,r)=>{i&&t.log(2,`Updating ${r.length} deck layers`)()},"layerManager.activateViewport":(e,i)=>{t.log(3,"Viewport changed",i)()},"attributeManager.invalidate":(e,i,r)=>{t.log(1,r?`invalidated attributes ${r} (${i}) for ${e.id}`:`invalidated all attributes for ${e.id}`)()},"attributeManager.updateStart":t=>{d.attributeUpdateMessages.length=0,d.attributeManagerUpdateStart=Date.now()},"attributeManager.updateEnd":(e,i)=>{let r=Math.round(Date.now()-d.attributeManagerUpdateStart);for(let s of(t.groupCollapsed(2,`Updated attributes for ${i} instances in ${e.id} in ${r}ms`)(),d.attributeUpdateMessages))t.log(3,s)();t.groupEnd(2)()},"attribute.updateStart":t=>{d.attributeUpdateStart=Date.now()},"attribute.allocate":(t,e)=>{let i=`${t.id} allocated ${e}`;d.attributeUpdateMessages.push(i)},"attribute.updateEnd":(t,e)=>{let i=Math.round(Date.now()-d.attributeUpdateStart),r=`${t.id} updated ${e} in ${i}ms`;d.attributeUpdateMessages.push(r)},"deckRenderer.renderLayers":(e,i,r)=>{let{pass:s,redrawReason:o,stats:n}=r;for(let r of i){let{totalCount:i,visibleCount:a,compositeCount:l,pickableCount:h}=r,c=i-l-a;t.log(2,`RENDER #${e.renderCount}   ${a} (of ${i} layers) to ${s} because ${o}   (${c} hidden, ${l} composite ${h} pickable)`)(),n&&n.get("Redraw Layers").add(a)}}}))(p);var m={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:function(t){let e=t[0],i=t[t.length-1];return"{"===e&&"}"===i||"["===e&&"]"===i},parseTextSync:JSON.parse},_=function(){let t="9.1.14",e=globalThis.deck&&globalThis.deck.VERSION;if(e&&e!==t)throw Error(`deck.gl - multiple versions detected: ${e} vs ${t}`);return e||(p.log(1,`deck.gl ${t}`)(),globalThis.deck={...globalThis.deck,VERSION:t,version:t,log:p,_registerLoggers:f},(0,h.registerLoaders)([m,[c.ImageLoader,{imagebitmap:{premultiplyAlpha:"none"}}]])),t}(),v=i(2763),w=i(2763),y=`uniform layerUniforms {
  uniform float opacity;
} layer;
`,b={name:"layer",vs:y,fs:y,getUniforms:t=>({opacity:Math.pow(t.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}},P="#define SMOOTH_EDGE_RADIUS 0.5",S={name:"geometry",source:`const SMOOTH_EDGE_RADIUS: f32 = 0.5;

struct VertexGeometry {
  position: vec4<f32>,
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

var<private> geometry_: VertexGeometry = VertexGeometry(
  vec4<f32>(0.0, 0.0, 1.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec2<f32>(0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0)
);

struct FragmentGeometry {
  uv: vec2<f32>,
};

var<private> fragmentGeometry: FragmentGeometry;

fn smoothedge(edge: f32, x: f32) -> f32 {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,vs:`${P}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,fs:`${P}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`},M=i(2763),T=i(5595),x=i(8641),E={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(E,"IDENTITY",{get:()=>(p.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});var j={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},A={common:0,meters:1,pixels:2},C={click:"onClick",dblclick:"onClick",panstart:"onDragStart",panmove:"onDrag",panend:"onDragEnd"},L={multipan:[x.Pan,{threshold:10,direction:x.InputDirection.Vertical,pointers:2}],pinch:[x.Pinch,{},null,["multipan"]],pan:[x.Pan,{threshold:1},["pinch"],["multipan"]],dblclick:[x.Tap,{event:"dblclick",taps:2}],click:[x.Tap,{event:"click"},null,["dblclick"]]},R={DRAW:"draw",MASK:"mask",TERRAIN:"terrain"};function O(t){let e,i={};return r=>{for(let s in r)if(!function(t,e){if(t===e)return!0;if(Array.isArray(t)){let i=t.length;if(!e||e.length!==i)return!1;for(let r=0;r<i;r++)if(t[r]!==e[r])return!1;return!0}return!1}(r[s],i[s])){e=t(r),i=r;break}return e}}var I=[0,0,0,0],k=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],z=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],V=[0,0,0],U=[0,0,0],D=O(function({viewport:t,devicePixelRatio:e,coordinateSystem:i,coordinateOrigin:r}){let{projectionCenter:s,viewProjectionMatrix:o,originCommon:n,cameraPosCommon:a,shaderCoordinateOrigin:l,geospatialOrigin:h}=function(t,e,i){let{viewMatrixUncentered:r,projectionMatrix:s}=t,{viewMatrix:o,viewProjectionMatrix:n}=t,a=I,l=I,h=t.cameraPosition,{geospatialOrigin:c,shaderCoordinateOrigin:p,offsetMode:d}=F(t,e,i);return d&&(l=t.projectPosition(c||p),h=[h[0]-l[0],h[1]-l[1],h[2]-l[2]],l[3]=1,a=T.vec4.transformMat4([],l,n),o=r||o,n=T.mat4.multiply([],s,o),n=T.mat4.multiply([],n,k)),{viewMatrix:o,viewProjectionMatrix:n,projectionCenter:a,originCommon:l,cameraPosCommon:h,shaderCoordinateOrigin:p,geospatialOrigin:c}}(t,i,r),c=t.getDistanceScales(),p=[t.width*e,t.height*e],d=T.vec4.transformMat4([],[0,0,-t.focalDistance,1],t.projectionMatrix)[3]||1,u={coordinateSystem:i,projectionMode:t.projectionMode,coordinateOrigin:l,commonOrigin:n.slice(0,3),center:s,pseudoMeters:!!t._pseudoMeters,viewportSize:p,devicePixelRatio:e,focalDistance:d,commonUnitsPerMeter:c.unitsPerMeter,commonUnitsPerWorldUnit:c.unitsPerMeter,commonUnitsPerWorldUnit2:V,scale:t.scale,wrapLongitude:!1,viewProjectionMatrix:o,modelMatrix:z,cameraPosition:a};if(h){let e=t.getDistanceScales(h);switch(i){case E.METER_OFFSETS:u.commonUnitsPerWorldUnit=e.unitsPerMeter,u.commonUnitsPerWorldUnit2=e.unitsPerMeter2;break;case E.LNGLAT:case E.LNGLAT_OFFSETS:t._pseudoMeters||(u.commonUnitsPerMeter=e.unitsPerMeter),u.commonUnitsPerWorldUnit=e.unitsPerDegree,u.commonUnitsPerWorldUnit2=e.unitsPerDegree2;break;case E.CARTESIAN:u.commonUnitsPerWorldUnit=[1,1,e.unitsPerMeter[2]],u.commonUnitsPerWorldUnit2=[0,0,e.unitsPerMeter2[2]]}}return u});function F(t,e,i=U){let r;i.length<3&&(i=[i[0],i[1],0]);let s=i,o=!0;switch(r=e===E.LNGLAT_OFFSETS||e===E.METER_OFFSETS?i:t.isGeospatial?[Math.fround(t.longitude),Math.fround(t.latitude),0]:null,t.projectionMode){case j.WEB_MERCATOR:(e===E.LNGLAT||e===E.CARTESIAN)&&(r=[0,0,0],o=!1);break;case j.WEB_MERCATOR_AUTO_OFFSET:e===E.LNGLAT?s=r:e===E.CARTESIAN&&(s=[Math.fround(t.center[0]),Math.fround(t.center[1]),0],r=t.unprojectPosition(s),s[0]-=i[0],s[1]-=i[1],s[2]-=i[2]);break;case j.IDENTITY:(s=t.position.map(Math.fround))[2]=s[2]||0;break;case j.GLOBE:o=!1,r=null;break;default:o=!1}return{geospatialOrigin:r,shaderCoordinateOrigin:s,offsetMode:o}}function N({viewport:t,devicePixelRatio:e=1,modelMatrix:i=null,coordinateSystem:r=E.DEFAULT,coordinateOrigin:s=U,autoWrapLongitude:o=!1}){r===E.DEFAULT&&(r=t.isGeospatial?E.LNGLAT:E.CARTESIAN);let n=D({viewport:t,devicePixelRatio:e,coordinateSystem:r,coordinateOrigin:s});return n.wrapLongitude=o,n.modelMatrix=i||z,n}var B=Object.keys(E).map(t=>`const COORDINATE_SYSTEM_${t}: i32 = ${E[t]};`).join(""),$=Object.keys(j).map(t=>`const PROJECTION_MODE_${t}: i32 = ${j[t]};`).join(""),G=Object.keys(A).map(t=>`const UNIT_${t.toUpperCase()}: i32 = ${A[t]};`).join(""),W=`${B}
${$}
${G}

const TILE_SIZE: f32 = 512.0;
const PI: f32 = 3.1415926536;
const WORLD_SCALE: f32 = TILE_SIZE / (PI * 2.0);
const ZERO_64_LOW: vec3<f32> = vec3<f32>(0.0, 0.0, 0.0);
const EARTH_RADIUS: f32 = 6370972.0; // meters
const GLOBE_RADIUS: f32 = 256.0;

// -----------------------------------------------------------------------------
// Uniform block (converted from GLSL uniform block)
// -----------------------------------------------------------------------------
struct ProjectUniforms {
  wrapLongitude: i32,
  coordinateSystem: i32,
  commonUnitsPerMeter: vec3<f32>,
  projectionMode: i32,
  scale: f32,
  commonUnitsPerWorldUnit: vec3<f32>,
  commonUnitsPerWorldUnit2: vec3<f32>,
  center: vec4<f32>,
  modelMatrix: mat4x4<f32>,
  viewProjectionMatrix: mat4x4<f32>,
  viewportSize: vec2<f32>,
  devicePixelRatio: f32,
  focalDistance: f32,
  cameraPosition: vec3<f32>,
  coordinateOrigin: vec3<f32>,
  commonOrigin: vec3<f32>,
  pseudoMeters: i32,
};

@group(0) @binding(0)
var<uniform> project: ProjectUniforms;

// -----------------------------------------------------------------------------
// Geometry data
// (In your GLSL code, "geometry" was assumed to be available globally. In WGSL,
// you might supply this via vertex attributes or a uniform. Here we define a
// uniform struct for demonstration.)
// -----------------------------------------------------------------------------

// Structure to carry additional geometry data used by deck.gl filters.
struct Geometry {
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  position: vec4<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

// @group(0) @binding(1)
var<private> geometry: Geometry;
`,Z=`${W}

// -----------------------------------------------------------------------------
// Functions
// -----------------------------------------------------------------------------

// Returns an adjustment factor for commonUnitsPerMeter
fn _project_size_at_latitude(lat: f32) -> f32 {
  let y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

// Overloaded version: scales a value in meters at a given latitude.
fn _project_size_at_latitude_m(meters: f32, lat: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * _project_size_at_latitude(lat);
}

// Computes a non-linear scale factor based on geometry.
// (Note: This function relies on "geometry" being provided.)
fn project_size() -> f32 {
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
      project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
      project.pseudoMeters == 0) {
    if (geometry.position.w == 0.0) {
      return _project_size_at_latitude(geometry.worldPosition.y);
    }
    let y: f32 = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    let y2 = y * y;
    let y4 = y2 * y2;
    let y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

// Overloads to scale offsets (meters to world units)
fn project_size_float(meters: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * project_size();
}

fn project_size_vec2(meters: vec2<f32>) -> vec2<f32> {
  return meters * project.commonUnitsPerMeter.xy * project_size();
}

fn project_size_vec3(meters: vec3<f32>) -> vec3<f32> {
  return meters * project.commonUnitsPerMeter * project_size();
}

fn project_size_vec4(meters: vec4<f32>) -> vec4<f32> {
  return vec4<f32>(meters.xyz * project.commonUnitsPerMeter, meters.w);
}

// Returns a rotation matrix aligning the z\u2011axis with the given up vector.
fn project_get_orientation_matrix(up: vec3<f32>) -> mat3x3<f32> {
  let uz = normalize(up);
  let ux = select(
    vec3<f32>(1.0, 0.0, 0.0),
    normalize(vec3<f32>(uz.y, -uz.x, 0.0)),
    abs(uz.z) == 1.0
  );
  let uy = cross(uz, ux);
  return mat3x3<f32>(ux, uy, uz);
}

// Since WGSL does not support "out" parameters, we return a struct.
struct RotationResult {
  needsRotation: bool,
  transform: mat3x3<f32>,
};

fn project_needs_rotation(commonPosition: vec3<f32>) -> RotationResult {
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    return RotationResult(true, project_get_orientation_matrix(commonPosition));
  } else {
    return RotationResult(false, mat3x3<f32>());  // identity alternative if needed
  };
}

// Projects a normal vector from the current coordinate system to world space.
fn project_normal(vector: vec3<f32>) -> vec3<f32> {
  let normal_modelspace = project.modelMatrix * vec4<f32>(vector, 0.0);
  var n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
  let rotResult = project_needs_rotation(geometry.position.xyz);
  if (rotResult.needsRotation) {
    n = rotResult.transform * n;
  }
  return n;
}

// Applies a scale offset based on y-offset (dy)
fn project_offset_(offset: vec4<f32>) -> vec4<f32> {
  let dy: f32 = offset.y;
  let commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
  return vec4<f32>(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

// Projects lng/lat coordinates to a unit tile [0,1]
fn project_mercator_(lnglat: vec2<f32>) -> vec2<f32> {
  var x = lnglat.x;
  if (project.wrapLongitude != 0) {
    x = ((x + 180.0) % 360.0) - 180.0;
  }
  let y = clamp(lnglat.y, -89.9, 89.9);
  return vec2<f32>(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// Projects lng/lat/z coordinates for a globe projection.
fn project_globe_(lnglatz: vec3<f32>) -> vec3<f32> {
  let lambda = radians(lnglatz.x);
  let phi = radians(lnglatz.y);
  let cosPhi = cos(phi);
  let D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
  return vec3<f32>(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

// Projects positions (with an optional 64-bit low part) from the input
// coordinate system to the common space.
fn project_position_vec4_f64(position: vec4<f32>, position64Low: vec3<f32>) -> vec4<f32> {
  var position_world = project.modelMatrix * position;

  // Work around for a Mac+NVIDIA bug:
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_mercator_(position_world.xy),
        _project_size_at_latitude_m(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world = vec4f(position_world.xyz + project.coordinateOrigin, position_world.w);
    }
  }
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
        return vec4<f32>(
          project_mercator_(position_world.xy) - project.commonOrigin.xy,
          project_size_float(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
      (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
       (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
        project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world = vec4f(position_world.xyz - project.coordinateOrigin, position_world.w);
  }

  return project_offset_(position_world) +
         project_offset_(project.modelMatrix * vec4<f32>(position64Low, 0.0));
}

// Overloaded versions for different input types.
fn project_position_vec4_f32(position: vec4<f32>) -> vec4<f32> {
  return project_position_vec4_f64(position, ZERO_64_LOW);
}

fn project_position_vec3_f64(position: vec3<f32>, position64Low: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), position64Low);
  return projected_position.xyz;
}

fn project_position_vec3_f32(position: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

fn project_position_vec2_f32(position: vec2<f32>) -> vec2<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

// Transforms a common space position to clip space.
fn project_common_position_to_clipspace_with_projection(position: vec4<f32>, viewProjectionMatrix: mat4x4<f32>, center: vec4<f32>) -> vec4<f32> {
  return viewProjectionMatrix * position + center;
}

// Uses the project viewProjectionMatrix and center.
fn project_common_position_to_clipspace(position: vec4<f32>) -> vec4<f32> {
  return project_common_position_to_clipspace_with_projection(position, project.viewProjectionMatrix, project.center);
}

// Returns a clip space offset corresponding to a given number of screen pixels.
fn project_pixel_size_to_clipspace(pixels: vec2<f32>) -> vec2<f32> {
  let offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
  return offset * project.focalDistance;
}

fn project_meter_size_to_pixel(meters: f32) -> f32 {
  return project_size_float(meters) * project.scale;
}

fn project_unit_size_to_pixel(size: f32, unit: i32) -> f32 {
  if (unit == UNIT_METERS) {
    return project_meter_size_to_pixel(size);
  } else if (unit == UNIT_COMMON) {
    return size * project.scale;
  }
  // UNIT_PIXELS: no scaling applied.
  return size;
}

fn project_pixel_size_float(pixels: f32) -> f32 {
  return pixels / project.scale;
}

fn project_pixel_size_vec2(pixels: vec2<f32>) -> vec2<f32> {
  return pixels / project.scale;
}
`,Y=Object.keys(E).map(t=>`const int COORDINATE_SYSTEM_${t} = ${E[t]};`).join(""),q=Object.keys(j).map(t=>`const int PROJECTION_MODE_${t} = ${j[t]};`).join(""),H=Object.keys(A).map(t=>`const int UNIT_${t.toUpperCase()} = ${A[t]};`).join(""),X=`${Y}
${q}
${H}
uniform projectUniforms {
bool wrapLongitude;
int coordinateSystem;
vec3 commonUnitsPerMeter;
int projectionMode;
float scale;
vec3 commonUnitsPerWorldUnit;
vec3 commonUnitsPerWorldUnit2;
vec4 center;
mat4 modelMatrix;
mat4 viewProjectionMatrix;
vec2 viewportSize;
float devicePixelRatio;
float focalDistance;
vec3 cameraPosition;
vec3 coordinateOrigin;
vec3 commonOrigin;
bool pseudoMeters;
} project;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project.pseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project.commonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project.commonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project.commonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project.wrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project.modelMatrix * position;
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project.coordinateOrigin;
}
}
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project.commonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
(project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project.coordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
return offset * project.focalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project.scale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project.scale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project.scale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project.scale;
}
`,K={},J={name:"project",dependencies:[M.fp32,S],source:Z,vs:X,getUniforms:function(t=K){return"viewport"in t?N(t):{}},uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}},Q={name:"project32",dependencies:[J],source:`// Define a structure to hold both the clip-space position and the common position.
struct ProjectResult {
  clipPosition: vec4<f32>,
  commonPosition: vec4<f32>,
};

// This function mimics the GLSL version with the 'out' parameter by returning both values.
fn project_position_to_clipspace_and_commonspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> ProjectResult {
  // Compute the projected position.
  let projectedPosition: vec3<f32> = project_position_vec3_f64(position, position64Low);

  // Start with the provided offset.
  var finalOffset: vec3<f32> = offset;

  // Get whether a rotation is needed and the rotation matrix.
  let rotationResult = project_needs_rotation(projectedPosition);

  // If rotation is needed, update the offset.
  if (rotationResult.needsRotation) {
    finalOffset = rotationResult.transform * offset;
  }

  // Compute the common position.
  let commonPosition: vec4<f32> = vec4<f32>(projectedPosition + finalOffset, 1.0);

  // Convert to clip-space.
  let clipPosition: vec4<f32> = project_common_position_to_clipspace(commonPosition);

  return ProjectResult(clipPosition, commonPosition);
}

// A convenience overload that returns only the clip-space position.
fn project_position_to_clipspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> vec4<f32> {
  return project_position_to_clipspace_and_commonspace(position, position64Low, offset).clipPosition;
}
`,vs:`vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`},tt=i(5595),te=i(261),ti=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,tr=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,ts=`
${ti}
${tr}
`,to=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,tn=`
${ti}
${to}
`,ta=O(function({viewport:t,center:e}){return new tt.Matrix4(t.viewProjectionMatrix).invert().transform(e)}),tl=O(function({viewport:t,shadowMatrices:e}){let i=[],r=t.pixelUnprojectionMatrix,s=t.isGeospatial?void 0:1,o=[[0,0,s],[t.width,0,s],[0,t.height,s],[t.width,t.height,s],[0,0,-1],[t.width,0,-1],[0,t.height,-1],[t.width,t.height,-1]].map(t=>(function(t,e){let[i,r,s]=t,o=(0,te.pixelsToWorld)([i,r,s],e);return Number.isFinite(s)?o:[o[0],o[1],0]})(t,r));for(let r of e){let e=r.clone().translate(new tt.Vector3(t.center).negate()),s=o.map(t=>e.transform(t)),n=new tt.Matrix4().ortho({left:Math.min(...s.map(t=>t[0])),right:Math.max(...s.map(t=>t[0])),bottom:Math.min(...s.map(t=>t[1])),top:Math.max(...s.map(t=>t[1])),near:Math.min(...s.map(t=>-t[2])),far:Math.max(...s.map(t=>-t[2]))});i.push(n.multiplyRight(r))}return i}),th=[0,0,0,1],tc=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],tp={name:"shadow",dependencies:[J],vs:ts,fs:tn,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:function(t){let{shadowEnabled:e=!0,project:i}=t;if(!e||!i||!t.shadowMatrices||!t.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:t.dummyShadowMap,shadow_uShadowMap1:t.dummyShadowMap};let r=J.getUniforms(i),s=ta({viewport:i.viewport,center:r.center}),o=[],n=tl({shadowMatrices:t.shadowMatrices,viewport:i.viewport}).slice();for(let e=0;e<t.shadowMatrices.length;e++){let t=n[e],a=t.clone().translate(new tt.Vector3(i.viewport.center).negate());r.coordinateSystem===E.LNGLAT&&r.projectionMode===j.WEB_MERCATOR?(n[e]=a,o[e]=s):(n[e]=t.clone().multiplyRight(tc),o[e]=a.transform(s))}let a={drawShadowMap:!!t.drawToShadowMap,useShadowMap:!!t.shadowMaps&&t.shadowMaps.length>0,color:t.shadowColor||th,lightId:t.shadowLightId||0,lightCount:t.shadowMatrices.length,shadow_uShadowMap0:t.dummyShadowMap,shadow_uShadowMap1:t.dummyShadowMap};for(let t=0;t<n.length;t++)a[`viewProjectionMatrix${t}`]=n[t],a[`projectCenter${t}`]=o[t];for(let e=0;e<2;e++)a[`shadow_uShadowMap${e}`]=t.shadowMaps&&t.shadowMaps[e]||t.dummyShadowMap;return a},uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},td=i(2763),tu={...td.picking,defaultUniforms:{...td.picking.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},tf=[S],tg=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],tm=[];function t_(t){let e=v.ShaderAssembler.getDefaultShaderAssembler();for(let t of tf)e.addDefaultModule(t);for(let i of"glsl"===t?tg:tm)e.addShaderHook(i);return e}var tv=[255,255,255],tw=0,ty=class{constructor(t={}){this.type="ambient";let{color:e=tv}=t,{intensity:i=1}=t;this.id=t.id||`ambient-${tw++}`,this.color=e,this.intensity=i}},tb=i(5595),tP=[255,255,255],tS=[0,0,-1],tM=0,tT=class{constructor(t={}){this.type="directional";let{color:e=tP}=t,{intensity:i=1}=t,{direction:r=tS}=t,{_shadow:s=!1}=t;this.id=t.id||`directional-${tM++}`,this.color=e,this.intensity=i,this.type="directional",this.direction=new tb.Vector3(r).normalize().toArray(),this.shadow=s}getProjectedLight(t){return this}},tx=i(5595),tE=class{constructor(t,e={id:"pass"}){let{id:i}=e;this.id=i,this.device=t,this.props={...e}}setProps(t){Object.assign(this.props,t)}render(t){}cleanup(){}},tj=class extends tE{constructor(){super(...arguments),this._lastRenderIndex=-1}render(t){let[e,i]=this.device.canvasContext.getDrawingBufferSize(),r=t.clearCanvas??!0,s=t.clearColor??(!!r&&[0,0,0,0]),o=t.colorMask??15,n={viewport:[0,0,e,i]};t.colorMask&&(n.colorMask=o),t.scissorRect&&(n.scissorRect=t.scissorRect);let a=this.device.beginRenderPass({framebuffer:t.target,parameters:n,clearColor:s,clearDepth:!!r&&1,clearStencil:!!r&&0});try{return this._drawLayers(a,t)}finally{a.end(),this.device.submit()}}_drawLayers(t,e){let{target:i,shaderModuleProps:r,viewports:s,views:o,onViewportActive:n,clearStack:a=!0}=e;e.pass=e.pass||"unknown",a&&(this._lastRenderIndex=-1);let l=[];for(let a of s){let s=o&&o[a.id];null==n||n(a);let h=this._getDrawLayerParams(a,e);for(let o of a.subViewports||[a]){let n=this._drawLayersInViewport(t,{target:i,shaderModuleProps:r,viewport:o,view:s,pass:e.pass,layers:e.layers},h);l.push(n)}}return l}_getDrawLayerParams(t,{layers:e,pass:i,isPicking:r=!1,layerFilter:s,cullRect:o,effects:n,shaderModuleProps:a},l=!1){var h;let c=[],p=function t(e=0,i={}){let r={},s=(o,n)=>{let a,l=o.props._offset,h=o.id,c=o.parent&&o.parent.id;if(!c||c in i||s(o.parent,!1),c in r){let e=r[c]=r[c]||t(i[c],i);a=e(o,n),r[h]=e}else Number.isFinite(l)?(a=l+(i[c]||0),r[h]=null):a=e;return n&&a>=e&&(e=a+1),i[h]=a,a};return s}(this._lastRenderIndex+1),d={layer:e[0],viewport:t,isPicking:r,renderPass:i,cullRect:o},u={};for(let r=0;r<e.length;r++){let o=e[r],f=this._shouldDrawLayer(o,d,s,u),g={shouldDrawLayer:f};f&&!l&&(g.shouldDrawLayer=!0,g.layerRenderIndex=p(o,f),g.shaderModuleProps=this._getShaderModuleProps(o,n,i,a),g.layerParameters={...null==(h=o.context.deck)?void 0:h.props.parameters,...this.getLayerParameters(o,r,t)}),c[r]=g}return c}_drawLayersInViewport(t,{layers:e,shaderModuleProps:i,pass:r,target:s,viewport:o,view:n},a){let l=function(t,{shaderModuleProps:e,target:i,viewport:r}){var s;let o=(null==(s=null==e?void 0:e.project)?void 0:s.devicePixelRatio)??t.canvasContext.cssToDeviceRatio(),[,n]=t.canvasContext.getDrawingBufferSize(),a=i?i.height:n;return[r.x*o,a-(r.y+r.height)*o,r.width*o,r.height*o]}(this.device,{shaderModuleProps:i,target:s,viewport:o});if(n&&n.props.clear){let t=!0===n.props.clear?{color:!0,depth:!0}:n.props.clear;this.device.beginRenderPass({framebuffer:s,parameters:{viewport:l,scissorRect:l},clearColor:!!t.color&&[0,0,0,0],clearDepth:!!t.depth&&1}).end()}let h={totalCount:e.length,visibleCount:0,compositeCount:0,pickableCount:0};t.setParameters({viewport:l});for(let i=0;i<e.length;i++){let s=e[i],n=a[i],{shouldDrawLayer:l}=n;if(l&&s.props.pickable&&h.pickableCount++,s.isComposite&&h.compositeCount++,s.isDrawable&&n.shouldDrawLayer){let{layerRenderIndex:e,shaderModuleProps:i,layerParameters:a}=n;h.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,e),i.project&&(i.project.viewport=o),s.context.renderPass=t;try{s._drawLayer({renderPass:t,shaderModuleProps:i,uniforms:{layerIndex:e},parameters:a})}catch(t){s.raiseError(t,`drawing ${s} to ${r}`)}}}return h}shouldDrawLayer(t){return!0}getShaderModuleProps(t,e,i){return null}getLayerParameters(t,e,i){return t.props.parameters}_shouldDrawLayer(t,e,i,r){if(!(t.props.visible&&this.shouldDrawLayer(t)))return!1;e.layer=t;let s=t.parent;for(;s;){if(!s.props.visible||!s.filterSubLayer(e))return!1;e.layer=s,s=s.parent}if(i){let t=e.layer.id;if(t in r||(r[t]=i(e)),!r[t])return!1}return t.activateViewport(e.viewport),!0}_getShaderModuleProps(t,e,i,r){var s,o;let n=this.device.canvasContext.cssToDeviceRatio(),a=(null==(s=t.internalState)?void 0:s.propsInTransition)||t.props,l={layer:a,picking:{isActive:!1},project:{viewport:t.context.viewport,devicePixelRatio:n,modelMatrix:a.modelMatrix,coordinateSystem:a.coordinateSystem,coordinateOrigin:a.coordinateOrigin,autoWrapLongitude:t.wrapLongitude}};if(e)for(let i of e)tA(l,null==(o=i.getShaderModuleProps)?void 0:o.call(i,t,l));return tA(l,this.getShaderModuleProps(t,e,l),r)}};function tA(t,...e){for(let i of e)if(i)for(let e in i)t[e]?Object.assign(t[e],i[e]):t[e]=i[e];return t}var tC=class extends tj{constructor(t,e){super(t,e);let i=t.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},mipmaps:!0}),r=t.createTexture({format:"depth16unorm",width:1,height:1,mipmaps:!1});this.fbo=t.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[i],depthStencilAttachment:r})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(t){let e=this.fbo,i=this.device.canvasContext.cssToDeviceRatio(),r=t.viewports[0],s=r.width*i,o=r.height*i;(s!==e.width||o!==e.height)&&e.resize({width:s,height:o}),super.render({...t,clearColor:[1,1,1,1],target:e,pass:"shadow"})}getLayerParameters(t,e,i){return{...t.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(t){return!1!==t.props.shadowEnabled}getShaderModuleProps(t,e,i){return{shadow:{project:i.project,drawToShadowMap:!0}}}},tL={color:[255,255,255],intensity:1},tR=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],tO=[0,0,0,200/255],tI=class{constructor(t={}){this.id="lighting-effect",this.shadowColor=tO,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(t)}setup(t){this.context=t;let{device:e,deck:i}=t;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(e),i._addDefaultShaderModule(tp),this.dummyShadowMap=e.createTexture({width:1,height:1}))}setProps(t){for(let e in this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[],t){let i=t[e];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i)}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow),this.context&&this.setup(this.context),this.props=t}preRender({layers:t,layerFilter:e,viewports:i,onViewportActive:r,views:s}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let o=0;o<this.shadowPasses.length;o++)this.shadowPasses[o].render({layers:t,layerFilter:e,viewports:i,onViewportActive:r,views:s,shaderModuleProps:{shadow:{shadowLightId:o,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(t,e){let i=this.shadow?{project:e.project,shadowMaps:this.shadowPasses.map(t=>t.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},r={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(e=>e.getProjectedLight({layer:t})),pointLights:this.pointLights.map(e=>e.getProjectedLight({layer:t}))},s=t.props.material;return{shadow:i,lighting:r,phongMaterial:s,gouraudMaterial:s}}cleanup(t){for(let t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,t.deck._removeDefaultShaderModule(tp))}_calculateMatrices(){let t=[];for(let e of this.directionalLights){let i=new tx.Matrix4().lookAt({eye:new tx.Vector3(e.direction).negate()});t.push(i)}return t}_createShadowPasses(t){for(let e=0;e<this.directionalLights.length;e++){let i=new tC(t);this.shadowPasses[e]=i}}_applyDefaultLights(){let{ambientLight:t,pointLights:e,directionalLights:i}=this;t||0!==e.length||0!==i.length||(this.ambientLight=new ty(tL),this.directionalLights.push(new tT(tR[0]),new tT(tR[1])))}},tk=new class{constructor(t={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(t)}setOptions(t){Object.assign(this.opts,t)}allocate(t,e,{size:i=1,type:r,padding:s=0,copy:o=!1,initialize:n=!1,maxCount:a}){let l=r||t&&t.constructor||Float32Array,h=e*i+s;if(ArrayBuffer.isView(t)){if(h<=t.length)return t;if(h*t.BYTES_PER_ELEMENT<=t.buffer.byteLength)return new l(t.buffer,0,h)}let c=1/0;a&&(c=a*i+s);let p=this._allocate(l,h,n,c);return t&&o?p.set(t):n||p.fill(0,0,4),this._release(t),p}release(t){this._release(t)}_allocate(t,e,i,r){let s=Math.max(Math.ceil(e*this.opts.overAlloc),1);s>r&&(s=r);let o=this._pool,n=t.BYTES_PER_ELEMENT*s,a=o.findIndex(t=>t.byteLength>=n);if(a>=0){let e=new t(o.splice(a,1)[0],0,s);return i&&e.fill(0),e}return new t(s)}_release(t){if(!ArrayBuffer.isView(t))return;let e=this._pool,{buffer:i}=t,{byteLength:r}=i,s=e.findIndex(t=>t.byteLength>=r);s<0?e.push(i):(s>0||e.length<this.opts.poolSize)&&e.splice(s,0,i),e.length>this.opts.poolSize&&e.shift()}},tz=i(5595);function tV(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function tU(t,e){let i=t%e;return i<0?e+i:i}var tD=new tz.Vector3;function tF(t,e,i,r){tD.set(t,e,i);let s=tD.len();return{distance:r/s,normal:new tz.Vector3(-t/s,-e/s,-i/s)}}function tN(t){return t-Math.fround(t)}function tB(t,e){let{size:i=1,startIndex:s=0}=e,o=void 0!==e.endIndex?e.endIndex:t.length,n=(o-s)/i;r=tk.allocate(r,n,{type:Float32Array,size:2*i});let a=s,l=0;for(;a<o;){for(let e=0;e<i;e++){let s=t[a++];r[l+e]=s,r[l+e+i]=tN(s)}l+=2*i}return r.subarray(0,n*i*2)}function t$(t){let e=null,i=!1;for(let r of t)r&&(e?(i||(e=[[e[0][0],e[0][1]],[e[1][0],e[1][1]]],i=!0),e[0][0]=Math.min(e[0][0],r[0][0]),e[0][1]=Math.min(e[0][1],r[0][1]),e[1][0]=Math.max(e[1][0],r[1][0]),e[1][1]=Math.max(e[1][1],r[1][1])):e=r);return e}var tG=i(5595),tW=i(261),tZ=Math.PI/180,tY=tV(),tq=[0,0,0],tH={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]},tX=class{constructor(t={}){this._frustumPlanes={},this.id=t.id||this.constructor.displayName||"viewport",this.x=t.x||0,this.y=t.y||0,this.width=t.width||1,this.height=t.height||1,this.zoom=t.zoom||0,this.padding=t.padding,this.distanceScales=t.distanceScales||tH,this.focalDistance=t.focalDistance||1,this.position=t.position||tq,this.modelMatrix=t.modelMatrix||null;let{longitude:e,latitude:i}=t;this.isGeospatial=Number.isFinite(i)&&Number.isFinite(e),this._initProps(t),this._initMatrices(t),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?j.WEB_MERCATOR:j.WEB_MERCATOR_AUTO_OFFSET:j.IDENTITY}equals(t){return t instanceof tX&&(this===t||t.width===this.width&&t.height===this.height&&t.scale===this.scale&&(0,tG.equals)(t.projectionMatrix,this.projectionMatrix)&&(0,tG.equals)(t.viewMatrix,this.viewMatrix))}project(t,{topLeft:e=!0}={}){let i=this.projectPosition(t),r=(0,tW.worldToPixels)(i,this.pixelProjectionMatrix),[s,o]=r,n=e?o:this.height-o;return 2===t.length?[s,n]:[s,n,r[2]]}unproject(t,{topLeft:e=!0,targetZ:i}={}){let[r,s,o]=t,n=e?s:this.height-s,a=i&&i*this.distanceScales.unitsPerMeter[2],l=(0,tW.pixelsToWorld)([r,n,o],this.pixelUnprojectionMatrix,a),[h,c,p]=this.unprojectPosition(l);return Number.isFinite(o)?[h,c,p]:Number.isFinite(i)?[h,c,i]:[h,c]}projectPosition(t){let[e,i]=this.projectFlat(t);return[e,i,(t[2]||0)*this.distanceScales.unitsPerMeter[2]]}unprojectPosition(t){let[e,i]=this.unprojectFlat(t);return[e,i,(t[2]||0)*this.distanceScales.metersPerUnit[2]]}projectFlat(t){if(this.isGeospatial){let e=(0,tW.lngLatToWorld)(t);return e[1]=(0,tG.clamp)(e[1],-318,830),e}return t}unprojectFlat(t){return this.isGeospatial?(0,tW.worldToLngLat)(t):t}getBounds(t={}){let e={targetZ:t.z||0},i=this.unproject([0,0],e),r=this.unproject([this.width,0],e),s=this.unproject([0,this.height],e),o=this.unproject([this.width,this.height],e);return[Math.min(i[0],r[0],s[0],o[0]),Math.min(i[1],r[1],s[1],o[1]),Math.max(i[0],r[0],s[0],o[0]),Math.max(i[1],r[1],s[1],o[1])]}getDistanceScales(t){return t&&this.isGeospatial?(0,tW.getDistanceScales)({longitude:t[0],latitude:t[1],highPrecision:!0}):this.distanceScales}containsPixel({x:t,y:e,width:i=1,height:r=1}){return t<this.x+this.width&&this.x<t+i&&e<this.y+this.height&&this.y<e+r}getFrustumPlanes(){var t;return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,{left:tF((t=this.viewProjectionMatrix)[3]+t[0],t[7]+t[4],t[11]+t[8],t[15]+t[12]),right:tF(t[3]-t[0],t[7]-t[4],t[11]-t[8],t[15]-t[12]),bottom:tF(t[3]+t[1],t[7]+t[5],t[11]+t[9],t[15]+t[13]),top:tF(t[3]-t[1],t[7]-t[5],t[11]-t[9],t[15]-t[13]),near:tF(t[3]+t[2],t[7]+t[6],t[11]+t[10],t[15]+t[14]),far:tF(t[3]-t[2],t[7]-t[6],t[11]-t[10],t[15]-t[14])}),this._frustumPlanes)}panByPosition(t,e){return null}_initProps(t){let e=t.longitude,i=t.latitude;this.isGeospatial&&(Number.isFinite(t.zoom)||(this.zoom=(0,tW.getMeterZoom)({latitude:i})+Math.log2(this.focalDistance)),this.distanceScales=t.distanceScales||(0,tW.getDistanceScales)({latitude:i,longitude:e}));let r=Math.pow(2,this.zoom);this.scale=r;let{position:s,modelMatrix:o}=t,n=tq;if(s&&(n=o?new tG.Matrix4(o).transformAsVector(s,[]):s),this.isGeospatial){let t=this.projectPosition([e,i,0]);this.center=new tG.Vector3(n).scale(this.distanceScales.unitsPerMeter).add(t)}else this.center=this.projectPosition(n)}_initMatrices(t){var e;let{viewMatrix:i=tY,projectionMatrix:r=null,orthographic:s=!1,fovyRadians:o,fovy:n=75,near:a=.1,far:l=1e3,padding:h=null,focalDistance:c=1}=t;this.viewMatrixUncentered=i,this.viewMatrix=new tG.Matrix4().multiplyRight(i).translate(new tG.Vector3(this.center).negate()),this.projectionMatrix=r||function({width:t,height:e,orthographic:i,fovyRadians:r,focalDistance:s,padding:o,near:n,far:a}){let l=t/e,h=i?new tG.Matrix4().orthographic({fovy:r,aspect:l,focalDistance:s,near:n,far:a}):new tG.Matrix4().perspective({fovy:r,aspect:l,near:n,far:a});if(o){let{left:i=0,right:r=0,top:s=0,bottom:n=0}=o,a=(0,tG.clamp)((i+t-r)/2,0,t)-t/2,l=(0,tG.clamp)((s+e-n)/2,0,e)-e/2;h[8]-=2*a/t,h[9]+=2*l/e}return h}({width:this.width,height:this.height,orthographic:s,fovyRadians:o||n*tZ,focalDistance:c,padding:h,near:a,far:l});let d=tV();tG.mat4.multiply(d,d,this.projectionMatrix),tG.mat4.multiply(d,d,this.viewMatrix),this.viewProjectionMatrix=d,this.viewMatrixInverse=tG.mat4.invert([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=[(e=this.viewMatrixInverse)[12],e[13],e[14]];let u=tV(),f=tV();tG.mat4.scale(u,u,[this.width/2,-this.height/2,1]),tG.mat4.translate(u,u,[1,-1,0]),tG.mat4.multiply(f,u,this.viewProjectionMatrix),this.pixelProjectionMatrix=f,this.pixelUnprojectionMatrix=tG.mat4.invert(tV(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||p.warn("Pixel project matrix not invertible")()}};tX.displayName="Viewport";var tK=tX,tJ=i(261),tQ=i(5595),t0=class extends tK{constructor(t={}){let e,{latitude:i=0,longitude:r=0,zoom:s=0,pitch:o=0,bearing:n=0,nearZMultiplier:a=.1,farZMultiplier:l=1.01,nearZ:h,farZ:c,orthographic:p=!1,projectionMatrix:d,repeat:u=!1,worldOffset:f=0,position:g,padding:m,legacyMeterSizes:_=!1}=t,{width:v,height:w,altitude:y=1.5}=t,b=Math.pow(2,s);v=v||1,w=w||1;let P=null;if(d)y=d[5]/2,e=(0,tJ.altitudeToFovy)(y);else{let r;if(t.fovy?(e=t.fovy,y=(0,tJ.fovyToAltitude)(e)):e=(0,tJ.altitudeToFovy)(y),m){let{top:t=0,bottom:e=0}=m;r=[0,(0,tQ.clamp)((t+w-e)/2,0,w)-w/2]}P=(0,tJ.getProjectionParameters)({width:v,height:w,scale:b,center:g&&[0,0,g[2]*(0,tJ.unitsPerMeter)(i)],offset:r,pitch:o,fovy:e,nearZMultiplier:a,farZMultiplier:l}),Number.isFinite(h)&&(P.near=h),Number.isFinite(c)&&(P.far=c)}let S=(0,tJ.getViewMatrix)({height:w,pitch:o,bearing:n,scale:b,altitude:y});f&&(S=new tQ.Matrix4().translate([512*f,0,0]).multiplyLeft(S)),super({...t,width:v,height:w,viewMatrix:S,longitude:r,latitude:i,zoom:s,...P,fovy:e,focalDistance:y}),this.latitude=i,this.longitude=r,this.zoom=s,this.pitch=o,this.bearing=n,this.altitude=y,this.fovy=e,this.orthographic=p,this._subViewports=u?[]:null,this._pseudoMeters=_,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){let t=this.getBounds(),e=Math.floor((t[0]+180)/360),i=Math.ceil((t[2]-180)/360);for(let t=e;t<=i;t++){let e=t?new t0({...this,worldOffset:t}):this;this._subViewports.push(e)}}return this._subViewports}projectPosition(t){if(this._pseudoMeters)return super.projectPosition(t);let[e,i]=this.projectFlat(t);return[e,i,(t[2]||0)*(0,tJ.unitsPerMeter)(t[1])]}unprojectPosition(t){if(this._pseudoMeters)return super.unprojectPosition(t);let[e,i]=this.unprojectFlat(t),r=(t[2]||0)/(0,tJ.unitsPerMeter)(i);return[e,i,r]}addMetersToLngLat(t,e){return(0,tJ.addMetersToLngLat)(t,e)}panByPosition(t,e){let i=(0,tJ.pixelsToWorld)(e,this.pixelUnprojectionMatrix),r=this.projectFlat(t),s=tQ.vec2.add([],r,tQ.vec2.negate([],i)),o=tQ.vec2.add([],this.center,s),[n,a]=this.unprojectFlat(o);return{longitude:n,latitude:a}}getBounds(t={}){let e=(0,tJ.getBounds)(this,t.z||0);return[Math.min(e[0][0],e[1][0],e[2][0],e[3][0]),Math.min(e[0][1],e[1][1],e[2][1],e[3][1]),Math.max(e[0][0],e[1][0],e[2][0],e[3][0]),Math.max(e[0][1],e[1][1],e[2][1],e[3][1])]}fitBounds(t,e={}){let{width:i,height:r}=this,{longitude:s,latitude:o,zoom:n}=(0,tJ.fitBounds)({width:i,height:r,bounds:t,...e});return new t0({width:i,height:r,longitude:s,latitude:o,zoom:n})}};t0.displayName="WebMercatorViewport";var t1=t0,t2=i(5595),t3=i(261),t4=[0,0,0];function t5(t,e,i=!1){let r=e.projectPosition(t);if(i&&e instanceof t1){let[i,s,o=0]=t,n=e.getDistanceScales([i,s]);r[2]=o*n.unitsPerMeter[2]}return r}function t6(t,{viewport:e,modelMatrix:i,coordinateSystem:r,coordinateOrigin:s,offsetMode:o}){let[n,a,l=0]=t;switch(i&&([n,a,l]=t2.vec4.transformMat4([],[n,a,l,1],i)),r){case E.LNGLAT:return t5([n,a,l],e,o);case E.LNGLAT_OFFSETS:return t5([n+s[0],a+s[1],l+(s[2]||0)],e,o);case E.METER_OFFSETS:return t5((0,t3.addMetersToLngLat)(s,[n,a,l]),e,o);case E.CARTESIAN:default:return e.isGeospatial?[n+s[0],a+s[1],l+s[2]]:e.projectPosition([n,a,l])}}function t8(t,e){let{viewport:i,coordinateSystem:r,coordinateOrigin:s,modelMatrix:o,fromCoordinateSystem:n,fromCoordinateOrigin:a}=function(t){let{viewport:e,modelMatrix:i,coordinateOrigin:r}=t,{coordinateSystem:s,fromCoordinateSystem:o,fromCoordinateOrigin:n}=t;return s===E.DEFAULT&&(s=e.isGeospatial?E.LNGLAT:E.CARTESIAN),void 0===o&&(o=s),void 0===n&&(n=r),{viewport:e,coordinateSystem:s,coordinateOrigin:r,modelMatrix:i,fromCoordinateSystem:o,fromCoordinateOrigin:n}}(e),{autoOffset:l=!0}=e,{geospatialOrigin:h=t4,shaderCoordinateOrigin:c=t4,offsetMode:p=!1}=l?F(i,r,s):{},d=t6(t,{viewport:i,modelMatrix:o,coordinateSystem:n,coordinateOrigin:a,offsetMode:p});if(p){let t=i.projectPosition(h||c);t2.vec3.sub(d,d,t)}return d}var t9=[255,255,255],t7=[1,0,0],et=[0,0,1],ee=0,ei=class{constructor(t={}){this.type="point";let{color:e=t9}=t,{intensity:i=1}=t,{position:r=et}=t;this.id=t.id||`point-${ee++}`,this.color=e,this.intensity=i,this.type="point",this.position=r,this.attenuation=function(t){return t.attenuation?t.attenuation:t7}(t),this.projectedLight={...this}}getProjectedLight({layer:t}){let{projectedLight:e}=this,i=t.context.viewport,{coordinateSystem:r,coordinateOrigin:s}=t.props,o=t8(this.position,{viewport:i,coordinateSystem:r,coordinateOrigin:s,fromCoordinateSystem:i.isGeospatial?E.LNGLAT:E.CARTESIAN,fromCoordinateOrigin:[0,0,0]});return e.color=this.color,e.intensity=this.intensity,e.position=o,e}},er=class extends ei{getProjectedLight({layer:t}){let{projectedLight:e}=this,i=t.context.viewport,{coordinateSystem:r,coordinateOrigin:s,modelMatrix:o}=t.props,{cameraPosition:n}=N({viewport:i,modelMatrix:o,coordinateSystem:r,coordinateOrigin:s});return e.color=this.color,e.intensity=this.intensity,e.position=n,e}},es=i(2019),eo=class extends tT{constructor(t){super(t),this.timestamp=t.timestamp}getProjectedLight({layer:t}){let{viewport:e}=t.context;if(e.resolution&&e.resolution>0){let[t,e,i]=(0,es.getSunDirection)(this.timestamp,0,0);this.direction=[t,-i,e]}else{let{latitude:t,longitude:i}=e;this.direction=(0,es.getSunDirection)(this.timestamp,t,i)}return this}},en=i(2763),ea=i(6463),el={name:"screen",fs:`uniform screenUniforms {
  vec2 texSize;
} screen;
`,uniformTypes:{texSize:"vec2<f32>"}},eh=class extends tE{constructor(t,e){super(t,e);let{module:i,fs:r,id:s}=e;this.model=new ea.ClipSpace(t,{id:s,fs:r,modules:[i,el],parameters:{depthWriteEnabled:!1,depthCompare:"always"}})}render(t){this._renderPass(this.device,t)}delete(){this.model.destroy(),this.model=null}_renderPass(t,e){let{clearCanvas:i,inputBuffer:r,outputBuffer:s}=e,o=[r.width,r.height],n={texSrc:r.colorAttachments[0],texSize:o};this.model.shaderInputs.setProps({screen:n,...e.moduleProps});let a=this.device.beginRenderPass({framebuffer:s,parameters:{viewport:[0,0,...o]},clearColor:!!i&&[0,0,0,0],clearDepth:1,clearStencil:!1});this.model.draw(a),a.end()}},ec=class{constructor(t,e){this.id=`${t.name}-pass`,this.props=e,(0,en.initializeShaderModule)(t),this.module=t}setup({device:t}){var e,i,r;this.passes=(e=t,i=this.module,r=this.id,i.passes.map((t,s)=>{let o=function(t,e){if(e.filter){let i;return i="string"==typeof e.filter?e.filter:`${t.name}_filterColor_ext`,`${ep}
void main() {
  fragColor = texture(texSrc, coordinate);
  fragColor = ${i}(fragColor, screen.texSize, coordinate);
}
`}if(e.sampler){let i;return i="string"==typeof e.sampler?e.sampler:`${t.name}_sampleColor`,`${ep}
void main() {
  fragColor = ${i}(texSrc, screen.texSize, coordinate);
}
`}return""}(i,t);return new eh(e,{id:`${r}-${s}`,module:i,fs:o})}))}setProps(t){this.props=t}preRender(){}postRender(t){let e=this.passes,{target:i}=t,r=t.inputBuffer,s=t.swapBuffer;for(let o=0;o<e.length;o++){let n=o===e.length-1,a=void 0!==i&&n;a&&(s=i);let l=!a||!!t.clearCanvas,h={},c=this.module.passes[o].uniforms;h[this.module.name]={...this.props,...c},e[o].render({clearCanvas:l,inputBuffer:r,outputBuffer:s,moduleProps:h});let p=s;s=r,r=p}return r}cleanup(){if(this.passes){for(let t of this.passes)t.delete();this.passes=void 0}}},ep=`#version 300 es
uniform sampler2D texSrc;

in vec2 position;
in vec2 coordinate;
in vec2 uv;

out vec4 fragColor;
`,ed={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant-alpha",blendAlphaDstFactor:"zero"},eu=class extends tj{constructor(){super(...arguments),this._colorEncoderState=null}render(t){return"pickingFBO"in t?this._drawPickingBuffer(t):super.render(t)}_drawPickingBuffer({layers:t,layerFilter:e,views:i,viewports:r,onViewportActive:s,pickingFBO:o,deviceRect:{x:n,y:a,width:l,height:h},cullRect:c,effects:p,pass:d="picking",pickZ:u,shaderModuleProps:f}){this.pickZ=u;let g=this._resetColorEncoder(u),m=super.render({target:o,layers:t,layerFilter:e,views:i,viewports:r,onViewportActive:s,cullRect:c,effects:null==p?void 0:p.filter(t=>t.useInPicking),pass:d,isPicking:!0,shaderModuleProps:f,clearColor:[0,0,0,0],colorMask:15,scissorRect:[n,a,l,h]});return this._colorEncoderState=null,{decodePickingColor:g&&ef.bind(null,g),stats:m}}shouldDrawLayer(t){let{pickable:e,operation:i}=t.props;return e&&i.includes("draw")||i.includes("terrain")||i.includes("mask")}getShaderModuleProps(t,e,i){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(t,e,i){let r={...t.props.parameters},{pickable:s,operation:o}=t.props;return!this._colorEncoderState||o.includes("terrain")?r.blend=!1:s&&o.includes("draw")&&(Object.assign(r,ed),r.blend=!0,r.blendColor=function(t,e,i){let r,{byLayer:s,byAlpha:o}=t,n=s.get(e);return n?(n.viewports.push(i),r=n.a):(r=s.size+1)<=255?(n={a:r,layer:e,viewports:[i]},s.set(e,n),o[r]=n):(p.warn("Too many pickable layers, only picking the first 255")(),r=0),[0,0,0,r/255]}(this._colorEncoderState,t,i)),r}_resetColorEncoder(t){return this._colorEncoderState=t?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}};function ef(t,e){let i=t.byAlpha[e[3]];return i&&{pickedLayer:i.layer,pickedViewports:i.viewports,pickedObjectIndex:i.layer.decodePickingColor(e)}}var eg=i(6463),em={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},e_=Symbol.for("component"),ev=Symbol.for("propTypes"),ew=Symbol.for("deprecatedProps"),ey=Symbol.for("asyncPropDefaults"),eb=Symbol.for("asyncPropOriginal"),eP=Symbol.for("asyncPropResolved");function eS(t,e=()=>!0){return Array.isArray(t)?function t(e,i,r){let s=-1;for(;++s<e.length;){let o=e[s];Array.isArray(o)?t(o,i,r):i(o)&&r.push(o)}return r}(t,e,[]):e(t)?[t]:[]}function eM({target:t,source:e,start:i=0,count:r=1}){let s=e.length,o=r*s,n=0;for(let r=i;n<s;n++)t[r++]=e[n];for(;n<o;)n<o-n?(t.copyWithin(i+n,i,i+n),n*=2):(t.copyWithin(i+n,i,i+o-n),n=o);return t}var eT=i(5683),ex=i(2489),eE=class{constructor(t,e,i){this._loadCount=0,this._subscribers=new Set,this.id=t,this.context=i,this.setData(e)}subscribe(t){this._subscribers.add(t)}unsubscribe(t){this._subscribers.delete(t)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(t,e){if(t===this._data&&!e)return;this._data=t;let i=++this._loadCount,r=t;for(let e of("string"==typeof t&&(r=(0,ex.load)(t)),r instanceof Promise?(this.isLoaded=!1,this._loader=r.then(t=>{this._loadCount===i&&(this.isLoaded=!0,this._error=void 0,this._content=t)}).catch(t=>{this._loadCount===i&&(this.isLoaded=!0,this._error=t||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=t),this._subscribers))e.onChange(this.getData())}},ej=class{constructor(t){var e;this.protocol=t.protocol||"resource://",this._context={device:t.device,gl:null==(e=t.device)?void 0:e.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(t){return!!t.startsWith(this.protocol)||t in this._resources}add({resourceId:t,data:e,forceUpdate:i=!1,persistent:r=!0}){let s=this._resources[t];s?s.setData(e,i):(s=new eE(t,e,this._context),this._resources[t]=s),s.persistent=r}remove(t){let e=this._resources[t];e&&(e.delete(),delete this._resources[t])}unsubscribe({consumerId:t}){let e=this._consumers[t];if(e){for(let t in e){let i=e[t],r=this._resources[i.resourceId];r&&r.unsubscribe(i)}delete this._consumers[t],this.prune()}}subscribe({resourceId:t,onChange:e,consumerId:i,requestId:r="default"}){let{_resources:s,protocol:o}=this;t.startsWith(o)&&(s[t=t.replace(o,"")]||this.add({resourceId:t,data:null,persistent:!1}));let n=s[t];if(this._track(i,r,n,e),n)return n.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(let t in this._resources)this._resources[t].delete()}_track(t,e,i,r){let s=this._consumers,o=s[t]=s[t]||{},n=o[e],a=n&&n.resourceId&&this._resources[n.resourceId];a&&(a.unsubscribe(n),this.prune()),i&&(n?(n.onChange=r,n.resourceId=i.id):n={onChange:r,resourceId:i.id},o[e]=n,i.subscribe(n))}_prune(){for(let t of(this._pruneRequest=null,Object.keys(this._resources))){let e=this._resources[t];e.persistent||e.inUse()||(e.delete(),delete this._resources[t])}}},eA=class{constructor(t,e){var i;this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=t=>{g("layerManager.activateViewport",this,t),t&&(this.context.viewport=t)};let{deck:r,stats:s,viewport:o,timeline:n}=e||{};this.layers=[],this.resourceManager=new ej({device:t,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:t,gl:null==t?void 0:t.gl,deck:r,shaderAssembler:t_((null==(i=null==t?void 0:t.info)?void 0:i.shadingLanguage)||"glsl"),defaultShaderModules:[b],renderPass:void 0,stats:s||new eT.Stats({id:"deck.gl"}),viewport:o||new tK({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:n||new eg.Timeline,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){for(let t of(this.resourceManager.finalize(),this.layers))this._finalizeLayer(t)}needsRedraw(t={clearRedrawFlags:!1}){let e=this._needsRedraw;for(let i of(t.clearRedrawFlags&&(this._needsRedraw=!1),this.layers)){let r=i.getNeedsRedraw(t);e=e||r}return e}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(t){this._needsRedraw=this._needsRedraw||t}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t}getLayers({layerIds:t}={}){return t?this.layers.filter(e=>t.find(t=>0===e.id.indexOf(t))):this.layers}setProps(t){"debug"in t&&(this._debug=t.debug),"userData"in t&&(this.context.userData=t.userData),"layers"in t&&(this._nextLayers=t.layers),"onError"in t&&(this.context.onError=t.onError)}setLayers(t,e){g("layerManager.setLayers",this,e,t),this._lastRenderedLayers=t;let i=eS(t,Boolean);for(let t of i)t.context=this.context;this._updateLayers(this.layers,i)}updateLayers(){let t=this.needsUpdate();t&&(this.setNeedsRedraw(`updating layers: ${t}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,t)),this._nextLayers=null}addDefaultShaderModule(t){let{defaultShaderModules:e}=this.context;e.find(e=>e.name===t.name)||(e.push(t),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(t){let{defaultShaderModules:e}=this.context,i=e.findIndex(e=>e.name===t.name);i>=0&&(e.splice(i,1),this._defaultShaderModulesChanged=!0)}_handleError(t,e,i){i.raiseError(e,`${t} of ${i}`)}_updateLayers(t,e){let i={};for(let e of t)i[e.id]?p.warn(`Multiple old layers with same id ${e.id}`)():i[e.id]=e;if(this._defaultShaderModulesChanged){for(let e of t)e.setNeedsUpdate(),e.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}let r=[];this._updateSublayersRecursively(e,i,r),this._finalizeOldLayers(i);let s=!1;for(let t of r)if(t.hasUniformTransition()){s=`Uniform transition in ${t}`;break}this._needsUpdate=s,this.layers=r}_updateSublayersRecursively(t,e,i){for(let r of t){r.context=this.context;let t=e[r.id];null===t&&p.warn(`Multiple new layers with same id ${r.id}`)(),e[r.id]=null;let s=null;try{this._debug&&t!==r&&r.validateProps(),t?(this._transferLayerState(t,r),this._updateLayer(r)):this._initializeLayer(r),i.push(r),s=r.isComposite?r.getSubLayers():null}catch(t){this._handleError("matching",t,r)}s&&this._updateSublayersRecursively(s,e,i)}}_finalizeOldLayers(t){for(let e in t){let i=t[e];i&&this._finalizeLayer(i)}}_initializeLayer(t){try{t._initialize(),t.lifecycle=em.INITIALIZED}catch(e){this._handleError("initialization",e,t)}}_transferLayerState(t,e){e._transferState(t),e.lifecycle=em.MATCHED,e!==t&&(t.lifecycle=em.AWAITING_GC)}_updateLayer(t){try{t._update()}catch(e){this._handleError("update",e,t)}}_finalizeLayer(t){this._needsRedraw=this._needsRedraw||`finalized ${t}`,t.lifecycle=em.AWAITING_FINALIZATION;try{t._finalize(),t.lifecycle=em.FINALIZED}catch(e){this._handleError("finalization",e,t)}}};function eC(t,e,i){if(t===e)return!0;if(!i||!t||!e)return!1;if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(!eC(t[r],e[r],i-1))return!1;return!0}if(Array.isArray(e))return!1;if("object"==typeof t&&"object"==typeof e){let r=Object.keys(t),s=Object.keys(e);if(r.length!==s.length)return!1;for(let s of r)if(!e.hasOwnProperty(s)||!eC(t[s],e[s],i-1))return!1;return!0}return!1}var eL=class{constructor(t){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=t.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=t.eventManager,this._eventCallbacks={onViewStateChange:t.onViewStateChange,onInteractionStateChange:t.onInteractionStateChange},Object.seal(this),this.setProps(t)}finalize(){for(let t in this.controllers){let e=this.controllers[t];e&&e.finalize()}this.controllers={}}needsRedraw(t={clearRedrawFlags:!1}){let e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t,this._needsRedraw=this._needsRedraw||t}updateViewStates(){for(let t in this.controllers){let e=this.controllers[t];e&&e.updateTransition()}}getViewports(t){return t?this._viewports.filter(e=>e.containsPixel(t)):this._viewports}getViews(){let t={};return this.views.forEach(e=>{t[e.id]=e}),t}getView(t){return this.views.find(e=>e.id===t)}getViewState(t){let e="string"==typeof t?this.getView(t):t,i=e&&this.viewState[e.getViewStateId()]||this.viewState;return e?e.filterViewState(i):i}getViewport(t){return this._viewportMap[t]}unproject(t,e){let i=this.getViewports(),r={x:t[0],y:t[1]};for(let s=i.length-1;s>=0;--s){let o=i[s];if(o.containsPixel(r)){let i=t.slice();return i[0]-=o.x,i[1]-=o.y,o.unproject(i,e)}}return null}setProps(t){t.views&&this._setViews(t.views),t.viewState&&this._setViewState(t.viewState),("width"in t||"height"in t)&&this._setSize(t.width,t.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(t,e){(t!==this.width||e!==this.height)&&(this.width=t,this.height=e,this.setNeedsUpdate("Size changed"))}_setViews(t){t=eS(t,Boolean),this._diffViews(t,this.views)&&this.setNeedsUpdate("views changed"),this.views=t}_setViewState(t){t?(eC(t,this.viewState,3)||this.setNeedsUpdate("viewState changed"),this.viewState=t):p.warn("missing `viewState` or `initialViewState`")()}_createController(t,e){return new e.type({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:e=>{var i;return null==(i=this.getView(t.id))?void 0:i.makeViewport({viewState:e,width:this.width,height:this.height})}})}_updateController(t,e,i,r){let s=t.controller;if(s&&i){let o={...e,...s,id:t.id,x:i.x,y:i.y,width:i.width,height:i.height};return r&&r.constructor===s.type||(r=this._createController(t,o)),r&&r.setProps(o),r}return null}_rebuildViewports(){let{views:t}=this,e=this.controllers;this._viewports=[],this.controllers={};let i=!1;for(let r=t.length;r--;){let s=t[r],o=this.getViewState(s),n=s.makeViewport({viewState:o,width:this.width,height:this.height}),a=e[s.id],l=!!s.controller;l&&!a&&(i=!0),(i||!l)&&a&&(a.finalize(),a=null),this.controllers[s.id]=this._updateController(s,o,n,a),n&&this._viewports.unshift(n)}for(let t in e){let i=e[t];i&&!this.controllers[t]&&i.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(t=>{t.id&&(this._viewportMap[t.id]=this._viewportMap[t.id]||t)})}_diffViews(t,e){return t.length!==e.length||t.some((i,r)=>!t[r].equals(e[r]))}},eR=/([0-9]+\.?[0-9]*)(%|px)/;function eO(t){switch(typeof t){case"number":return{position:t,relative:!1};case"string":let e=eR.exec(t);if(e&&e.length>=3){let t="%"===e[2],i=parseFloat(e[1]);return{position:t?i/100:i,relative:t}}default:throw Error(`Could not parse position string ${t}`)}}function eI(t,e){return t.relative?Math.round(t.position*e):t.position}var ek=class{constructor(t){let{id:e,x:i=0,y:r=0,width:s="100%",height:o="100%",padding:n=null}=t;this.id=e||this.constructor.displayName||"view",this.props={...t,id:this.id},this._x=eO(i),this._y=eO(r),this._width=eO(s),this._height=eO(o),this._padding=n&&{left:eO(n.left||0),right:eO(n.right||0),top:eO(n.top||0),bottom:eO(n.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(t){return this===t||this.constructor===t.constructor&&eC(this.props,t.props,2)}makeViewport({width:t,height:e,viewState:i}){i=this.filterViewState(i);let r=this.getDimensions({width:t,height:e});return r.height&&r.width?new(this.getViewportType(i))({...i,...this.props,...r}):null}getViewStateId(){let{viewState:t}=this.props;return"string"==typeof t?t:(null==t?void 0:t.id)||this.id}filterViewState(t){if(this.props.viewState&&"object"==typeof this.props.viewState){if(!this.props.viewState.id)return this.props.viewState;let e={...t};for(let t in this.props.viewState)"id"!==t&&(e[t]=this.props.viewState[t]);return e}return t}getDimensions({width:t,height:e}){let i={x:eI(this._x,t),y:eI(this._y,e),width:eI(this._width,t),height:eI(this._height,e)};return this._padding&&(i.padding={left:eI(this._padding.left,t),top:eI(this._padding.top,e),right:eI(this._padding.right,t),bottom:eI(this._padding.bottom,e)}),i}get controller(){let t=this.props.controller;return t?!0===t?{type:this.ControllerType}:"function"==typeof t?{type:t}:{type:this.ControllerType,...t}:null}},ez=i(5595),eV=class{constructor(t){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=t}get inProgress(){return this._inProgress}start(t){var e,i;this.cancel(),this.settings=t,this._inProgress=!0,null==(i=(e=this.settings).onStart)||i.call(e,this)}end(){var t,e;this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,null==(e=(t=this.settings).onEnd)||e.call(t,this))}cancel(){var t,e;this._inProgress&&(null==(e=(t=this.settings).onInterrupt)||e.call(t,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){var t,e;if(!this._inProgress)return!1;if(null===this._handle){let{_timeline:t,settings:e}=this;this._handle=t.addChannel({delay:t.getTime(),duration:e.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),null==(e=(t=this.settings).onUpdate)||e.call(t,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}},eU=()=>{},eD={BREAK:1,SNAP_TO_END:2,IGNORE:3},eF=t=>t,eN=eD.BREAK,eB=class{constructor(t){this._onTransitionUpdate=t=>{let{time:e,settings:{interpolator:i,startProps:r,endProps:s,duration:o,easing:n}}=t,a=n(e/o),l=i.interpolateProps(r,s,a);this.propsInTransition=this.getControllerState({...this.props,...l}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=t.getControllerState,this.propsInTransition=null,this.transition=new eV(t.timeline),this.onViewStateChange=t.onViewStateChange||eU,this.onStateChange=t.onStateChange||eU}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(t){let e=!1,i=this.props;if(this.props=t,!i||this._shouldIgnoreViewportChange(i,t))return!1;if(this._isTransitionEnabled(t)){let r=i;if(this.transition.inProgress){let{interruption:t,endProps:e}=this.transition.settings;r={...i,...t===eD.SNAP_TO_END?e:this.propsInTransition||i}}this._triggerTransition(r,t),e=!0}else this.transition.cancel();return e}updateTransition(){this.transition.update()}_isTransitionEnabled(t){let{transitionDuration:e,transitionInterpolator:i}=t;return(e>0||"auto"===e)&&!!i}_isUpdateDueToCurrentTransition(t){return!!this.transition.inProgress&&!!this.propsInTransition&&this.transition.settings.interpolator.arePropsEqual(t,this.propsInTransition)}_shouldIgnoreViewportChange(t,e){return this.transition.inProgress?this.transition.settings.interruption===eD.IGNORE||this._isUpdateDueToCurrentTransition(e):!this._isTransitionEnabled(e)||e.transitionInterpolator.arePropsEqual(t,e)}_triggerTransition(t,e){let i=this.getControllerState(t),r=this.getControllerState(e).shortestPathFrom(i),s=e.transitionInterpolator,o=s.getDuration?s.getDuration(t,e):e.transitionDuration;if(0===o)return;let n=s.initializeProps(t,r);this.propsInTransition={};let a={duration:o,easing:e.transitionEasing||eF,interpolator:s,interruption:e.transitionInterruption||eN,startProps:n.start,endProps:n.end,onStart:e.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(e.onTransitionInterrupt),onEnd:this._onTransitionEnd(e.onTransitionEnd)};this.transition.start(a),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(t){return e=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),null==t||t(e)}}},e$=i(5595);function eG(t,e){if(!t)throw Error(e||"deck.gl: assertion failed.")}var eW=class{constructor(t){let{compare:e,extract:i,required:r}=t;this._propsToCompare=e,this._propsToExtract=i||e,this._requiredProps=r}arePropsEqual(t,e){for(let i of this._propsToCompare)if(!(i in t)||!(i in e)||!(0,e$.equals)(t[i],e[i]))return!1;return!0}initializeProps(t,e){let i={},r={};for(let s of this._propsToExtract)(s in t||s in e)&&(i[s]=t[s],r[s]=e[s]);return this._checkRequiredProps(i),this._checkRequiredProps(r),{start:i,end:r}}getDuration(t,e){return e.transitionDuration}_checkRequiredProps(t){this._requiredProps&&this._requiredProps.forEach(e=>{let i=t[e];eG(Number.isFinite(i)||Array.isArray(i),`${e} is required for transition`)})}},eZ=i(5595),eY=["longitude","latitude","zoom","bearing","pitch"],eq=["longitude","latitude","zoom"],eH=class extends eW{constructor(t={}){let e=Array.isArray(t)?t:t.transitionProps,i=Array.isArray(t)?{}:t;i.transitionProps=Array.isArray(e)?{compare:e,required:e}:e||{compare:eY,required:eq},super(i.transitionProps),this.opts=i}initializeProps(t,e){let i=super.initializeProps(t,e),{makeViewport:r,around:s}=this.opts;if(r&&s){let o=r(t),n=r(e),a=o.unproject(s);i.start.around=s,Object.assign(i.end,{around:n.project(a),aroundPosition:a,width:e.width,height:e.height})}return i}interpolateProps(t,e,i){let r={};for(let s of this._propsToExtract)r[s]=(0,eZ.lerp)(t[s]||0,e[s]||0,i);if(e.aroundPosition&&this.opts.makeViewport){let s=this.opts.makeViewport({...e,...r});Object.assign(r,s.panByPosition(e.aroundPosition,(0,eZ.lerp)(t.around,e.around,i)))}return r}},eX={transitionDuration:0},eK=t=>1-(1-t)*(1-t),eJ={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],MULTI_PAN:["multipanstart","multipanmove","multipanend"],DOUBLE_CLICK:["dblclick"],KEYBOARD:["keydown"]},eQ={},e0=class{constructor(t){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new eB({...t,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=t.eventManager,this.onViewStateChange=t.onViewStateChange||(()=>{}),this.onStateChange=t.onStateChange||(()=>{}),this.makeViewport=t.makeViewport}set events(t){this.toggleEvents(this._customEvents,!1),this.toggleEvents(t,!0),this._customEvents=t,this.props&&this.setProps(this.props)}finalize(){var t;for(let e in this._events)this._events[e]&&(null==(t=this.eventManager)||t.off(e,this.handleEvent));this.transitionManager.finalize()}handleEvent(t){this._controllerState=void 0;let e=this._eventStartBlocked;switch(t.type){case"panstart":return!e&&this._onPanStart(t);case"panmove":return this._onPan(t);case"panend":return this._onPanEnd(t);case"pinchstart":return!e&&this._onPinchStart(t);case"pinchmove":return this._onPinch(t);case"pinchend":return this._onPinchEnd(t);case"multipanstart":return!e&&this._onMultiPanStart(t);case"multipanmove":return this._onMultiPan(t);case"multipanend":return this._onMultiPanEnd(t);case"dblclick":return this._onDoubleClick(t);case"wheel":return this._onWheel(t);case"keydown":return this._onKeyDown(t);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(t){let{x:e,y:i}=this.props,{offsetCenter:r}=t;return[r.x-e,r.y-i]}isPointInBounds(t,e){let{width:i,height:r}=this.props;if(e&&e.handled)return!1;let s=t[0]>=0&&t[0]<=i&&t[1]>=0&&t[1]<=r;return s&&e&&e.stopPropagation(),s}isFunctionKeyPressed(t){let{srcEvent:e}=t;return!!(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(t){let e=setTimeout(()=>{this._eventStartBlocked===e&&(this._eventStartBlocked=null)},t);this._eventStartBlocked=e}setProps(t){t.dragMode&&(this.dragMode=t.dragMode),this.props=t,"transitionInterpolator"in t||(t.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(t);let{inertia:e}=t;this.inertia=Number.isFinite(e)?e:300*(!0===e);let{scrollZoom:i=!0,dragPan:r=!0,dragRotate:s=!0,doubleClickZoom:o=!0,touchZoom:n=!0,touchRotate:a=!1,keyboard:l=!0}=t,h=!!this.onViewStateChange;this.toggleEvents(eJ.WHEEL,h&&i),this.toggleEvents(eJ.PAN,h),this.toggleEvents(eJ.PINCH,h&&(n||a)),this.toggleEvents(eJ.MULTI_PAN,h&&a),this.toggleEvents(eJ.DOUBLE_CLICK,h&&o),this.toggleEvents(eJ.KEYBOARD,h&&l),this.scrollZoom=i,this.dragPan=r,this.dragRotate=s,this.doubleClickZoom=o,this.touchZoom=n,this.touchRotate=a,this.keyboard=l}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(t,e){this.eventManager&&t.forEach(t=>{this._events[t]!==e&&(this._events[t]=e,e?this.eventManager.on(t,this.handleEvent):this.eventManager.off(t,this.handleEvent))})}updateViewport(t,e=null,i={}){let r={...t.getViewportProps(),...e},s=this.controllerState!==t;if(this.state=t.getState(),this._setInteractionState(i),s){let t=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:r,interactionState:this._interactionState,oldViewState:t,viewId:this.props.id})}}_onTransition(t){this.onViewStateChange({...t,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(t){Object.assign(this._interactionState,t),this.onStateChange(this._interactionState)}_onPanStart(t){let e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;let i=this.isFunctionKeyPressed(t)||t.rightButton||!1;(this.invertPan||"pan"===this.dragMode)&&(i=!i);let r=this.controllerState[i?"panStart":"rotateStart"]({pos:e});return this._panMove=i,this.updateViewport(r,eX,{isDragging:!0}),!0}_onPan(t){return!!this.isDragging()&&(this._panMove?this._onPanMove(t):this._onPanRotate(t))}_onPanEnd(t){return!!this.isDragging()&&(this._panMove?this._onPanMoveEnd(t):this._onPanRotateEnd(t))}_onPanMove(t){if(!this.dragPan)return!1;let e=this.getCenter(t),i=this.controllerState.pan({pos:e});return this.updateViewport(i,eX,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(t){let{inertia:e}=this;if(this.dragPan&&e&&t.velocity){let i=this.getCenter(t),r=[i[0]+t.velocityX*e/2,i[1]+t.velocityY*e/2],s=this.controllerState.pan({pos:r}).panEnd();this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:eK},{isDragging:!1,isPanning:!0})}else{let t=this.controllerState.panEnd();this.updateViewport(t,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(t){if(!this.dragRotate)return!1;let e=this.getCenter(t),i=this.controllerState.rotate({pos:e});return this.updateViewport(i,eX,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(t){let{inertia:e}=this;if(this.dragRotate&&e&&t.velocity){let i=this.getCenter(t),r=[i[0]+t.velocityX*e/2,i[1]+t.velocityY*e/2],s=this.controllerState.rotate({pos:r}).rotateEnd();this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:eK},{isDragging:!1,isRotating:!0})}else{let t=this.controllerState.rotateEnd();this.updateViewport(t,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(t){if(!this.scrollZoom)return!1;let e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;t.srcEvent.preventDefault();let{speed:i=.01,smooth:r=!1}=!0===this.scrollZoom?{}:this.scrollZoom,{delta:s}=t,o=2/(1+Math.exp(-Math.abs(s*i)));s<0&&0!==o&&(o=1/o);let n=this.controllerState.zoom({pos:e,scale:o});return this.updateViewport(n,{...this._getTransitionProps({around:e}),transitionDuration:r?250:1},{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(t){let e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;let i=this.controllerState.rotateStart({pos:e});return this.updateViewport(i,eX,{isDragging:!0}),!0}_onMultiPan(t){if(!this.touchRotate||!this.isDragging())return!1;let e=this.getCenter(t);e[0]-=t.deltaX;let i=this.controllerState.rotate({pos:e});return this.updateViewport(i,eX,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(t){if(!this.isDragging())return!1;let{inertia:e}=this;if(this.touchRotate&&e&&t.velocityY){let i=this.getCenter(t),r=[i[0],i[1]+=t.velocityY*e/2],s=this.controllerState.rotate({pos:r});this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:eK},{isDragging:!1,isRotating:!0}),this.blockEvents(e)}else{let t=this.controllerState.rotateEnd();this.updateViewport(t,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(t){let e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;let i=this.controllerState.zoomStart({pos:e}).rotateStart({pos:e});return eQ._startPinchRotation=t.rotation,eQ._lastPinchEvent=t,this.updateViewport(i,eX,{isDragging:!0}),!0}_onPinch(t){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let e=this.controllerState;if(this.touchZoom){let{scale:i}=t,r=this.getCenter(t);e=e.zoom({pos:r,scale:i})}if(this.touchRotate){let{rotation:i}=t;e=e.rotate({deltaAngleX:eQ._startPinchRotation-i})}return this.updateViewport(e,eX,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),eQ._lastPinchEvent=t,!0}_onPinchEnd(t){if(!this.isDragging())return!1;let{inertia:e}=this,{_lastPinchEvent:i}=eQ;if(this.touchZoom&&e&&i&&t.scale!==i.scale){let r=this.getCenter(t),s=this.controllerState.rotateEnd(),o=Math.log2(t.scale),n=(o-Math.log2(i.scale))/(t.deltaTime-i.deltaTime),a=Math.pow(2,o+n*e/2);s=s.zoom({pos:r,scale:a}).zoomEnd(),this.updateViewport(s,{...this._getTransitionProps({around:r}),transitionDuration:e,transitionEasing:eK},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(e)}else{let t=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(t,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return eQ._startPinchRotation=null,eQ._lastPinchEvent=null,!0}_onDoubleClick(t){if(!this.doubleClickZoom)return!1;let e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;let i=this.isFunctionKeyPressed(t),r=this.controllerState.zoom({pos:e,scale:i?.5:2});return this.updateViewport(r,this._getTransitionProps({around:e}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(t){let e;if(!this.keyboard)return!1;let i=this.isFunctionKeyPressed(t),{zoomSpeed:r,moveSpeed:s,rotateSpeedX:o,rotateSpeedY:n}=!0===this.keyboard?{}:this.keyboard,{controllerState:a}=this,l={};switch(t.srcEvent.code){case"Minus":e=i?a.zoomOut(r).zoomOut(r):a.zoomOut(r),l.isZooming=!0;break;case"Equal":e=i?a.zoomIn(r).zoomIn(r):a.zoomIn(r),l.isZooming=!0;break;case"ArrowLeft":i?(e=a.rotateLeft(o),l.isRotating=!0):(e=a.moveLeft(s),l.isPanning=!0);break;case"ArrowRight":i?(e=a.rotateRight(o),l.isRotating=!0):(e=a.moveRight(s),l.isPanning=!0);break;case"ArrowUp":i?(e=a.rotateUp(n),l.isRotating=!0):(e=a.moveUp(s),l.isPanning=!0);break;case"ArrowDown":i?(e=a.rotateDown(n),l.isRotating=!0):(e=a.moveDown(s),l.isPanning=!0);break;default:return!1}return this.updateViewport(e,this._getTransitionProps(),l),!0}_getTransitionProps(t){let{transition:e}=this;return e&&e.transitionInterpolator?t?{...e,transitionInterpolator:new eH({...t,...e.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:e:eX}},e1=class{constructor(t,e){this._viewportProps=this.applyConstraints(t),this._state=e}getViewportProps(){return this._viewportProps}getState(){return this._state}},e2=i(261),e3=class extends e1{constructor(t){let{width:e,height:i,latitude:r,longitude:s,zoom:o,bearing:n=0,pitch:a=0,altitude:l=1.5,position:h=[0,0,0],maxZoom:c=20,minZoom:p=0,maxPitch:d=60,minPitch:u=0,startPanLngLat:f,startZoomLngLat:g,startRotatePos:m,startBearing:_,startPitch:v,startZoom:w,normalize:y=!0}=t;eG(Number.isFinite(s)),eG(Number.isFinite(r)),eG(Number.isFinite(o)),super({width:e,height:i,latitude:r,longitude:s,zoom:o,bearing:n,pitch:a,altitude:l,maxZoom:c,minZoom:p,maxPitch:d,minPitch:u,normalize:y,position:h},{startPanLngLat:f,startZoomLngLat:g,startRotatePos:m,startBearing:_,startPitch:v,startZoom:w}),this.makeViewport=t.makeViewport}panStart({pos:t}){return this._getUpdatedState({startPanLngLat:this._unproject(t)})}pan({pos:t,startPos:e}){let i=this.getState().startPanLngLat||this._unproject(e);if(!i)return this;let r=this.makeViewport(this.getViewportProps()).panByPosition(i,t);return this._getUpdatedState(r)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:t}){return this._getUpdatedState({startRotatePos:t,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:t,deltaAngleX:e=0,deltaAngleY:i=0}){let r,{startRotatePos:s,startBearing:o,startPitch:n}=this.getState();return s&&void 0!==o&&void 0!==n?(r=t?this._getNewRotation(t,s,n,o):{bearing:o+e,pitch:n+i},this._getUpdatedState(r)):this}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:t}){return this._getUpdatedState({startZoomLngLat:this._unproject(t),startZoom:this.getViewportProps().zoom})}zoom({pos:t,startPos:e,scale:i}){let{startZoom:r,startZoomLngLat:s}=this.getState();if(s||(r=this.getViewportProps().zoom,s=this._unproject(e)||this._unproject(t)),!s)return this;let{maxZoom:o,minZoom:n}=this.getViewportProps(),a=r+Math.log2(i);a=(0,ez.clamp)(a,n,o);let l=this.makeViewport({...this.getViewportProps(),zoom:a});return this._getUpdatedState({zoom:a,...l.panByPosition(s,t)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(t=2){return this._zoomFromCenter(t)}zoomOut(t=2){return this._zoomFromCenter(1/t)}moveLeft(t=100){return this._panFromCenter([t,0])}moveRight(t=100){return this._panFromCenter([-t,0])}moveUp(t=100){return this._panFromCenter([0,t])}moveDown(t=100){return this._panFromCenter([0,-t])}rotateLeft(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-t})}rotateRight(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+t})}rotateUp(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+t})}rotateDown(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-t})}shortestPathFrom(t){let e=t.getViewportProps(),i={...this.getViewportProps()},{bearing:r,longitude:s}=i;return Math.abs(r-e.bearing)>180&&(i.bearing=r<0?r+360:r-360),Math.abs(s-e.longitude)>180&&(i.longitude=s<0?s+360:s-360),i}applyConstraints(t){let{maxZoom:e,minZoom:i,zoom:r}=t;t.zoom=(0,ez.clamp)(r,i,e);let{maxPitch:s,minPitch:o,pitch:n}=t;t.pitch=(0,ez.clamp)(n,o,s);let{normalize:a=!0}=t;return a&&Object.assign(t,(0,e2.normalizeViewportProps)(t)),t}_zoomFromCenter(t){let{width:e,height:i}=this.getViewportProps();return this.zoom({pos:[e/2,i/2],scale:t})}_panFromCenter(t){let{width:e,height:i}=this.getViewportProps();return this.pan({startPos:[e/2,i/2],pos:[e/2+t[0],i/2+t[1]]})}_getUpdatedState(t){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...t})}_unproject(t){let e=this.makeViewport(this.getViewportProps());return t&&e.unproject(t)}_getNewRotation(t,e,i,r){let s=t[0]-e[0],o=t[1]-e[1],n=t[1],a=e[1],{width:l,height:h}=this.getViewportProps(),c=0;o>0?Math.abs(h-a)>5&&(c=o/(a-h)*1.2):o<0&&a>5&&(c=1-n/a),c=(0,ez.clamp)(c,-1,1);let{minPitch:p,maxPitch:d}=this.getViewportProps(),u=i;return c>0?u=i+c*(d-i):c<0&&(u=i-c*(p-i)),{pitch:u,bearing:r+s/l*180}}},e4=class extends e0{constructor(){super(...arguments),this.ControllerState=e3,this.transition={transitionDuration:300,transitionInterpolator:new eH({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(t){t.position=t.position||[0,0,0];let e=this.props;super.setProps(t),e&&e.height===t.height||this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...t,...this.state}))}},e5=class extends ek{constructor(t={}){super(t)}getViewportType(){return t1}get ControllerType(){return e4}};e5.displayName="MapView";var e6=e5,e8=new tI,e9=class{constructor(t){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=t,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(t){let e=this._defaultEffects;if(!e.find(e=>e.id===t.id)){let i=e.findIndex(e=>{var i,r;return i=e,r=t,(i.order??1/0)-(r.order??1/0)>0});i<0?e.push(t):e.splice(i,0,t),t.setup(this._context),this._setEffects(this.effects)}}setProps(t){"effects"in t&&!eC(t.effects,this.effects,1)&&this._setEffects(t.effects)}needsRedraw(t={clearRedrawFlags:!1}){let e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}getEffects(){return this._resolvedEffects}_setEffects(t){let e={};for(let t of this.effects)e[t.id]=t;let i=[];for(let r of t){let t=e[r.id],s=r;t&&t!==r?t.setProps?(t.setProps(r.props),s=t):t.cleanup(this._context):t||r.setup(this._context),i.push(s),delete e[r.id]}for(let t in e)e[t].cleanup(this._context);this.effects=i,this._resolvedEffects=i.concat(this._defaultEffects),t.some(t=>t instanceof tI)||this._resolvedEffects.push(e8),this._needsRedraw="effects changed"}finalize(){for(let t of this._resolvedEffects)t.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}},e7=class extends tj{shouldDrawLayer(t){let{operation:e}=t.props;return e.includes("draw")||e.includes("terrain")}},it=class{constructor(t){this.device=t,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new e7(t),this.pickLayersPass=new eu(t),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(t){this.layerFilter!==t.layerFilter&&(this.layerFilter=t.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==t.drawPickingColors&&(this.drawPickingColors=t.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(t){if(!t.viewports.length)return;let e=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,i={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...t};i.effects&&this._preRender(i.effects,i);let r=this.lastPostProcessEffect?this.renderBuffers[0]:i.target;this.lastPostProcessEffect&&(i.clearColor=[0,0,0,0],i.clearCanvas=!0);let s=e.render({...i,target:r});i.effects&&this._postRender(i.effects,i),this.renderCount++,g("deckRenderer.renderLayers",this,s,t)}needsRedraw(t={clearRedrawFlags:!1}){let e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}finalize(){let{renderBuffers:t}=this;for(let e of t)e.delete();t.length=0}_preRender(t,e){for(let i of(this.lastPostProcessEffect=null,e.preRenderStats=e.preRenderStats||{},t))e.preRenderStats[i.id]=i.preRender(e),i.postRender&&(this.lastPostProcessEffect=i.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){let{renderBuffers:t}=this,e=this.device.canvasContext.getDrawingBufferSize();for(let i of(0===t.length&&[0,1].map(e=>{let i=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"}});t.push(this.device.createFramebuffer({id:`deck-renderbuffer-${e}`,colorAttachments:[i]}))}),t))i.resize(e)}_postRender(t,e){let{renderBuffers:i}=this,r={...e,inputBuffer:i[0],swapBuffer:i[1]};for(let s of t)if(s.postRender){r.target=s.id===this.lastPostProcessEffect?e.target:void 0;let t=s.postRender(r);r.inputBuffer=t,r.swapBuffer=t===i[0]?i[1]:i[0]}}},ie={pickedColor:null,pickedObjectIndex:-1};function ii({pickInfo:t,viewports:e,pixelRatio:i,x:r,y:s,z:o}){let n,a=e[0];if(e.length>1&&(a=function(t,e){for(let i=t.length-1;i>=0;i--){let r=t[i];if(r.containsPixel(e))return r}return t[0]}((null==t?void 0:t.pickedViewports)||e,{x:r,y:s})),a){let t=[r-a.x,s-a.y];void 0!==o&&(t[2]=o),n=a.unproject(t)}return{color:null,layer:null,viewport:a,index:-1,picked:!1,x:r,y:s,pixel:[r,s],coordinate:n,devicePixel:t&&"pickedX"in t?[t.pickedX,t.pickedY]:void 0,pixelRatio:i}}function ir({layer:t,info:e,mode:i}){for(;t&&e;){let r=e.layer||null;e.sourceLayer=r,e.layer=t,e=t.getPickingInfo({info:e,mode:i,sourceLayer:r}),t=t.parent}return e}var is=class{constructor(t){this._pickable=!0,this.device=t,this.pickLayersPass=new eu(t),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(t){"layerFilter"in t&&(this.layerFilter=t.layerFilter),"_pickable"in t&&(this._pickable=t._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObject(t){return this._pickClosestObject(t)}pickObjects(t){return this._pickVisibleObjects(t)}getLastPickedObject({x:t,y:e,layers:i,viewports:r},s=this.lastPickedInfo.info){let o=s&&s.layer&&s.layer.id,n=s&&s.viewport&&s.viewport.id,a=o?i.find(t=>t.id===o):null,l=n&&r.find(t=>t.id===n)||r[0],h=l&&l.unproject([t-l.x,e-l.y]);return{...s,x:t,y:e,viewport:l,coordinate:h,layer:a}}_resizeBuffer(){var t,e;if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){let t=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=t}let{canvas:i}=this.device.getDefaultCanvasContext();null==(t=this.pickingFBO)||t.resize({width:i.width,height:i.height}),null==(e=this.depthFBO)||e.resize({width:i.width,height:i.height})}_getPickable(t){if(!1===this._pickable)return null;let e=t.filter(t=>this.pickLayersPass.shouldDrawLayer(t)&&!t.isComposite);return e.length?e:null}_pickClosestObject({layers:t,views:e,viewports:i,x:r,y:s,radius:o=0,depth:n=1,mode:a="query",unproject3D:l,onViewportActive:h,effects:c}){let d,u=this.device.canvasContext.cssToDeviceRatio(),f=this._getPickable(t);if(!f||0===i.length)return{result:[],emptyInfo:ii({viewports:i,x:r,y:s,pixelRatio:u})};this._resizeBuffer();let g=this.device.canvasContext.cssToDevicePixels([r,s],!0),m=[g.x+Math.floor(g.width/2),g.y+Math.floor(g.height/2)],_=Math.round(o*u),{width:v,height:w}=this.pickingFBO,y=this._getPickingRect({deviceX:m[0],deviceY:m[1],deviceRadius:_,deviceWidth:v,deviceHeight:w}),b={x:r-o,y:s-o,width:2*o+1,height:2*o+1},P=[],S=new Set;for(let t=0;t<n;t++){let o,g;if((o=y?function({pickedColors:t,decodePickingColor:e,deviceX:i,deviceY:r,deviceRadius:s,deviceRect:o}){let{x:n,y:a,width:l,height:h}=o,c=s*s,d=-1,u=0;for(let e=0;e<h;e++){let s=e+a-r,o=s*s;if(o>c)u+=4*l;else for(let e=0;e<l;e++){if(t[u+3]-1>=0){let t=e+n-i,r=t*t+o;r<=c&&(c=r,d=u)}u+=4}}if(d>=0){let i=t.slice(d,d+4),r=e(i);if(r){let t=Math.floor(d/4/l),e=d/4-t*l;return{...r,pickedColor:i,pickedX:n+e,pickedY:a+t}}p.error("Picked non-existent layer. Is picking buffer corrupt?")()}return ie}({...this._drawAndSample({layers:f,views:e,viewports:i,onViewportActive:h,deviceRect:y,cullRect:b,effects:c,pass:`picking:${a}`}),deviceX:m[0],deviceY:m[1],deviceRadius:_,deviceRect:y}):{pickedColor:null,pickedObjectIndex:-1}).pickedLayer&&l&&this.depthFBO){let{pickedColors:t}=this._drawAndSample({layers:[o.pickedLayer],views:e,viewports:i,onViewportActive:h,deviceRect:{x:o.pickedX,y:o.pickedY,width:1,height:1},cullRect:b,effects:c,pass:`picking:${a}:z`},!0);t[3]&&(g=t[0])}for(let e of(o.pickedLayer&&t+1<n&&(S.add(o.pickedLayer),o.pickedLayer.disablePickingIndex(o.pickedObjectIndex)),(d=function(t){let{pickInfo:e,lastPickedInfo:i,mode:r,layers:s}=t,{pickedColor:o,pickedLayer:n,pickedObjectIndex:a}=e,l=n?[n]:[];if("hover"===r){let t=i.index,e=i.layerId,r=n?n.props.id:null;if(r!==e||a!==t){if(r!==e){let t=s.find(t=>t.props.id===e);t&&l.unshift(t)}i.layerId=r,i.index=a,i.info=null}}let h=ii(t),c=new Map;return c.set(null,h),l.forEach(t=>{let e={...h};t===n&&(e.color=o,e.index=a,e.picked=!0);let s=(e=ir({layer:t,info:e,mode:r})).layer;t===n&&"hover"===r&&(i.info=e),c.set(s.id,e),"hover"===r&&s.updateAutoHighlight(e)}),c}({pickInfo:o,lastPickedInfo:this.lastPickedInfo,mode:a,layers:f,viewports:i,x:r,y:s,z:g,pixelRatio:u})).values()))e.layer&&P.push(e);if(!o.pickedColor)break}for(let t of S)t.restorePickingColors();return{result:P,emptyInfo:d.get(null)}}_pickVisibleObjects({layers:t,views:e,viewports:i,x:r,y:s,width:o=1,height:n=1,mode:a="query",maxObjects:l=null,onViewportActive:h,effects:c}){let d=this._getPickable(t);if(!d||0===i.length)return[];this._resizeBuffer();let u=this.device.canvasContext.cssToDeviceRatio(),f=this.device.canvasContext.cssToDevicePixels([r,s],!0),g=f.x,m=f.y+f.height,_=this.device.canvasContext.cssToDevicePixels([r+o,s+n],!0),v=_.x+_.width,w=_.y,y=function({pickedColors:t,decodePickingColor:e}){let i=new Map;if(t){for(let r=0;r<t.length;r+=4)if(t[r+3]-1>=0){let s=t.slice(r,r+4),o=s.join(",");if(!i.has(o)){let t=e(s);t?i.set(o,{...t,color:s}):p.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(i.values())}(this._drawAndSample({layers:d,views:e,viewports:i,onViewportActive:h,deviceRect:{x:g,y:w,width:v-g,height:m-w},cullRect:{x:r,y:s,width:o,height:n},effects:c,pass:`picking:${a}`})),b=new Map,P=[],S=Number.isFinite(l);for(let t=0;t<y.length&&(!S||!(P.length>=l));t++){let e=y[t],i={color:e.pickedColor,layer:null,index:e.pickedObjectIndex,picked:!0,x:r,y:s,pixelRatio:u},o=(i=ir({layer:e.pickedLayer,info:i,mode:a})).layer.id;b.has(o)||b.set(o,new Set);let n=b.get(o),l=i.object??i.index;n.has(l)||(n.add(l),P.push(i))}return P}_drawAndSample({layers:t,views:e,viewports:i,onViewportActive:r,deviceRect:s,cullRect:o,effects:n,pass:a},l=!1){let h=l?this.depthFBO:this.pickingFBO,c={layers:t,layerFilter:this.layerFilter,views:e,viewports:i,onViewportActive:r,pickingFBO:h,deviceRect:s,cullRect:o,effects:n,pass:a,pickZ:l,preRenderStats:{},isPicking:!0};for(let t of n)t.useInPicking&&(c.preRenderStats[t.id]=t.preRender(c));let{decodePickingColor:p}=this.pickLayersPass.render(c),{x:d,y:u,width:f,height:g}=s,m=new(l?Float32Array:Uint8Array)(f*g*4);return this.device.readPixelsToArrayWebGL(h,{sourceX:d,sourceY:u,sourceWidth:f,sourceHeight:g,target:m}),{pickedColors:m,decodePickingColor:p}}_getPickingRect({deviceX:t,deviceY:e,deviceRadius:i,deviceWidth:r,deviceHeight:s}){let o=Math.max(0,t-i),n=Math.max(0,e-i),a=Math.min(r,t+i+1)-o,l=Math.min(s,e+i+1)-n;return a<=0||l<=0?null:{x:o,y:n,width:a,height:l}}},io={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},ia="__root",il=class{constructor({deck:t,parentElement:e}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=t,this.parentElement=e}getWidgets(){return this.resolvedWidgets}setProps(t){t.widgets&&!eC(t.widgets,this.widgets,1)&&this._setWidgets(t.widgets)}finalize(){for(let t of this.getWidgets())this._remove(t);for(let t in this.defaultWidgets.length=0,this.resolvedWidgets.length=0,this.containers)this.containers[t].remove()}addDefault(t){this.defaultWidgets.find(e=>e.id===t.id)||(this._add(t),this.defaultWidgets.push(t),this._setWidgets(this.widgets))}_setWidgets(t){let e={};for(let t of this.resolvedWidgets)e[t.id]=t;for(let t of(this.resolvedWidgets.length=0,this.defaultWidgets))e[t.id]=null,this.resolvedWidgets.push(t);for(let i of t){let t=e[i.id];t?t.viewId!==i.viewId||t.placement!==i.placement?(this._remove(t),this._add(i)):i!==t&&(t.setProps(i.props),i=t):this._add(i),e[i.id]=null,this.resolvedWidgets.push(i)}for(let t in e){let i=e[t];i&&this._remove(i)}this.widgets=t}_add(t){let{viewId:e=null,placement:i="top-left"}=t,r=t.onAdd({deck:this.deck,viewId:e});r&&this._getContainer(e,i).append(r),t._element=r}_remove(t){var e;null==(e=t.onRemove)||e.call(t),t._element&&t._element.remove(),t._element=void 0}_getContainer(t,e){var i;let r=t||ia,s=this.containers[r];s||((s=document.createElement("div")).style.pointerEvents="none",s.style.position="absolute",s.style.overflow="hidden",null==(i=this.parentElement)||i.append(s),this.containers[r]=s);let o=s.querySelector(`.${e}`);return o||((o=document.createElement("div")).className=e,o.style.position="absolute",o.style.zIndex="2",Object.assign(o.style,io[e]),s.append(o)),o}_updateContainers(){let t=this.deck.width,e=this.deck.height;for(let i in this.containers){let r=this.lastViewports[i]||null,s=i===ia||r,o=this.containers[i];s?(o.style.display="block",o.style.left=`${r?r.x:0}px`,o.style.top=`${r?r.y:0}px`,o.style.width=`${r?r.width:t}px`,o.style.height=`${r?r.height:e}px`):o.style.display="none"}}onRedraw({viewports:t,layers:e}){var i,r;let s=t.reduce((t,e)=>(t[e.id]=e,t),{});for(let o of this.getWidgets()){let{viewId:n}=o;if(n){let t=s[n];t&&(o.onViewportChange&&o.onViewportChange(t),null==(i=o.onRedraw)||i.call(o,{viewports:[t],layers:e}))}else{if(o.onViewportChange)for(let e of t)o.onViewportChange(e);null==(r=o.onRedraw)||r.call(o,{viewports:t,layers:e})}}this.lastViewports=s,this._updateContainers()}onHover(t,e){var i,r;for(let s of this.getWidgets()){let{viewId:o}=s;o&&o!==(null==(i=t.viewport)?void 0:i.id)||null==(r=s.onHover)||r.call(s,t,e)}}onEvent(t,e){var i,r;let s=C[e.type];if(s)for(let o of this.getWidgets()){let{viewId:n}=o;n&&n!==(null==(i=t.viewport)?void 0:i.id)||null==(r=o[s])||r.call(o,t,e)}}},ih={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"},ic=class{constructor(){this.id="default-tooltip",this.placement="fill",this.props={},this.isVisible=!1}onAdd({deck:t}){let e=document.createElement("div");return e.className="deck-tooltip",Object.assign(e.style,ih),this.deck=t,this.element=e,e}onRemove(){this.deck=void 0,this.element=void 0}setProps(){}onViewportChange(t){var e;this.isVisible&&t.id===(null==(e=this.lastViewport)?void 0:e.id)&&t!==this.lastViewport&&this.setTooltip(null)}onHover(t){let{deck:e}=this,i=e&&e.props.getTooltip;if(!i)return;let r=i(t);this.lastViewport=t.viewport,this.setTooltip(r,t.x,t.y)}setTooltip(t,e,i){let r=this.element;if(r){if("string"==typeof t)r.innerText=t;else if(t)t.text&&(r.innerText=t.text),t.html&&(r.innerHTML=t.html),t.className&&(r.className=t.className);else{this.isVisible=!1,r.style.display="none";return}this.isVisible=!0,r.style.display="block",r.style.transform=`translate(${e}px, ${i}px)`,t&&"object"==typeof t&&"style"in t&&Object.assign(r.style,t.style)}}},ip=i(3957),id=i(3431),iu=i(6463),ig=i(6463);i(4871);var im=i(5683),i_=i(8641);function iv(){}var iw={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:iv,onWebGLInitialized:iv,onResize:iv,onViewStateChange:iv,onInteractionStateChange:iv,onBeforeRender:iv,onAfterRender:iv,onLoad:iv,onError:t=>p.error(t.message,t.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:({isDragging:t})=>t?"grabbing":"grab",getTooltip:null,debug:!1,drawPickingColors:!1},iy=class{constructor(t){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new im.Stats({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=t=>{let{_pickRequest:e}=this;if("pointerleave"===t.type)e.x=-1,e.y=-1,e.radius=0;else{if(t.leftButton||t.rightButton)return;let i=t.offsetCenter;if(!i)return;e.x=i.x,e.y=i.y,e.radius=this.props.pickingRadius}this.layerManager&&(this.layerManager.context.mousePosition={x:e.x,y:e.y}),e.event=t},this._onEvent=t=>{let e=C[t.type],i=t.offsetCenter;if(!e||!i||!this.layerManager)return;let r=this.layerManager.getLayers(),s=this.deckPicker.getLastPickedObject({x:i.x,y:i.y,layers:r,viewports:this.getViewports(i)},this._lastPointerDownInfo),{layer:o}=s,n=o&&(o[e]||o.props[e]),a=this.props[e],l=!1;n&&(l=n.call(o,s,t)),l||(null==a||a(s,t),this.widgetManager.onEvent(s,t))},this._onPointerDown=t=>{var e;if((null==(e=this.device)?void 0:e.type)==="webgpu")return;let i=t.offsetCenter,r=this._pick("pickObject","pickObject Time",{x:i.x,y:i.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=r.result[0]||r.emptyInfo},this.props={...iw,...t},(t=this.props).viewState&&t.initialViewState&&p.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,t.device&&(this.device=t.device);let e=this.device;!e&&t.gl&&(t.gl instanceof WebGLRenderingContext&&p.error("WebGL1 context not supported.")(),e=id.webgl2Adapter.attach(t.gl)),e||(e=ip.luma.createDevice({type:"best-available",_reuseDevices:!0,adapters:[id.webgl2Adapter],...t.deviceProps,createCanvasContext:{canvas:this._createCanvas(t),useDevicePixels:this.props.useDevicePixels,autoResize:!1}})),this.animationLoop=this._createAnimationLoop(e,t),this.setProps(t),t._typedArrayManagerProps&&tk.setOptions(t._typedArrayManagerProps),this.animationLoop.start()}finalize(){var t,e,i,r,s,o,n,a,l,h;null==(t=this.animationLoop)||t.stop(),null==(e=this.animationLoop)||e.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,null==(i=this.layerManager)||i.finalize(),this.layerManager=null,null==(r=this.viewManager)||r.finalize(),this.viewManager=null,null==(s=this.effectManager)||s.finalize(),this.effectManager=null,null==(o=this.deckRenderer)||o.finalize(),this.deckRenderer=null,null==(n=this.deckPicker)||n.finalize(),this.deckPicker=null,null==(a=this.eventManager)||a.destroy(),this.eventManager=null,null==(l=this.widgetManager)||l.finalize(),this.widgetManager=null,this.props.canvas||this.props.device||this.props.gl||!this.canvas||(null==(h=this.canvas.parentElement)||h.removeChild(this.canvas),this.canvas=null)}setProps(t){var e;this.stats.get("setProps Time").timeStart(),"onLayerHover"in t&&p.removed("onLayerHover","onHover")(),"onLayerClick"in t&&p.removed("onLayerClick","onClick")(),t.initialViewState&&!eC(this.props.initialViewState,t.initialViewState,3)&&(this.viewState=t.initialViewState),Object.assign(this.props,t),this._setCanvasSize(this.props);let i=Object.create(this.props);Object.assign(i,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),null==(e=this.animationLoop)||e.setProps(i),this.layerManager&&(this.viewManager.setProps(i),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(i),this.effectManager.setProps(i),this.deckRenderer.setProps(i),this.deckPicker.setProps(i),this.widgetManager.setProps(i)),this.stats.get("setProps Time").timeEnd()}needsRedraw(t={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let e=this._needsRedraw;t.clearRedrawFlags&&(this._needsRedraw=!1);let i=this.viewManager.needsRedraw(t),r=this.layerManager.needsRedraw(t),s=this.effectManager.needsRedraw(t),o=this.deckRenderer.needsRedraw(t);return e||i||r||s||o}redraw(t){if(!this.layerManager)return;let e=this.needsRedraw({clearRedrawFlags:!0});(e=t||e)&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(e):this._drawLayers(e))}get isInitialized(){return null!==this.viewManager}getViews(){return eG(this.viewManager),this.viewManager.views}getViewports(t){return eG(this.viewManager),this.viewManager.getViewports(t)}getCanvas(){return this.canvas}pickObject(t){let e=this._pick("pickObject","pickObject Time",t).result;return e.length?e[0]:null}pickMultipleObjects(t){return t.depth=t.depth||10,this._pick("pickObject","pickMultipleObjects Time",t).result}pickObjects(t){return this._pick("pickObjects","pickObjects Time",t)}_addResources(t,e=!1){for(let i in t)this.layerManager.resourceManager.add({resourceId:i,data:t[i],forceUpdate:e})}_removeResources(t){for(let e of t)this.layerManager.resourceManager.remove(e)}_addDefaultEffect(t){this.effectManager.addDefaultEffect(t)}_addDefaultShaderModule(t){this.layerManager.addDefaultShaderModule(t)}_removeDefaultShaderModule(t){var e;null==(e=this.layerManager)||e.removeDefaultShaderModule(t)}_pick(t,e,i){eG(this.deckPicker);let{stats:r}=this;r.get("Pick Count").incrementCount(),r.get(e).timeStart();let s=this.deckPicker[t]({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...i});return r.get(e).timeEnd(),s}_createCanvas(t){let e=t.canvas;return"string"==typeof e&&eG(e=document.getElementById(e)),e||((e=document.createElement("canvas")).id=t.id||"deckgl-overlay",(t.parent||document.body).appendChild(e)),Object.assign(e.style,t.style),e}_setCanvasSize(t){var e;if(!this.canvas)return;let{width:i,height:r}=t;if(i||0===i){let t=Number.isFinite(i)?`${i}px`:i;this.canvas.style.width=t}if(r||0===r){let i=Number.isFinite(r)?`${r}px`:r;this.canvas.style.position=(null==(e=t.style)?void 0:e.position)||"absolute",this.canvas.style.height=i}}_updateCanvasSize(){var t,e;let{canvas:i}=this;if(!i)return;let r=i.clientWidth??i.width,s=i.clientHeight??i.height;(r!==this.width||s!==this.height)&&(this.width=r,this.height=s,null==(t=this.viewManager)||t.setProps({width:r,height:s}),null==(e=this.layerManager)||e.activateViewport(this.getViewports()[0]),this.props.onResize({width:r,height:s}))}_createAnimationLoop(t,e){let{gl:i,onError:r,useDevicePixels:s}=e;return new ig.AnimationLoop({device:t,useDevicePixels:s,autoResizeDrawingBuffer:!i,autoResizeViewport:!1,onInitialize:t=>this._setDevice(t.device),onRender:this._onRenderFrame.bind(this),onError:r})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){let{views:t}=this.props,e=Array.isArray(t)?t:t?[t]:[new e6({id:"default-view"})];return e.length&&this.props.controller&&(e[0].props.controller=this.props.controller),e}_onContextLost(){let{onError:t}=this.props;this.animationLoop&&t&&t(Error("WebGL context is lost"))}_pickAndCallback(){var t,e,i,r;if((null==(t=this.device)?void 0:t.type)==="webgpu")return;let{_pickRequest:s}=this;if(s.event){let{result:t,emptyInfo:o}=this._pick("pickObject","pickObject Time",s);this.cursorState.isHovering=t.length>0;let n=o,a=!1;for(let i of t)n=i,a=(null==(e=i.layer)?void 0:e.onHover(i,s.event))||a;a||(null==(r=(i=this.props).onHover)||r.call(i,n,s.event),this.widgetManager.onHover(n,s.event)),s.event=null}}_updateCursor(){let t=this.props.parent||this.canvas;t&&(t.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(t){var e,i;if(this.device=t,!this.animationLoop)return;this.canvas||(this.canvas=null==(e=this.device.canvasContext)?void 0:e.canvas),"webgl"===this.device.type&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),"webgl"===this.device.type&&this.props.onWebGLInitialized(this.device.gl);let r=new iu.Timeline;for(let t in r.play(),this.animationLoop.attachTimeline(r),this.eventManager=new i_.EventManager(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(L).map(t=>{var e;let[i,r,s,o]=L[t],n=null==(e=this.props.eventRecognizerOptions)?void 0:e[t];return{recognizer:new i({...r,...n,event:t}),recognizeWith:s,requestFailure:o}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}}),C)this.eventManager.on(t,this._onEvent);this.viewManager=new eL({timeline:r,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});let s=this.viewManager.getViewports()[0];this.layerManager=new eA(this.device,{deck:this,stats:this.stats,viewport:s,timeline:r}),this.effectManager=new e9({deck:this,device:this.device}),this.deckRenderer=new it(this.device),this.deckPicker=new is(this.device),this.widgetManager=new il({deck:this,parentElement:null==(i=this.canvas)?void 0:i.parentElement}),this.widgetManager.addDefault(new ic),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(t,e){var i;let{device:r,gl:s}=this.layerManager.context;this.props.onBeforeRender({device:r,gl:s});let o={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...e};null==(i=this.deckRenderer)||i.renderLayers(o),"screen"===o.pass&&this.widgetManager.onRedraw({viewports:o.viewports,layers:o.layers}),this.props.onAfterRender({device:r,gl:s})}_onRenderFrame(){var t;this._getFrameStats(),this._metricsCounter++%60==0&&(this._getMetrics(),this.stats.reset(),p.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),(null==(t=this.device)?void 0:t.type)!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(t){let e=this.props.onViewStateChange(t)||t.viewState;this.viewState&&(this.viewState={...this.viewState,[t.viewId]:e},!this.props.viewState&&this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(t){this.cursorState.isDragging=t.isDragging||!1,this.props.onInteractionStateChange(t)}_getFrameStats(){let{stats:t}=this;t.get("frameRate").timeEnd(),t.get("frameRate").timeStart();let e=this.animationLoop.stats;t.get("GPU Time").addTime(e.get("GPU Time").lastTiming),t.get("CPU Time").addTime(e.get("CPU Time").lastTiming)}_getMetrics(){let{metrics:t,stats:e}=this;t.fps=e.get("frameRate").getHz(),t.setPropsTime=e.get("setProps Time").time,t.updateAttributesTime=e.get("Update Attributes").time,t.framesRedrawn=e.get("Redraw Count").count,t.pickTime=e.get("pickObject Time").time+e.get("pickMultipleObjects Time").time+e.get("pickObjects Time").time,t.pickCount=e.get("Pick Count").count,t.gpuTime=e.get("GPU Time").time,t.cpuTime=e.get("CPU Time").time,t.gpuTimePerFrame=e.get("GPU Time").getAverageTime(),t.cpuTimePerFrame=e.get("CPU Time").getAverageTime();let i=ip.luma.stats.get("Memory Usage");t.bufferMemory=i.get("Buffer Memory").count,t.textureMemory=i.get("Texture Memory").count,t.renderbufferMemory=i.get("Renderbuffer Memory").count,t.gpuMemory=i.get("GPU Memory").count}};iy.defaultProps=iw,iy.VERSION=_;var ib=iy,iP=i(3957),iS=i(3957),iM=iS.getDataTypeFromTypedArray;function iT(t,e,i){let r="webgpu"===i&&"uint8"===e.type?"unorm8":e.type;return{attribute:t,format:e.size>1?`${r}x${e.size}`:e.type,byteOffset:e.offset||0}}function ix(t){return t.stride||t.size*t.bytesPerElement}function iE(t,e){e.offset&&p.removed("shaderAttribute.offset","vertexOffset, elementOffset")();let i=ix(t),r=(void 0!==e.vertexOffset?e.vertexOffset:t.vertexOffset||0)*i+(e.elementOffset||0)*t.bytesPerElement+(t.offset||0);return{...e,offset:r,stride:i}}var ij=class{constructor(t,e,i){let r;this._buffer=null,this.device=t,this.id=e.id||"",this.size=e.size||1;let s=e.logicalType||e.type,o="float64"===s,{defaultValue:n}=e;n=Number.isFinite(n)?[n]:n||Array(this.size).fill(0),r=o?"float32":!s&&e.isIndexed?"uint32":s||"float32";let a=function(t){switch(t){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return(0,iS.getTypedArrayFromDataType)(t)}}(s||r);this.doublePrecision=o,o&&!1===e.fp64&&(a=Float32Array),this.value=null,this.settings={...e,defaultType:a,defaultValue:n,logicalType:s,type:r,normalized:r.includes("norm"),size:this.size,bytesPerElement:a.BYTES_PER_ELEMENT},this.state={...i,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){let t=this.getAccessor();return t.vertexOffset?t.vertexOffset*ix(t):0}get numInstances(){return this.state.numInstances}set numInstances(t){this.state.numInstances=t}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),tk.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(t=this.id,e=null){let i={};if(this.state.constant){let r=this.value;if(e){let s=iE(this.getAccessor(),e),o=s.offset/r.BYTES_PER_ELEMENT,n=s.size||this.size;i[t]=r.subarray(o,o+n)}else i[t]=r}else i[t]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?i[`${t}64Low`]=i[t]:i[`${t}64Low`]=new Float32Array(this.size)),i}_getBufferLayout(t=this.id,e=null){let i=this.getAccessor(),r=[],s={name:this.id,byteStride:ix(i),attributes:r};if(this.doublePrecision){let s=function(t,e){let i=iE(t,e);return{high:i,low:{...i,offset:i.offset+4*t.size}}}(i,e||{});r.push(iT(t,{...i,...s.high},this.device.type),iT(`${t}64Low`,{...i,...s.low},this.device.type))}else if(e){let s=iE(i,e);r.push(iT(t,{...i,...s},this.device.type))}else r.push(iT(t,i,this.device.type));return s}setAccessor(t){this.state.bufferAccessor=t}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let t=null;if(this.state.constant&&this.value){let e=Array.from(this.value);t=[e,e]}else{let{value:e,numInstances:i,size:r}=this,s=i*r;if(e&&s&&e.length>=s){let i=Array(r).fill(1/0),o=Array(r).fill(-1/0);for(let t=0;t<s;)for(let s=0;s<r;s++){let r=e[t++];r<i[s]&&(i[s]=r),r>o[s]&&(o[s]=r)}t=[i,o]}}return this.state.bounds=t,t}setData(t){let e,{state:i}=this;e=ArrayBuffer.isView(t)?{value:t}:t instanceof iP.Buffer?{buffer:t}:t;let r={...this.settings,...e};if(ArrayBuffer.isView(e.value)){if(!e.type)if(this.doublePrecision&&e.value instanceof Float64Array)r.type="float32";else{let t=iM(e.value);r.type=r.normalized?t.replace("int","norm"):t}r.bytesPerElement=e.value.BYTES_PER_ELEMENT,r.stride=ix(r)}if(i.bounds=null,e.constant){let t=e.value;if(t=this._normalizeValue(t,[],0),this.settings.normalized&&(t=this.normalizeConstant(t)),!(!i.constant||!this._areValuesEqual(t,this.value)))return!1;i.externalBuffer=null,i.constant=!0,this.value=ArrayBuffer.isView(t)?t:new Float32Array(t)}else if(e.buffer)i.externalBuffer=e.buffer,i.constant=!1,this.value=e.value||null;else if(e.value){this._checkExternalBuffer(e);let t=e.value;i.externalBuffer=null,i.constant=!1,this.value=t;let{buffer:s}=this,o=ix(r),n=(r.vertexOffset||0)*o;if(this.doublePrecision&&t instanceof Float64Array&&(t=tB(t,r)),this.settings.isIndexed){let e=this.settings.defaultType;t.constructor!==e&&(t=new e(t))}let a=t.byteLength+n+2*o;(!s||s.byteLength<a)&&(s=this._createBuffer(a)),s.write(t,n)}return this.setAccessor(r),!0}updateSubBuffer(t={}){this.state.bounds=null;let e=this.value,{startOffset:i=0,endOffset:r}=t;this.buffer.write(this.doublePrecision&&e instanceof Float64Array?tB(e,{size:this.size,startIndex:i,endIndex:r}):e.subarray(i,r),i*e.BYTES_PER_ELEMENT+this.byteOffset)}allocate(t,e=!1){let{state:i}=this,r=i.allocatedValue,s=tk.allocate(r,t+1,{size:this.size,type:this.settings.defaultType,copy:e});this.value=s;let{byteOffset:o}=this,{buffer:n}=this;return(!n||n.byteLength<s.byteLength+o)&&(n=this._createBuffer(s.byteLength+o),e&&r&&n.write(r instanceof Float64Array?tB(r,this):r,o)),i.allocatedValue=s,i.constant=!1,i.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(t){let{value:e}=t;if(!ArrayBuffer.isView(e))throw Error(`Attribute ${this.id} value is not TypedArray`);let i=this.settings.defaultType,r=!1;if(this.doublePrecision&&(r=e.BYTES_PER_ELEMENT<4),r)throw Error(`Attribute ${this.id} does not support ${e.constructor.name}`);e instanceof i||!this.settings.normalized||"normalized"in t||p.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(t){switch(this.settings.type){case"snorm8":return new Float32Array(t).map(t=>(t+128)/255*2-1);case"snorm16":return new Float32Array(t).map(t=>(t+32768)/65535*2-1);case"unorm8":return new Float32Array(t).map(t=>t/255);case"unorm16":return new Float32Array(t).map(t=>t/65535);default:return t}}_normalizeValue(t,e,i){let{defaultValue:r,size:s}=this.settings;if(Number.isFinite(t))return e[i]=t,e;if(!t){let t=s;for(;--t>=0;)e[i+t]=r[t];return e}switch(s){case 4:e[i+3]=Number.isFinite(t[3])?t[3]:r[3];case 3:e[i+2]=Number.isFinite(t[2])?t[2]:r[2];case 2:e[i+1]=Number.isFinite(t[1])?t[1]:r[1];case 1:e[i+0]=Number.isFinite(t[0])?t[0]:r[0];break;default:let o=s;for(;--o>=0;)e[i+o]=Number.isFinite(t[o])?t[o]:r[o]}return e}_areValuesEqual(t,e){if(!t||!e)return!1;let{size:i}=this;for(let r=0;r<i;r++)if(t[r]!==e[r])return!1;return!0}_createBuffer(t){var e;this._buffer&&this._buffer.destroy();let{isIndexed:i,type:r}=this.settings;return this._buffer=this.device.createBuffer({...null==(e=this._buffer)?void 0:e.props,id:this.id,usage:(i?iP.Buffer.INDEX:iP.Buffer.VERTEX)|iP.Buffer.COPY_DST,indexType:i?r:void 0,byteLength:t}),this._buffer}},iA=[],iC=[];function iL(t,e=0,i=1/0){let r=iA,s={index:-1,data:t,target:[]};return t?"function"==typeof t[Symbol.iterator]?r=t:t.length>0&&(iC.length=t.length,r=iC):r=iA,(e>0||Number.isFinite(i))&&(r=(Array.isArray(r)?r:Array.from(r)).slice(e,i),s.index=e-1),{iterable:r,objectInfo:s}}function iR(t){return t&&t[Symbol.asyncIterator]}function iO(t,e){let{size:i,stride:r,offset:s,startIndices:o,nested:n}=e,a=t.BYTES_PER_ELEMENT,l=r?r/a:i,h=s?s/a:0,c=Math.floor((t.length-h)/l);return(e,{index:r,target:s})=>{let a;if(!o){let e=r*l+h;for(let r=0;r<i;r++)s[r]=t[e+r];return s}let p=o[r],d=o[r+1]||c;if(n){a=Array(d-p);for(let e=p;e<d;e++){let r=e*l+h;s=Array(i);for(let e=0;e<i;e++)s[e]=t[r+e];a[e-p]=s}}else if(l===i)a=t.subarray(p*i+h,d*i+h);else{a=new t.constructor((d-p)*i);let e=0;for(let r=p;r<d;r++){let s=r*l+h;for(let r=0;r<i;r++)a[e++]=t[s+r]}}return a}}var iI=[],ik=[[0,1/0]],iz={interpolation:{duration:0,easing:t=>t},spring:{stiffness:.05,damping:.5}};function iV(t,e){if(!t)return null;Number.isFinite(t)&&(t={type:"interpolation",duration:t});let i=t.type||"interpolation";return{...iz[i],...e,...t,type:i}}var iU=class extends ij{constructor(t,e){super(t,e,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:ik}),this.constant=!1,this.settings.update=e.update||(e.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(t){this.state.startIndices=t}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:t=!1}={}){let e=this.state.needsRedraw;return this.state.needsRedraw=e&&!t,e}layoutChanged(){return this.state.layoutChanged}setAccessor(t){var e,i;(e=this.state).layoutChanged||(i=this.getAccessor(),e.layoutChanged=t.type!==i.type||t.size!==i.size||ix(t)!==ix(i)||(t.offset||0)!==(i.offset||0)),super.setAccessor(t)}getUpdateTriggers(){let{accessor:t}=this.settings;return[this.id].concat("function"!=typeof t&&t||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(t){if(!t||!this.supportsTransition())return null;let{accessor:e}=this.settings,i=this.settings.transition;return iV(Array.isArray(e)?t[e.find(e=>t[e])]:t[e],i)}setNeedsUpdate(t=this.id,e){if(this.state.needsUpdate=this.state.needsUpdate||t,this.setNeedsRedraw(t),e){let{startRow:t=0,endRow:i=1/0}=e;this.state.updateRanges=function(t,e){if(t===ik||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return t;let i=[],r=t.length,s=0;for(let o=0;o<r;o++){let r=t[o];r[1]<e[0]?(i.push(r),s=o+1):r[0]>e[1]?i.push(r):e=[Math.min(r[0],e[0]),Math.max(r[1],e[1])]}return i.splice(s,0,e),i}(this.state.updateRanges,[t,i])}else this.state.updateRanges=ik}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=iI}setNeedsRedraw(t=this.id){this.state.needsRedraw=this.state.needsRedraw||t}allocate(t){let{state:e,settings:i}=this;return!i.noAlloc&&!!i.update&&(super.allocate(t,e.updateRanges!==ik),!0)}updateBuffer({numInstances:t,data:e,props:i,context:r}){if(!this.needsUpdate())return!1;let{state:{updateRanges:s},settings:{update:o,noAlloc:n}}=this,a=!0;if(o){for(let[n,a]of s)o.call(r,this,{data:e,startRow:n,endRow:a,props:i,numInstances:t});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(let[e,i]of s){let r=Number.isFinite(e)?this.getVertexOffset(e):0,s=Number.isFinite(i)?this.getVertexOffset(i):n||!Number.isFinite(t)?this.value.length:t*this.size;super.updateSubBuffer({startOffset:r,endOffset:s})}this._checkAttributeArray()}else a=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),a}setConstantValue(t){return"webgpu"!==this.device.type&&void 0!==t&&"function"!=typeof t&&(this.setData({constant:!0,value:t})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(t){let{state:e}=this;return t?(this.clearNeedsUpdate(),e.lastExternalBuffer===t||(e.lastExternalBuffer=t,this.setNeedsRedraw(),this.setData(t),!0)):(e.lastExternalBuffer=null,!1)}setBinaryValue(t,e=null){let{state:i,settings:r}=this;if(!t)return i.binaryValue=null,i.binaryAccessor=null,!1;if(r.noAlloc)return!1;if(i.binaryValue===t)return this.clearNeedsUpdate(),!0;if(i.binaryValue=t,this.setNeedsRedraw(),r.transform||e!==this.startIndices){ArrayBuffer.isView(t)&&(t={value:t});let s=t;eG(ArrayBuffer.isView(s.value),`invalid ${r.accessor}`);let o=!!s.size&&s.size!==this.size;return i.binaryAccessor=iO(s.value,{size:s.size||this.size,stride:s.stride,offset:s.offset,startIndices:e,nested:o}),!1}return this.clearNeedsUpdate(),this.setData(t),!0}getVertexOffset(t){let{startIndices:e}=this;return(e?t<e.length?e[t]:this.numInstances:t)*this.size}getValue(){let t=this.settings.shaderAttributes,e=super.getValue();if(!t)return e;for(let i in t)Object.assign(e,super.getValue(i,t[i]));return e}getBufferLayout(t){this.state.layoutChanged=!1;let e=this.settings.shaderAttributes,i=super._getBufferLayout(),{stepMode:r}=this.settings;if("dynamic"===r?i.stepMode=t?t.isInstanced?"instance":"vertex":"instance":i.stepMode=r??"vertex",!e)return i;for(let t in e){let r=super._getBufferLayout(t,e[t]);i.attributes.push(...r.attributes)}return i}_autoUpdater(t,{data:e,startRow:i,endRow:r,props:s,numInstances:o}){if(t.constant&&"webgpu"!==this.context.device.type)return;let{settings:n,state:a,value:l,size:h,startIndices:c}=t,{accessor:p,transform:d}=n,u=a.binaryAccessor||("function"==typeof p?p:s[p]);"function"!=typeof u&&(u=()=>u),eG("function"==typeof u,`accessor "${p}" is not a function`);let f=t.getVertexOffset(i),{iterable:g,objectInfo:m}=iL(e,i,r);for(let e of g){m.index++;let i=u(e,m);if(d&&(i=d.call(this,i)),c){let e=(m.index<c.length-1?c[m.index+1]:o)-c[m.index];if(i&&Array.isArray(i[0])){let e=f;for(let r of i)t._normalizeValue(r,l,e),e+=h}else i&&i.length>h?l.set(i,f):(t._normalizeValue(i,m.target,0),eM({target:l,source:m.target,start:f,count:e}));f+=e*h}else t._normalizeValue(i,l,f),f+=h}}_validateAttributeUpdaters(){let{settings:t}=this;if(!(t.noAlloc||"function"==typeof t.update))throw Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){let{value:t}=this,e=Math.min(4,this.size);if(t&&t.length>=e){let i=!0;switch(e){case 4:i=i&&Number.isFinite(t[3]);case 3:i=i&&Number.isFinite(t[2]);case 2:i=i&&Number.isFinite(t[1]);case 1:i=i&&Number.isFinite(t[0]);break;default:i=!1}if(!i)throw Error(`Illegal attribute generated for ${this.id}`)}}},iD=i(6463),iF=i(2763);function iN(t){let{source:e,target:i,start:r=0,size:s,getData:o}=t,n=t.end||i.length,a=e.length,l=n-r;if(a>l)return void i.set(e.subarray(0,l),r);if(i.set(e,r),!o)return;let h=a;for(;h<l;){let t=o(h,e);for(let e=0;e<s;e++)i[r+h]=t[e]||0,h++}}function iB(t){switch(t){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw Error(`No defined attribute type for size "${t}"`)}}function i$(t){switch(t){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw Error("invalid type size")}}function iG(t){t.push(t.shift())}function iW({device:t,source:e,target:i}){return(!i||i.byteLength<e.byteLength)&&(null==i||i.destroy(),i=t.createBuffer({byteLength:e.byteLength,usage:e.usage})),i}function iZ({device:t,buffer:e,attribute:i,fromLength:r,toLength:s,fromStartIndices:o,getData:n=t=>t}){let a=i.doublePrecision&&i.value instanceof Float64Array?2:1,l=i.size*a,h=i.byteOffset,c=i.settings.bytesPerElement<4?h/i.settings.bytesPerElement*4:h,p=i.startIndices,d=o&&p,u=i.isConstant;if(!d&&e&&r>=s)return e;let f=i.value instanceof Float64Array?Float32Array:i.value.constructor,g=u?i.value:new f(i.getBuffer().readSyncWebGL(h,s*f.BYTES_PER_ELEMENT).buffer);if(i.settings.normalized&&!u){let t=n;n=(e,r)=>i.normalizeConstant(t(e,r))}let m=u?(t,e)=>n(g,e):(t,e)=>n(g.subarray(t+h,t+h+l),e),_=new Float32Array(e?e.readSyncWebGL(c,4*r).buffer:0),v=new Float32Array(s);return!function({source:t,target:e,size:i,getData:r,sourceStartIndices:s,targetStartIndices:o}){if(!s||!o)return iN({source:t,target:e,size:i,getData:r});let n=0,a=0,l=r&&((t,e)=>r(t+a,e)),h=Math.min(s.length,o.length);for(let r=1;r<h;r++){let h=s[r]*i,c=o[r]*i;iN({source:t.subarray(n,h),target:e,start:a,end:c,size:i,getData:l}),n=h,a=c}a<e.length&&iN({source:[],target:e,start:a,size:i,getData:l})}({source:_,target:v,sourceStartIndices:o,targetStartIndices:p,size:l,getData:m}),(!e||e.byteLength<v.byteLength+c)&&(null==e||e.destroy(),e=t.createBuffer({byteLength:v.byteLength+c,usage:35050})),e.write(v,c),e}i(4871),i(4871);var iY=class{constructor({device:t,attribute:e,timeline:i}){this.buffers=[],this.currentLength=0,this.device=t,this.transition=new eV(i),this.attribute=e,this.attributeInTransition=function(t){let{device:e,settings:i,value:r}=t,s=new iU(e,i);return s.setData({value:r instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:i.normalized}),s}(e),this.currentStartIndices=e.startIndices}get inProgress(){return this.transition.inProgress}start(t,e,i=1/0){this.settings=t,this.currentStartIndices=this.attribute.startIndices,this.currentLength=function(t,e){let{doublePrecision:i,settings:r,value:s,size:o}=t,n=i&&s instanceof Float64Array?2:1,a=0,{shaderAttributes:l}=t.settings;if(l)for(let t of Object.values(l))a=Math.max(a,t.vertexOffset??0);return(r.noAlloc?s.length:(e+a)*o)*n}(this.attribute,e),this.transition.start({...t,duration:i})}update(){let t=this.transition.update();return t&&this.onUpdate(),t}setBuffer(t){this.attributeInTransition.setData({buffer:t,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){for(let t of(this.cancel(),this.buffers))t.destroy();this.buffers.length=0}},iq=class extends iY{constructor({device:t,attribute:e,timeline:i}){super({device:t,attribute:e,timeline:i}),this.type="interpolation",this.transform=function(t,e){let i=e.size,r=iB(i),s=i$(i),o=e.getBufferLayout();return iJ(e)?new iD.BufferTransform(t,{vs:iK,bufferLayout:[{name:"aFrom",byteStride:8*i,attributes:[{attribute:"aFrom",format:s,byteOffset:0},{attribute:"aFrom64Low",format:s,byteOffset:4*i}]},{name:"aTo",byteStride:8*i,attributes:[{attribute:"aTo",format:s,byteOffset:0},{attribute:"aTo64Low",format:s,byteOffset:4*i}]}],modules:[iF.fp64arithmetic,iH],defines:{ATTRIBUTE_TYPE:r,ATTRIBUTE_SIZE:i},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new iD.BufferTransform(t,{vs:iX,bufferLayout:[{name:"aFrom",format:s},{name:"aTo",format:o.attributes[0].format}],modules:[iH],defines:{ATTRIBUTE_TYPE:r},varyings:["vCurrent"],disableWarnings:!0})}(t,e)}start(t,e){let i=this.currentLength,r=this.currentStartIndices;if(super.start(t,e,t.duration),t.duration<=0)return void this.transition.cancel();let{buffers:s,attribute:o}=this;iG(s),s[0]=iZ({device:this.device,buffer:s[0],attribute:o,fromLength:i,toLength:this.currentLength,fromStartIndices:r,getData:t.enter}),s[1]=iW({device:this.device,source:s[0],target:s[1]}),this.setBuffer(s[1]);let{transform:n}=this,a=n.model,l=Math.floor(this.currentLength/o.size);iJ(o)&&(l/=2),a.setVertexCount(l),o.isConstant?(a.setAttributes({aFrom:s[0]}),a.setConstantAttributes({aTo:o.value})):a.setAttributes({aFrom:s[0],aTo:o.getBuffer()}),n.transformFeedback.setBuffers({vCurrent:s[1]})}onUpdate(){let{duration:t,easing:e}=this.settings,{time:i}=this.transition,r=i/t;e&&(r=e(r));let{model:s}=this.transform,o={time:r};s.shaderInputs.setProps({interpolation:o}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}},iH={name:"interpolation",vs:`uniform interpolationUniforms {
  float time;
} interpolation;
`,uniformTypes:{time:"f32"}},iX=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, interpolation.time);
  gl_Position = vec4(0.0);
}
`,iK=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function iJ(t){return t.doublePrecision&&t.value instanceof Float64Array}var iQ=i(6463),i0=class extends iY{constructor({device:t,attribute:e,timeline:i}){var r,s;super({device:t,attribute:e,timeline:i}),this.type="spring",this.texture=t.createTexture({data:new Uint8Array(4),format:"rgba8unorm",mipmaps:!1,width:1,height:1}),this.framebuffer=(r=t,s=this.texture,r.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[s]})),this.transform=function(t,e){let i=iB(e.size),r=i$(e.size);return new iQ.BufferTransform(t,{vs:i2,fs:i3,bufferLayout:[{name:"aPrev",format:r},{name:"aCur",format:r},{name:"aTo",format:e.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[i1],defines:{ATTRIBUTE_TYPE:i},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}(t,e)}start(t,e){let i=this.currentLength,r=this.currentStartIndices;super.start(t,e);let{buffers:s,attribute:o}=this;for(let e=0;e<2;e++)s[e]=iZ({device:this.device,buffer:s[e],attribute:o,fromLength:i,toLength:this.currentLength,fromStartIndices:r,getData:t.enter});s[2]=iW({device:this.device,source:s[0],target:s[2]}),this.setBuffer(s[1]);let{model:n}=this.transform;n.setVertexCount(Math.floor(this.currentLength/o.size)),o.isConstant?n.setConstantAttributes({aTo:o.value}):n.setAttributes({aTo:o.getBuffer()})}onUpdate(){let{buffers:t,transform:e,framebuffer:i,transition:r}=this,s=this.settings;e.model.setAttributes({aPrev:t[0],aCur:t[1]}),e.transformFeedback.setBuffers({vNext:t[2]});let o={stiffness:s.stiffness,damping:s.damping};e.model.shaderInputs.setProps({spring:o}),e.run({framebuffer:i,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),iG(t),this.setBuffer(t[1]),this.device.readPixelsToArrayWebGL(i)[0]>0||r.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}},i1={name:"spring",vs:`uniform springUniforms {
  float damping;
  float stiffness;
} spring;
`,uniformTypes:{damping:"f32",stiffness:"f32"}},i2=`#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE force = delta * spring.stiffness;
  ATTRIBUTE_TYPE resistance = velocity * spring.damping;
  return force - resistance + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,i3=`#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`,i4={interpolation:iq,spring:i0},i5=class{constructor(t,{id:e,timeline:i}){if(!t)throw Error("AttributeTransitionManager is constructed without device");this.id=e,this.device=t,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(let t in this.transitions)this._removeTransition(t)}update({attributes:t,transitions:e,numInstances:i}){for(let r in this.numInstances=i||1,t){let i=t[r],s=i.getTransitionSetting(e);s&&this._updateAttribute(r,i,s)}for(let i in this.transitions){let r=t[i];r&&r.getTransitionSetting(e)||this._removeTransition(i)}}hasAttribute(t){let e=this.transitions[t];return e&&e.inProgress}getAttributes(){let t={};for(let e in this.transitions){let i=this.transitions[e];i.inProgress&&(t[e]=i.attributeInTransition)}return t}run(){if(0===this.numInstances)return!1;for(let t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);let t=this.needsRedraw;return this.needsRedraw=!1,t}_removeTransition(t){this.transitions[t].delete(),delete this.transitions[t]}_updateAttribute(t,e,i){let r=this.transitions[t],s=!r||r.type!==i.type;if(s){r&&this._removeTransition(t);let o=i4[i.type];o?this.transitions[t]=new o({attribute:e,timeline:this.timeline,device:this.device}):(p.error(`unsupported transition type '${i.type}'`)(),s=!1)}(s||e.needsRedraw())&&(this.needsRedraw=!0,this.transitions[t].start(i,this.numInstances))}},i6="attributeManager.invalidate",i8=class{constructor(t,{id:e="attribute-manager",stats:i,timeline:r}={}){this.mergeBoundsMemoized=O(t$),this.id=e,this.device=t,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new i5(t,{id:`${e}-transitions`,timeline:r}),Object.seal(this)}finalize(){for(let t in this.attributes)this.attributes[t].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(t={clearRedrawFlags:!1}){let e=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!t.clearRedrawFlags,e&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(t){this._add(t)}addInstanced(t){this._add(t,{stepMode:"instance"})}remove(t){for(let e of t)void 0!==this.attributes[e]&&(this.attributes[e].delete(),delete this.attributes[e])}invalidate(t,e){let i=this._invalidateTrigger(t,e);g(i6,this,t,i)}invalidateAll(t){for(let e in this.attributes)this.attributes[e].setNeedsUpdate(e,t);g(i6,this,"all")}update({data:t,numInstances:e,startIndices:i=null,transitions:r,props:s={},buffers:o={},context:n={}}){let a=!1;for(let r in g("attributeManager.updateStart",this),this.stats&&this.stats.get("Update Attributes").timeStart(),this.attributes){let l=this.attributes[r],h=l.settings.accessor;l.startIndices=i,l.numInstances=e,s[r]&&p.removed(`props.${r}`,`data.attributes.${r}`)(),l.setExternalBuffer(o[r])||l.setBinaryValue("string"==typeof h?o[h]:void 0,t.startIndices)||"string"==typeof h&&!o[h]&&l.setConstantValue(s[h])||l.needsUpdate()&&(a=!0,this._updateAttribute({attribute:l,numInstances:e,data:t,props:s,context:n})),this.needsRedraw=this.needsRedraw||l.needsRedraw()}a&&g("attributeManager.updateEnd",this,e),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:e,transitions:r})}updateTransition(){let{attributeTransitionManager:t}=this,e=t.run();return this.needsRedraw=this.needsRedraw||e,e}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(t){let e=t.map(t=>{var e;return null==(e=this.attributes[t])?void 0:e.getBounds()});return this.mergeBoundsMemoized(e)}getChangedAttributes(t={clearChangedFlags:!1}){let{attributes:e,attributeTransitionManager:i}=this,r={...i.getAttributes()};for(let s in e){let o=e[s];o.needsRedraw(t)&&!i.hasAttribute(s)&&(r[s]=o)}return r}getBufferLayouts(t){return Object.values(this.getAttributes()).map(e=>e.getBufferLayout(t))}_add(t,e){for(let i in t){let r=t[i],s={...r,id:i,size:r.isIndexed&&1||r.size||1,...e};this.attributes[i]=new iU(this.device,s)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){let t={};for(let e in this.attributes)this.attributes[e].getUpdateTriggers().forEach(i=>{t[i]||(t[i]=[]),t[i].push(e)});this.updateTriggers=t}_invalidateTrigger(t,e){let{attributes:i,updateTriggers:r}=this,s=r[t];return s&&s.forEach(t=>{let r=i[t];r&&r.setNeedsUpdate(r.id,e)}),s}_updateAttribute(t){let{attribute:e,numInstances:i}=t;if(g("attribute.updateStart",e),e.constant)return void e.setConstantValue(e.value);e.allocate(i)&&g("attribute.allocate",e,i),e.updateBuffer(t)&&(this.needsRedraw=!0,g("attribute.updateEnd",e,i))}},i9=i(3957),i7=i(3431),rt=i(5595);function re(t,e,i,r,s){let o=e-t;return(i-e)*s+-o*r+o+e}function ri(t,e){if(Array.isArray(t)){let i=0;for(let r=0;r<t.length;r++){let s=t[r]-e[r];i+=s*s}return Math.sqrt(i)}return Math.abs(t-e)}var rr={interpolation:class extends eV{get value(){return this._value}_onUpdate(){let{time:t,settings:{fromValue:e,toValue:i,duration:r,easing:s}}=this,o=s(t/r);this._value=(0,rt.lerp)(e,i,o)}},spring:class extends eV{get value(){return this._currValue}_onUpdate(){let{fromValue:t,toValue:e,damping:i,stiffness:r}=this.settings,{_prevValue:s=t,_currValue:o=t}=this,n=function(t,e,i,r,s){if(Array.isArray(i)){let o=[];for(let n=0;n<i.length;n++)o[n]=re(t[n],e[n],i[n],r,s);return o}return re(t,e,i,r,s)}(s,o,e,i,r),a=ri(n,e),l=ri(n,o);a<1e-5&&l<1e-5&&(n=e,this.end()),this._prevValue=o,this._currValue=n}}},rs=class{constructor(t){this.transitions=new Map,this.timeline=t}get active(){return this.transitions.size>0}add(t,e,i,r){let{transitions:s}=this;if(s.has(t)){let i=s.get(t),{value:r=i.settings.fromValue}=i;e=r,this.remove(t)}if(!(r=iV(r)))return;let o=rr[r.type];if(!o)return void p.error(`unsupported transition type '${r.type}'`)();let n=new o(this.timeline);n.start({...r,fromValue:e,toValue:i}),s.set(t,n)}remove(t){let{transitions:e}=this;e.has(t)&&(e.get(t).cancel(),e.delete(t))}update(){let t={};for(let[e,i]of this.transitions)i.update(),t[e]=i.value,i.inProgress||this.remove(e);return t}clear(){for(let t of this.transitions.keys())this.remove(t)}};function ro({newProps:t,oldProps:e,ignoreProps:i={},propTypes:r={},triggerName:s="props"}){if(e===t)return!1;if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return`${s} changed shallowly`;for(let o of Object.keys(t))if(!(o in i)){if(!(o in e))return`${s}.${o} added`;let i=rn(t[o],e[o],r[o]);if(i)return`${s}.${o} ${i}`}for(let o of Object.keys(e))if(!(o in i)){if(!(o in t))return`${s}.${o} dropped`;if(!Object.hasOwnProperty.call(t,o)){let i=rn(t[o],e[o],r[o]);if(i)return`${s}.${o} ${i}`}}return!1}function rn(t,e,i){let r=i&&i.equal;return r&&!r(t,e,i)||!r&&(r=t&&e&&t.equals)&&!r.call(t,e)?"changed deeply":r||e===t?null:"changed shallowly"}function ra(t,e,i){let r=t.updateTriggers[i];r=null==r?{}:r;let s=e.updateTriggers[i];return ro({oldProps:s=null==s?{}:s,newProps:r,triggerName:i})}function rl(t){var e,i;if(null===(e=t)||"object"!=typeof e)throw Error("count(): argument not an object");if("function"==typeof t.count)return t.count();if(Number.isFinite(t.size))return t.size;if(Number.isFinite(t.length))return t.length;if(null!==(i=t)&&"object"==typeof i&&i.constructor===Object)return Object.keys(t).length;throw Error("count(): argument not a container")}function rh(t,e){if(!e)return t;let i={...t,...e};if("defines"in e&&(i.defines={...t.defines,...e.defines}),"modules"in e&&(i.modules=(t.modules||[]).concat(e.modules),e.modules.some(t=>"project64"===t.name))){let t=i.modules.findIndex(t=>"project32"===t.name);t>=0&&i.modules.splice(t,1)}if("inject"in e)if(t.inject){let r={...t.inject};for(let t in e.inject)r[t]=(r[t]||"")+e.inject[t];i.inject=r}else i.inject=e.inject;return i}var rc=i(3957),rp={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},rd={},ru={boolean:{validate:(t,e)=>!0,equal:(t,e,i)=>!!t==!!e},number:{validate:(t,e)=>Number.isFinite(t)&&(!("max"in e)||t<=e.max)&&(!("min"in e)||t>=e.min)},color:{validate:(t,e)=>e.optional&&!t||rg(t)&&(3===t.length||4===t.length),equal:(t,e,i)=>eC(t,e,1)},accessor:{validate(t,e){let i=rm(t);return"function"===i||i===rm(e.value)},equal:(t,e,i)=>"function"==typeof e||eC(t,e,1)},array:{validate:(t,e)=>e.optional&&!t||rg(t),equal(t,e,i){let{compare:r}=i,s=Number.isInteger(r)?r:+!!r;return r?eC(t,e,s):t===e}},object:{equal(t,e,i){if(i.ignore)return!0;let{compare:r}=i,s=Number.isInteger(r)?r:+!!r;return r?eC(t,e,s):t===e}},function:{validate:(t,e)=>e.optional&&!t||"function"==typeof t,equal:(t,e,i)=>!i.compare&&!1!==i.ignore||t===e},data:{transform:(t,e,i)=>{if(!t)return t;let{dataTransform:r}=i.props;return r?r(t):"string"==typeof t.shape&&t.shape.endsWith("-table")&&Array.isArray(t.data)?t.data:t}},image:{transform:(t,e,i)=>{let r=i.context;return r&&r.device?function(t,e,i,r){if(i instanceof rc.Texture)return i;i.constructor&&"Object"!==i.constructor.name&&(i={data:i});let s=null;i.compressed&&(s={minFilter:"linear",mipmapFilter:i.data.length>1?"nearest":"linear"});let o=e.createTexture({...i,sampler:{...rp,...s,...r},mipmaps:!0});return rd[o.id]=t,o}(i.id,r.device,t,{...e.parameters,...i.props.textureParameters}):null},release:(t,e,i)=>{!function(t,e){e&&e instanceof rc.Texture&&rd[e.id]===t&&(e.delete(),delete rd[e.id])}(i.id,t)}}};function rf(t,e){return"type"in e?{name:t,...ru[e.type],...e}:"value"in e?{name:t,type:rm(e.value),...e}:{name:t,type:"object",value:e}}function rg(t){return Array.isArray(t)||ArrayBuffer.isView(t)}function rm(t){return rg(t)?"array":null===t?"null":typeof t}function r_(t,e){return Object.prototype.hasOwnProperty.call(t,e)}var rv=0,rw=class{constructor(...t){this.props=function(t,e){let i;for(let t=e.length-1;t>=0;t--){let r=e[t];"extensions"in r&&(i=r.extensions)}let r=Object.create(function t(e,i){var r,s;if(!(e instanceof ry.constructor))return{};let o="_mergedDefaultProps";if(i)for(let t of i){let e=t.constructor;e&&(o+=`:${e.extensionName||e.name}`)}let n=r_(r=e,s=o)&&r[s];return n||(e[o]=function(e,i){if(!e.prototype)return null;let r=t(Object.getPrototypeOf(e)),s=function(t){let e={},i={},r={};for(let[s,o]of Object.entries(t)){let t=null==o?void 0:o.deprecatedFor;if(t)r[s]=Array.isArray(t)?t:[t];else{let t=function(t,e){switch(rm(e)){case"object":return rf(t,e);case"array":return rf(t,{type:"array",value:e,compare:!1});case"boolean":return rf(t,{type:"boolean",value:e});case"number":return rf(t,{type:"number",value:e});case"function":return rf(t,{type:"function",value:e,compare:!0});default:return{name:t,type:"unknown",value:e}}}(s,o);e[s]=t,i[s]=t.value}}return{propTypes:e,defaultProps:i,deprecatedProps:r}}(function(t,e){return r_(t,e)&&t[e]}(e,"defaultProps")||{}),o=Object.assign(Object.create(null),r,s.defaultProps),n=Object.assign(Object.create(null),null==r?void 0:r[ev],s.propTypes),a=Object.assign(Object.create(null),null==r?void 0:r[ew],s.deprecatedProps);for(let e of i){let i=t(e.constructor);i&&(Object.assign(o,i),Object.assign(n,i[ev]),Object.assign(a,i[ew]))}return Object.defineProperties(o,{id:{writable:!0,value:function(t){let e=t.componentName;return e||p.warn(`${t.name}.componentName not specified`)(),e||t.name}(e)}}),function(t,e){let i={},r={};for(let t in e){let s=e[t],{name:o,value:n}=s;s.async&&(i[o]=n,r[o]=function(t){return{enumerable:!0,set(e){"string"==typeof e||e instanceof Promise||iR(e)?this[eb][t]=e:this[eP][t]=e},get(){if(this[eP]){if(t in this[eP])return this[eP][t]||this[ey][t];if(t in this[eb]){let e=this[e_]&&this[e_].internalState;if(e&&e.hasAsyncProp(t))return e.getAsyncProp(t)||this[ey][t]}}return this[ey][t]}}}(o))}t[ey]=i,t[eb]={},Object.defineProperties(t,r)}(o,n),function(t,e){for(let i in e)Object.defineProperty(t,i,{enumerable:!1,set(t){let r=`${this.id}: ${i}`;for(let r of e[i])r_(this,r)||(this[r]=t);p.deprecated(r,e[i].join("/"))()}})}(o,a),o[ev]=n,o[ew]=a,0!==i.length||r_(e,"_propTypes")||(e._propTypes=n),o}(e,i||[]))}(t.constructor,i));r[e_]=t,r[eb]={},r[eP]={};for(let t=0;t<e.length;++t){let i=e[t];for(let t in i)r[t]=i[t]}return Object.freeze(r),r}(this,t),this.id=this.props.id,this.count=rv++}clone(t){let{props:e}=this,i={};for(let t in e[ey])t in e[eP]?i[t]=e[eP][t]:t in e[eb]&&(i[t]=e[eb][t]);return new this.constructor({...e,...i,...t})}};rw.componentName="Component",rw.defaultProps={};var ry=rw,rb=Object.freeze({}),rP=class{constructor(t){this.component=t,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(let t in this.asyncProps){let e=this.asyncProps[t];e&&e.type&&e.type.release&&e.type.release(e.resolvedValue,e.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||rb}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(t){return t in this.asyncProps}getAsyncProp(t){let e=this.asyncProps[t];return e&&e.resolvedValue}isAsyncPropLoading(t){if(t){let e=this.asyncProps[t];return!!(e&&e.pendingLoadCount>0&&e.pendingLoadCount!==e.resolvedLoadCount)}for(let t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(t,e){this._watchPromise(t,Promise.resolve(e))}setAsyncProps(t){this.component=t[e_]||this.component;let e=t[eP]||{},i=t[eb]||t,r=t[ey]||{};for(let t in e){let i=e[t];this._createAsyncPropData(t,r[t]),this._updateAsyncProp(t,i),e[t]=this.getAsyncProp(t)}for(let t in i){let e=i[t];this._createAsyncPropData(t,r[t]),this._updateAsyncProp(t,e)}}_fetch(t,e){return null}_onResolve(t,e){}_onError(t,e){}_updateAsyncProp(t,e){if(this._didAsyncInputValueChange(t,e)){if("string"==typeof e&&(e=this._fetch(t,e)),e instanceof Promise)return void this._watchPromise(t,e);if(iR(e))return void this._resolveAsyncIterable(t,e);this._setPropValue(t,e)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps)for(let t in this.oldAsyncProps=Object.create(this.oldProps),this.asyncProps)Object.defineProperty(this.oldAsyncProps,t,{enumerable:!0,value:this.oldProps[t]})}_didAsyncInputValueChange(t,e){let i=this.asyncProps[t];return e!==i.resolvedValue&&e!==i.lastValue&&(i.lastValue=e,!0)}_setPropValue(t,e){this._freezeAsyncOldProps();let i=this.asyncProps[t];i&&(e=this._postProcessValue(i,e),i.resolvedValue=e,i.pendingLoadCount++,i.resolvedLoadCount=i.pendingLoadCount)}_setAsyncPropValue(t,e,i){let r=this.asyncProps[t];r&&i>=r.resolvedLoadCount&&void 0!==e&&(this._freezeAsyncOldProps(),r.resolvedValue=e,r.resolvedLoadCount=i,this.onAsyncPropUpdated(t,e))}_watchPromise(t,e){let i=this.asyncProps[t];if(i){i.pendingLoadCount++;let r=i.pendingLoadCount;e.then(e=>{this.component&&(e=this._postProcessValue(i,e),this._setAsyncPropValue(t,e,r),this._onResolve(t,e))}).catch(e=>{this._onError(t,e)})}}async _resolveAsyncIterable(t,e){if("data"!==t)return void this._setPropValue(t,e);let i=this.asyncProps[t];if(!i)return;i.pendingLoadCount++;let r=i.pendingLoadCount,s=[],o=0;for await(let i of e){if(!this.component)return;let{dataTransform:e}=this.component.props;Object.defineProperty(s=e?e(i,s):s.concat(i),"__diff",{enumerable:!1,value:[{startRow:o,endRow:s.length}]}),o=s.length,this._setAsyncPropValue(t,s,r)}this._onResolve(t,s)}_postProcessValue(t,e){let i=t.type;return i&&this.component&&(i.release&&i.release(t.resolvedValue,i,this.component),i.transform)?i.transform(e,i,this.component):e}_createAsyncPropData(t,e){if(!this.asyncProps[t]){let i=this.component&&this.component.props[ev];this.asyncProps[t]={type:i&&i[t],lastValue:null,resolvedValue:e,pendingLoadCount:0,resolvedLoadCount:0}}}},rS=class extends rP{constructor({attributeManager:t,layer:e}){super(e),this.attributeManager=t,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(t,e){let i=this.layer,r=null==i?void 0:i.props.fetch;return r?r(e,{propName:t,layer:i}):super._fetch(t,e)}_onResolve(t,e){let i=this.layer;if(i){let r=i.props.onDataLoad;"data"===t&&r&&r(e,{propName:t,layer:i})}}_onError(t,e){let i=this.layer;i&&i.raiseError(e,`loading ${t} of ${this.layer}`)}},rM=i(261),rT=i(2489),rx=Object.freeze([]),rE=O(({oldViewport:t,viewport:e})=>t.equals(e)),rj=new Uint8ClampedArray(0),rA={data:{type:"data",value:rx,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:t=>t&&t.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(t,{propName:e,layer:i,loaders:r,loadOptions:s,signal:o})=>{let{resourceManager:n}=i.context;s=s||i.getLoadOptions(),r=r||i.props.loaders,o&&(s={...s,fetch:{...null==s?void 0:s.fetch,signal:o}});let a=n.contains(t);return(a||s||(n.add({resourceId:t,data:(0,rT.load)(t,r),persistent:!1}),a=!0),a)?n.subscribe({resourceId:t,onChange:t=>{var r;return null==(r=i.internalState)?void 0:r.reloadAsyncProp(e,t)},consumerId:i.id,requestId:e}):(0,rT.load)(t,r,s)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:E.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:t})=>[0,-(100*t)]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}},rC=class extends ry{constructor(){super(...arguments),this.internalState=null,this.lifecycle=em.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let t=this;for(;t.parent;)t=t.parent;return t}toString(){let t=this.constructor.layerName||this.constructor.name;return`${t}({id: '${this.props.id}'})`}project(t){eG(this.internalState);let e=this.internalState.viewport||this.context.viewport,i=t6(t,{viewport:e,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[r,s,o]=(0,rM.worldToPixels)(i,e.pixelProjectionMatrix);return 2===t.length?[r,s]:[r,s,o]}unproject(t){return eG(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(t)}projectPosition(t,e){return eG(this.internalState),t8(t,{viewport:this.internalState.viewport||this.context.viewport,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...e})}get isComposite(){return!1}get isDrawable(){return!0}setState(t){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,t),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return!!this.internalState&&!this.internalState.isAsyncPropLoading()}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){let t=this.state;return t&&(t.models||t.model&&[t.model])||[]}setShaderModuleProps(...t){for(let e of this.getModels())e.shaderInputs.setProps(...t)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){let{coordinateSystem:t}=this.props;return t===E.DEFAULT||t===E.LNGLAT||t===E.CARTESIAN}onHover(t,e){return!!this.props.onHover&&(this.props.onHover(t,e)||!1)}onClick(t,e){return!!this.props.onClick&&(this.props.onClick(t,e)||!1)}nullPickingColor(){return[0,0,0]}encodePickingColor(t,e=[]){return e[0]=t+1&255,e[1]=t+1>>8&255,e[2]=t+1>>8>>8&255,e}decodePickingColor(t){eG(t instanceof Uint8Array);let[e,i,r]=t;return e+256*i+65536*r-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&void 0!==this.state.numInstances?this.state.numInstances:rl(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var t;return null==(t=this.getAttributeManager())?void 0:t.getBounds(["positions","instancePositions"])}getShaders(t){for(let e of(t=rh(t,{disableWarnings:!0,modules:this.context.defaultShaderModules}),this.props.extensions))t=rh(t,e.getShaders.call(this,e));return t}shouldUpdateState(t){return t.changeFlags.propsOrDataChanged}updateState(t){let e=this.getAttributeManager(),{dataChanged:i}=t.changeFlags;if(i&&e)if(Array.isArray(i))for(let t of i)e.invalidateAll(t);else e.invalidateAll();if(e){let{props:i}=t,r=this.internalState.hasPickingBuffer,s=Number.isInteger(i.highlightedObjectIndex)||i.pickable||i.extensions.some(t=>t.getNeedsPickingBuffer.call(this,t));if(r!==s){this.internalState.hasPickingBuffer=s;let{pickingColors:t,instancePickingColors:i}=e.attributes,r=t||i;r&&(s&&r.constant&&(r.constant=!1,e.invalidate(r.id)),r.value||s||(r.constant=!0,r.value=[0,0,0]))}}}finalizeState(t){for(let t of this.getModels())t.destroy();let e=this.getAttributeManager();e&&e.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(t){for(let e of this.getModels())e.draw(t.renderPass)}getPickingInfo({info:t,mode:e,sourceLayer:i}){let{index:r}=t;return r>=0&&Array.isArray(this.props.data)&&(t.object=this.props.data[r]),t}raiseError(t,e){var i,r,s,o;e&&(t=Error(`${e}: ${t.message}`,{cause:t})),(null==(r=(i=this.props).onError)?void 0:r.call(i,t))||null==(o=null==(s=this.context)?void 0:s.onError)||o.call(s,t,this)}getNeedsRedraw(t={clearRedrawFlags:!1}){return this._getNeedsRedraw(t)}needsUpdate(){return!!this.internalState&&(this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()))}hasUniformTransition(){var t;return(null==(t=this.internalState)?void 0:t.uniformTransitions.active)||!1}activateViewport(t){if(!this.internalState)return;let e=this.internalState.viewport;this.internalState.viewport=t,e&&rE({oldViewport:e,viewport:t})||(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(t="all"){let e=this.getAttributeManager();e&&("all"===t?e.invalidateAll():e.invalidate(t))}updateAttributes(t){let e=!1;for(let i in t)t[i].layoutChanged()&&(e=!0);for(let i of this.getModels())this._setModelAttributes(i,t,e)}_updateAttributes(){let t=this.getAttributeManager();if(!t)return;let e=this.props,i=this.getNumInstances(),r=this.getStartIndices();t.update({data:e.data,numInstances:i,startIndices:r,props:e,transitions:e.transitions,buffers:e.data.attributes,context:this});let s=t.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(s)}_updateAttributeTransition(){let t=this.getAttributeManager();t&&t.updateTransition()}_updateUniformTransition(){let{uniformTransitions:t}=this.internalState;if(t.active){let e=t.update(),i=Object.create(this.props);for(let t in e)Object.defineProperty(i,t,{value:e[t]});return i}return this.props}calculateInstancePickingColors(t,{numInstances:e}){if(t.constant)return;let i=Math.floor(rj.length/4);if(this.internalState.usesPickingColorCache=!0,i<e){e>0xffffff&&p.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")();let t=Math.floor((rj=tk.allocate(rj,e,{size:4,copy:!0,maxCount:Math.max(e,0xffffff)})).length/4),r=[0,0,0];for(let e=i;e<t;e++)this.encodePickingColor(e,r),rj[4*e+0]=r[0],rj[4*e+1]=r[1],rj[4*e+2]=r[2],rj[4*e+3]=0}t.value=rj.subarray(0,4*e)}_setModelAttributes(t,e,i=!1){var r;if(!Object.keys(e).length)return;if(i){let i=this.getAttributeManager();t.setBufferLayout(i.getBufferLayouts(t)),e=i.getAttributes()}let s=(null==(r=t.userData)?void 0:r.excludeAttributes)||{},o={},n={};for(let i in e){if(s[i])continue;let r=e[i].getValue();for(let s in r){let a=r[s];a instanceof i9.Buffer?e[i].settings.isIndexed?t.setIndexBuffer(a):o[s]=a:a&&(n[s]=a)}}t.setAttributes(o),t.setConstantAttributes(n)}disablePickingIndex(t){let e=this.props.data;if(!("attributes"in e))return void this._disablePickingIndex(t);let{pickingColors:i,instancePickingColors:r}=this.getAttributeManager().attributes,s=i||r,o=s&&e.attributes&&e.attributes[s.id];if(o&&o.value){let i=o.value,r=this.encodePickingColor(t);for(let t=0;t<e.length;t++){let e=s.getVertexOffset(t);i[e]===r[0]&&i[e+1]===r[1]&&i[e+2]===r[2]&&this._disablePickingIndex(t)}}else this._disablePickingIndex(t)}_disablePickingIndex(t){let{pickingColors:e,instancePickingColors:i}=this.getAttributeManager().attributes,r=e||i;if(!r)return;let s=r.getVertexOffset(t),o=r.getVertexOffset(t+1);r.buffer.write(new Uint8Array(o-s),s)}restorePickingColors(){let{pickingColors:t,instancePickingColors:e}=this.getAttributeManager().attributes,i=t||e;i&&(this.internalState.usesPickingColorCache&&i.value.buffer!==rj.buffer&&(i.value=rj.subarray(0,i.value.length)),i.updateSubBuffer({startOffset:0}))}_initialize(){eG(!this.internalState),eG(Number.isFinite(this.props.coordinateSystem)),g("layer.initialize",this);let t=this._getAttributeManager();for(let e of(t&&t.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new rS({attributeManager:t,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(p.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),t)}),this.internalState.uniformTransitions=new rs(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context),this.props.extensions))e.initializeState.call(this,this.context,e);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(t){g("layer.matched",this,this===t);let{state:e,internalState:i}=t;this!==t&&(this.internalState=i,this.state=e,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){let t=this.needsUpdate();if(g("layer.update",this,t),!t)return;let e=this.props,i=this.context,r=this.internalState,s=i.viewport,o=this._updateUniformTransition();r.propsInTransition=o,i.viewport=r.viewport||s,this.props=o;try{let t=this._getUpdateParams(),e=this.getModels();if(i.device)this.updateState(t);else try{this.updateState(t)}catch(t){}for(let e of this.props.extensions)e.updateState.call(this,t,e);this.setNeedsRedraw(),this._updateAttributes();let r=this.getModels()[0]!==e[0];this._postUpdate(t,r)}finally{i.viewport=s,this.props=e,this._clearChangeFlags(),r.needsUpdate=!1,r.resetOldProps()}}_finalize(){for(let t of(g("layer.finalize",this),this.finalizeState(this.context),this.props.extensions))t.finalizeState.call(this,this.context,t)}_drawLayer({renderPass:t,shaderModuleProps:e=null,uniforms:i={},parameters:r={}}){this._updateAttributeTransition();let s=this.props,o=this.context;this.props=this.internalState.propsInTransition||s;try{e&&this.setShaderModuleProps(e);let{getPolygonOffset:s}=this.props,n=s&&s(i)||[0,0];for(let t of(o.device instanceof i7.WebGLDevice&&o.device.setParametersWebGL({polygonOffset:n}),this.getModels()))"webgpu"===t.device.type?t.setParameters({...t.parameters,...r}):t.setParameters(r);if(o.device instanceof i7.WebGLDevice)o.device.withParametersWebGL(r,()=>{let s={renderPass:t,shaderModuleProps:e,uniforms:i,parameters:r,context:o};for(let t of this.props.extensions)t.draw.call(this,s,t);this.draw(s)});else{let s={renderPass:t,shaderModuleProps:e,uniforms:i,parameters:r,context:o};for(let t of this.props.extensions)t.draw.call(this,s,t);this.draw(s)}}finally{this.props=s}}getChangeFlags(){var t;return null==(t=this.internalState)?void 0:t.changeFlags}setChangeFlags(t){if(!this.internalState)return;let{changeFlags:e}=this.internalState;for(let i in t)if(t[i]){let r=!1;if("dataChanged"===i){let s=t[i],o=e[i];s&&Array.isArray(o)&&(e.dataChanged=Array.isArray(s)?o.concat(s):s,r=!0)}e[i]||(e[i]=t[i],r=!0),r&&g("layer.changeFlag",this,i,t)}let i=!!(e.dataChanged||e.updateTriggersChanged||e.propsChanged||e.extensionsChanged);e.propsOrDataChanged=i,e.somethingChanged=i||e.viewportChanged||e.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(t,e){var i;let r=function(t,e){let i=ro({newProps:t,oldProps:e,propTypes:t[ev],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),r=function(t,e){if(null===e)return"oldProps is null, initial diff";let i=!1,{dataComparator:r,_dataDiff:s}=t;return r?r(t.data,e.data)||(i="Data comparator detected a change"):t.data!==e.data&&(i="A new data container was supplied"),i&&s&&(i=s(t.data,e.data)||i),i}(t,e),s=!1;return r||(s=function(t,e){if(null===e||"all"in t.updateTriggers&&ra(t,e,"all"))return{all:!0};let i={},r=!1;for(let s in t.updateTriggers)"all"!==s&&ra(t,e,s)&&(i[s]=!0,r=!0);return!!r&&i}(t,e)),{dataChanged:r,propsChanged:i,updateTriggersChanged:s,extensionsChanged:function(t,e){if(null===e)return!0;let i=e.extensions,{extensions:r}=t;if(r===i)return!1;if(!i||!r||r.length!==i.length)return!0;for(let t=0;t<r.length;t++)if(!r[t].equals(i[t]))return!0;return!1}(t,e),transitionsChanged:function(t,e){if(!t.transitions)return!1;let i={},r=t[ev],s=!1;for(let o in t.transitions){let n=r[o],a=n&&n.type;("number"===a||"color"===a||"array"===a)&&rn(t[o],e[o],n)&&(i[o]=!0,s=!0)}return!!s&&i}(t,e)}}(t,e);if(r.updateTriggersChanged)for(let t in r.updateTriggersChanged)r.updateTriggersChanged[t]&&this.invalidateAttribute(t);if(r.transitionsChanged)for(let s in r.transitionsChanged)this.internalState.uniformTransitions.add(s,e[s],t[s],null==(i=t.transitions)?void 0:i[s]);return this.setChangeFlags(r)}validateProps(){!function(t){let e=t[ev];for(let i in e){let r=e[i],{validate:s}=r;if(s&&!s(t[i],r))throw Error(`Invalid prop ${i}: ${t[i]}`)}}(this.props)}updateAutoHighlight(t){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(t)}_updateAutoHighlight(t){let e={highlightedObjectColor:t.picked?t.color:null},{highlightColor:i}=this.props;t.picked&&"function"==typeof i&&(e.highlightColor=i(t)),this.setShaderModuleProps({picking:e}),this.setNeedsRedraw()}_getAttributeManager(){let t=this.context;return new i8(t.device,{id:this.props.id,stats:t.stats,timeline:t.timeline})}_postUpdate(t,e){let{props:i,oldProps:r}=t,s=this.state.model;(null==s?void 0:s.isInstanced)&&s.setInstanceCount(this.getNumInstances());let{autoHighlight:o,highlightedObjectIndex:n,highlightColor:a}=i;if(e||r.autoHighlight!==o||r.highlightedObjectIndex!==n||r.highlightColor!==a){let t={};Array.isArray(a)&&(t.highlightColor=a),(e||r.autoHighlight!==o||n!==r.highlightedObjectIndex)&&(t.highlightedObjectColor=Number.isFinite(n)&&n>=0?this.encodePickingColor(n):null),this.setShaderModuleProps({picking:t})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(t){if(!this.internalState)return!1;let e=!1;e=this.internalState.needsRedraw&&this.id;let i=this.getAttributeManager(),r=!!i&&i.getNeedsRedraw(t);if(e=e||r)for(let t of this.props.extensions)t.onNeedsRedraw.call(this,t);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!t.clearRedrawFlags,e}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}};rC.defaultProps=rA,rC.layerName="Layer";var rL=rC,rR=class extends rL{get isComposite(){return!0}get isDrawable(){return!1}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(t=>t.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(t){}setState(t){super.setState(t),this.setNeedsUpdate()}getPickingInfo({info:t}){let{object:e}=t;return e&&e.__source&&e.__source.parent&&e.__source.parent.id===this.id&&(t.object=e.__source.object,t.index=e.__source.index),t}filterSubLayer(t){return!0}shouldRenderSubLayer(t,e){return e&&e.length}getSubLayerClass(t,e){let{_subLayerProps:i}=this.props;return i&&i[t]&&i[t].type||e}getSubLayerRow(t,e,i){return t.__source={parent:this,object:e,index:i},t}getSubLayerAccessor(t){if("function"==typeof t){let e={index:-1,data:this.props.data,target:[]};return(i,r)=>i&&i.__source?(e.index=i.__source.index,t(i.__source.object,e)):t(i,r)}return t}getSubLayerProps(t={}){var e;let{opacity:i,pickable:r,visible:s,parameters:o,getPolygonOffset:n,highlightedObjectIndex:a,autoHighlight:l,highlightColor:h,coordinateSystem:c,coordinateOrigin:p,wrapLongitude:d,positionFormat:u,modelMatrix:f,extensions:g,fetch:m,operation:_,_subLayerProps:v}=this.props,w={id:"",updateTriggers:{},opacity:i,pickable:r,visible:s,parameters:o,getPolygonOffset:n,highlightedObjectIndex:a,autoHighlight:l,highlightColor:h,coordinateSystem:c,coordinateOrigin:p,wrapLongitude:d,positionFormat:u,modelMatrix:f,extensions:g,fetch:m,operation:_},y=v&&t.id&&v[t.id],b=y&&y.updateTriggers,P=t.id||"sublayer";if(y){let e=this.props[ev],i=t.type?t.type._propTypes:{};for(let t in y){let r=i[t]||e[t];r&&"accessor"===r.type&&(y[t]=this.getSubLayerAccessor(y[t]))}}for(let i of(Object.assign(w,t,y),w.id=`${this.props.id}-${P}`,w.updateTriggers={all:null==(e=this.props.updateTriggers)?void 0:e.all,...t.updateTriggers,...b},g)){let t=i.getSubLayerProps.call(this,i);t&&Object.assign(w,t,{updateTriggers:Object.assign(w.updateTriggers,t.updateTriggers)})}return w}_updateAutoHighlight(t){for(let e of this.getSubLayers())e.updateAutoHighlight(t)}_getAttributeManager(){return null}_postUpdate(t,e){let i=this.internalState.subLayers,r=!i||this.needsUpdate();for(let t of(r&&(i=eS(this.renderLayers(),Boolean),this.internalState.subLayers=i),g("compositeLayer.renderLayers",this,r,i),i))t.parent=this}};rR.layerName="CompositeLayer";var rO=rR,rI=i(5595),rk=i(261),rz=i(261),rV=i(5595),rU=Math.PI/180,rD=180/Math.PI,rF=class extends tK{constructor(t={}){let{longitude:e=0,zoom:i=0,nearZMultiplier:r=.5,farZMultiplier:s=1,resolution:o=10}=t,{latitude:n=0,height:a,altitude:l=1.5,fovy:h}=t;n=Math.max(Math.min(n,rz.MAX_LATITUDE),-rz.MAX_LATITUDE),a=a||1,h?l=(0,rk.fovyToAltitude)(h):h=(0,rk.altitudeToFovy)(l);let c=1/Math.PI/Math.cos(n*Math.PI/180)*Math.pow(2,i),p=t.nearZ??r,d=t.farZ??(l+512*c/a)*s,u=new rI.Matrix4().lookAt({eye:[0,-l,0],up:[0,0,1]});u.rotateX(n*rU),u.rotateZ(-e*rU),u.scale(c/a),super({...t,height:a,viewMatrix:u,longitude:e,latitude:n,zoom:i,distanceScales:function(){let t=Math.PI/180*256;return{unitsPerMeter:[4018225162502676e-20,4018225162502676e-20,4018225162502676e-20],unitsPerMeter2:[0,0,0],metersPerUnit:[24886.609375,24886.609375,24886.609375],unitsPerDegree:[t,t,4018225162502676e-20],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/t,1/t,24886.609375]}}(),fovy:h,focalDistance:l,near:p,far:d}),this.scale=c,this.latitude=n,this.longitude=e,this.resolution=o}get projectionMode(){return j.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(t={}){let e={targetZ:t.z||0},i=this.unproject([0,this.height/2],e),r=this.unproject([this.width/2,0],e),s=this.unproject([this.width,this.height/2],e),o=this.unproject([this.width/2,this.height],e);return s[0]<this.longitude&&(s[0]+=360),i[0]>this.longitude&&(i[0]-=360),[Math.min(i[0],s[0],r[0],o[0]),Math.min(i[1],s[1],r[1],o[1]),Math.max(i[0],s[0],r[0],o[0]),Math.max(i[1],s[1],r[1],o[1])]}unproject(t,{topLeft:e=!0,targetZ:i}={}){let r,[s,o,n]=t,a=e?o:this.height-o,{pixelUnprojectionMatrix:l}=this;if(Number.isFinite(n))r=rN(l,[s,a,n,1]);else{let t=rN(l,[s,a,-1,1]),e=rN(l,[s,a,1,1]),o=((i||0)/6370972+1)*256,n=rV.vec3.sqrLen(rV.vec3.sub([],t,e)),h=rV.vec3.sqrLen(t),c=rV.vec3.sqrLen(e),p=(4*h*c-(n-h-c)**2)/16*4/n,d=(Math.sqrt(h-p)-Math.sqrt(Math.max(0,o*o-p)))/Math.sqrt(n);r=rV.vec3.lerp([],t,e,d)}let[h,c,p]=this.unprojectPosition(r);return Number.isFinite(n)?[h,c,p]:Number.isFinite(i)?[h,c,i]:[h,c]}projectPosition(t){let[e,i,r=0]=t,s=e*rU,o=i*rU,n=Math.cos(o),a=(r/6370972+1)*256;return[Math.sin(s)*n*a,-Math.cos(s)*n*a,Math.sin(o)*a]}unprojectPosition(t){let[e,i,r]=t,s=rV.vec3.len(t);return[Math.atan2(e,-i)*rD,Math.asin(r/s)*rD,(s/256-1)*6370972]}projectFlat(t){return t}unprojectFlat(t){return t}panByPosition(t,e){let i=this.unproject(e);return{longitude:t[0]-i[0]+this.longitude,latitude:t[1]-i[1]+this.latitude}}};function rN(t,e){let i=rV.vec4.transformMat4([],e,t);return rV.vec4.scale(i,i,1/i[3]),i}var rB=i(5595),r$=i(261),rG=Math.PI/180,rW=class extends tK{constructor(t){let{height:e,projectionMatrix:i,fovy:r=50,orbitAxis:s="Z",target:o=[0,0,0],rotationX:n=0,rotationOrbit:a=0,zoom:l=0}=t,h=i?i[5]/2:(0,r$.fovyToAltitude)(r);super({...t,longitude:void 0,viewMatrix:function({height:t,focalDistance:e,orbitAxis:i,rotationX:r,rotationOrbit:s,zoom:o}){let n=new rB.Matrix4().lookAt({eye:"Z"===i?[0,-e,0]:[0,0,e],up:"Z"===i?[0,0,1]:[0,1,0]});n.rotateX(r*rG),"Z"===i?n.rotateZ(s*rG):n.rotateY(s*rG);let a=Math.pow(2,o)/t;return n.scale(a),n}({height:e||1,focalDistance:h,orbitAxis:s,rotationX:n,rotationOrbit:a,zoom:l}),fovy:r,focalDistance:h,position:o,zoom:l}),this.projectedCenter=this.project(this.center)}unproject(t,{topLeft:e=!0}={}){let[i,r,s=this.projectedCenter[2]]=t,o=e?r:this.height-r,[n,a,l]=(0,r$.pixelsToWorld)([i,o,s],this.pixelUnprojectionMatrix);return[n,a,l]}panByPosition(t,e){let i=this.project(t),r=[this.width/2+i[0]-e[0],this.height/2+i[1]-e[1],this.projectedCenter[2]];return{target:this.unproject(r)}}},rZ=i(5595),rY=i(261),rq=new rZ.Matrix4().lookAt({eye:[0,0,1]}),rH=class extends tK{constructor(t){let e,{width:i,height:r,near:s=.1,far:o=1e3,zoom:n=0,target:a=[0,0,0],padding:l=null,flipY:h=!0}=t,c=Array.isArray(n)?n[0]:n,p=Array.isArray(n)?n[1]:n,d=Math.min(c,p),u=Math.pow(2,d);if(c!==p){let t=Math.pow(2,c),i=Math.pow(2,p);e={unitsPerMeter:[t/u,i/u,1],metersPerUnit:[u/t,u/i,1]}}super({...t,longitude:void 0,position:a,viewMatrix:rq.clone().scale([u,u*(h?-1:1),u]),projectionMatrix:function({width:t,height:e,near:i,far:r,padding:s}){let o=-t/2,n=t/2,a=-e/2,l=e/2;if(s){let{left:i=0,right:r=0,top:h=0,bottom:c=0}=s,p=(0,rZ.clamp)((i+t-r)/2,0,t)-t/2,d=(0,rZ.clamp)((h+e-c)/2,0,e)-e/2;o-=p,n-=p,a+=d,l+=d}return new rZ.Matrix4().ortho({left:o,right:n,bottom:a,top:l,near:i,far:r})}({width:i||1,height:r||1,padding:l,near:s,far:o}),zoom:d,distanceScales:e})}projectFlat([t,e]){let{unitsPerMeter:i}=this.distanceScales;return[t*i[0],e*i[1]]}unprojectFlat([t,e]){let{metersPerUnit:i}=this.distanceScales;return[t*i[0],e*i[1]]}panByPosition(t,e){let i=(0,rY.pixelsToWorld)(e,this.pixelUnprojectionMatrix),r=this.projectFlat(t),s=rZ.vec2.add([],r,rZ.vec2.negate([],i)),o=rZ.vec2.add([],this.center,s);return{target:this.unprojectFlat(o)}}},rX=i(261),rK=i(5595),rJ=class extends tK{constructor(t){let{longitude:e,latitude:i,modelMatrix:r,bearing:s=0,pitch:o=0,up:n=[0,0,1]}=t,a=new rK._SphericalCoordinates({bearing:s,pitch:-90===o?1e-4:90+o}).toVector3().normalize(),l=r?new rK.Matrix4(r).transformAsVector(a):a,h=Number.isFinite(i)?(0,rX.getMeterZoom)({latitude:i}):0;super({...t,zoom:h,viewMatrix:new rK.Matrix4().lookAt({eye:[0,0,0],center:l,up:n}).scale(Math.pow(2,h))}),this.latitude=i,this.longitude=e}},rQ=i(5595),r0=class extends e1{constructor(t){let{width:e,height:i,position:r=[0,0,0],bearing:s=0,pitch:o=0,longitude:n=null,latitude:a=null,maxPitch:l=90,minPitch:h=-90,startRotatePos:c,startBearing:p,startPitch:d,startZoomPosition:u,startPanPos:f,startPanPosition:g}=t;super({width:e,height:i,position:r,bearing:s,pitch:o,longitude:n,latitude:a,maxPitch:l,minPitch:h},{startRotatePos:c,startBearing:p,startPitch:d,startZoomPosition:u,startPanPos:f,startPanPosition:g}),this.makeViewport=t.makeViewport}panStart({pos:t}){let{position:e}=this.getViewportProps();return this._getUpdatedState({startPanPos:t,startPanPosition:e})}pan({pos:t}){if(!t)return this;let{startPanPos:e=[0,0],startPanPosition:i=[0,0]}=this.getState(),{width:r,height:s,bearing:o,pitch:n}=this.getViewportProps(),a=500*(t[0]-e[0])/r,l=500*(t[1]-e[1])/s,h=new rQ._SphericalCoordinates({bearing:o,pitch:n}),c=new rQ._SphericalCoordinates({bearing:o,pitch:-90}),p=h.toVector3().normalize(),d=c.toVector3().cross(p).normalize();return this._getUpdatedState({position:new rQ.Vector3(i).add(d.scale(a)).add(p.scale(l))})}panEnd(){return this._getUpdatedState({startPanPos:null,startPanPosition:null})}rotateStart({pos:t}){return this._getUpdatedState({startRotatePos:t,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:t,deltaAngleX:e=0,deltaAngleY:i=0}){let r,{startRotatePos:s,startBearing:o,startPitch:n}=this.getState(),{width:a,height:l}=this.getViewportProps();return s&&void 0!==o&&void 0!==n?(r=t?{bearing:o-180*((t[0]-s[0])/a),pitch:n-90*((t[1]-s[1])/l)}:{bearing:o-e,pitch:n-i},this._getUpdatedState(r)):this}rotateEnd(){return this._getUpdatedState({startRotatePos:null,startBearing:null,startPitch:null})}zoomStart(){return this._getUpdatedState({startZoomPosition:this.getViewportProps().position})}zoom({pos:t,scale:e}){let i=this.getViewportProps(),r=this.getState().startZoomPosition||i.position,{projectionMatrix:s,width:o}=this.makeViewport(i),n=2*Math.atan(1/s[0])*(t[0]/o-.5),a=this.getDirection(!0);return this._move(a.rotateZ({radians:-n}),20*Math.log2(e),r)}zoomEnd(){return this._getUpdatedState({startZoomPosition:null})}moveLeft(t=20){let e=this.getDirection(!0);return this._move(e.rotateZ({radians:Math.PI/2}),t)}moveRight(t=20){let e=this.getDirection(!0);return this._move(e.rotateZ({radians:-Math.PI/2}),t)}moveUp(t=20){let e=this.getDirection(!0);return this._move(e,t)}moveDown(t=20){let e=this.getDirection(!0);return this._move(e.negate(),t)}rotateLeft(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-t})}rotateRight(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+t})}rotateUp(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+t})}rotateDown(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-t})}zoomIn(t=20){return this._move(new rQ.Vector3(0,0,1),t)}zoomOut(t=20){return this._move(new rQ.Vector3(0,0,-1),t)}shortestPathFrom(t){let e=t.getViewportProps(),i={...this.getViewportProps()},{bearing:r,longitude:s}=i;return Math.abs(r-e.bearing)>180&&(i.bearing=r<0?r+360:r-360),null!==s&&null!==e.longitude&&Math.abs(s-e.longitude)>180&&(i.longitude=s<0?s+360:s-360),i}_move(t,e,i=this.getViewportProps().position){let r=t.scale(e);return this._getUpdatedState({position:new rQ.Vector3(i).add(r)})}getDirection(t=!1){return new rQ._SphericalCoordinates({bearing:this.getViewportProps().bearing,pitch:t?90:90+this.getViewportProps().pitch}).toVector3().normalize()}_getUpdatedState(t){return new r0({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...t})}applyConstraints(t){let{pitch:e,maxPitch:i,minPitch:r,longitude:s,bearing:o}=t;return t.pitch=(0,rQ.clamp)(e,r,i),null!==s&&(s<-180||s>180)&&(t.longitude=tU(s+180,360)-180),(o<-180||o>180)&&(t.bearing=tU(o+180,360)-180),t}},r1=class extends e0{constructor(){super(...arguments),this.ControllerState=r0,this.transition={transitionDuration:300,transitionInterpolator:new eH(["position","pitch","bearing"])}}},r2=class extends ek{constructor(t={}){super(t)}getViewportType(){return rJ}get ControllerType(){return r1}};r2.displayName="FirstPersonView";var r3=r2,r4=i(5595),r5=class extends e1{constructor(t){let{width:e,height:i,rotationX:r=0,rotationOrbit:s=0,target:o=[0,0,0],zoom:n=0,minRotationX:a=-90,maxRotationX:l=90,minZoom:h=-1/0,maxZoom:c=1/0,startPanPosition:p,startRotatePos:d,startRotationX:u,startRotationOrbit:f,startZoomPosition:g,startZoom:m}=t;super({width:e,height:i,rotationX:r,rotationOrbit:s,target:o,zoom:n,minRotationX:a,maxRotationX:l,minZoom:h,maxZoom:c},{startPanPosition:p,startRotatePos:d,startRotationX:u,startRotationOrbit:f,startZoomPosition:g,startZoom:m}),this.makeViewport=t.makeViewport}panStart({pos:t}){return this._getUpdatedState({startPanPosition:this._unproject(t)})}pan({pos:t,startPosition:e}){let i=this.getState().startPanPosition||e;if(!i)return this;let r=this.makeViewport(this.getViewportProps()).panByPosition(i,t);return this._getUpdatedState(r)}panEnd(){return this._getUpdatedState({startPanPosition:null})}rotateStart({pos:t}){return this._getUpdatedState({startRotatePos:t,startRotationX:this.getViewportProps().rotationX,startRotationOrbit:this.getViewportProps().rotationOrbit})}rotate({pos:t,deltaAngleX:e=0,deltaAngleY:i=0}){let r,{startRotatePos:s,startRotationX:o,startRotationOrbit:n}=this.getState(),{width:a,height:l}=this.getViewportProps();if(!s||void 0===o||void 0===n)return this;if(t){let e=(t[0]-s[0])/a;(o<-90||o>90)&&(e*=-1),r={rotationX:o+180*((t[1]-s[1])/l),rotationOrbit:n+180*e}}else r={rotationX:o+i,rotationOrbit:n+e};return this._getUpdatedState(r)}rotateEnd(){return this._getUpdatedState({startRotationX:null,startRotationOrbit:null})}shortestPathFrom(t){let e=t.getViewportProps(),i={...this.getViewportProps()},{rotationOrbit:r}=i;return Math.abs(r-e.rotationOrbit)>180&&(i.rotationOrbit=r<0?r+360:r-360),i}zoomStart({pos:t}){return this._getUpdatedState({startZoomPosition:this._unproject(t),startZoom:this.getViewportProps().zoom})}zoom({pos:t,startPos:e,scale:i}){let{startZoom:r,startZoomPosition:s}=this.getState();if(s||(r=this.getViewportProps().zoom,s=this._unproject(e)||this._unproject(t)),!s)return this;let o=this._calculateNewZoom({scale:i,startZoom:r}),n=this.makeViewport({...this.getViewportProps(),zoom:o});return this._getUpdatedState({zoom:o,...n.panByPosition(s,t)})}zoomEnd(){return this._getUpdatedState({startZoomPosition:null,startZoom:null})}zoomIn(t=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:t})})}zoomOut(t=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:1/t})})}moveLeft(t=50){return this._panFromCenter([-t,0])}moveRight(t=50){return this._panFromCenter([t,0])}moveUp(t=50){return this._panFromCenter([0,-t])}moveDown(t=50){return this._panFromCenter([0,t])}rotateLeft(t=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit-t})}rotateRight(t=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit+t})}rotateUp(t=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX-t})}rotateDown(t=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX+t})}_unproject(t){let e=this.makeViewport(this.getViewportProps());return t&&e.unproject(t)}_calculateNewZoom({scale:t,startZoom:e}){let{maxZoom:i,minZoom:r}=this.getViewportProps();void 0===e&&(e=this.getViewportProps().zoom);let s=e+Math.log2(t);return(0,r4.clamp)(s,r,i)}_panFromCenter(t){let{width:e,height:i,target:r}=this.getViewportProps();return this.pan({startPosition:r,pos:[e/2+t[0],i/2+t[1]]})}_getUpdatedState(t){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...t})}applyConstraints(t){let{maxZoom:e,minZoom:i,zoom:r,maxRotationX:s,minRotationX:o,rotationOrbit:n}=t;return t.zoom=Array.isArray(r)?[(0,r4.clamp)(r[0],i,e),(0,r4.clamp)(r[1],i,e)]:(0,r4.clamp)(r,i,e),t.rotationX=(0,r4.clamp)(t.rotationX,o,s),(n<-180||n>180)&&(t.rotationOrbit=tU(n+180,360)-180),t}},r6=class extends e0{constructor(){super(...arguments),this.ControllerState=r5,this.transition={transitionDuration:300,transitionInterpolator:new eH({transitionProps:{compare:["target","zoom","rotationX","rotationOrbit"],required:["target","zoom"]}})}}},r8=class extends ek{constructor(t={}){super(t),this.props.orbitAxis=t.orbitAxis||"Z"}getViewportType(){return rW}get ControllerType(){return r6}};r8.displayName="OrbitView";var r9=r8,r7=i(5595),st=class extends r5{constructor(t){super(t),this.zoomAxis=t.zoomAxis||"all"}_calculateNewZoom({scale:t,startZoom:e}){let{maxZoom:i,minZoom:r}=this.getViewportProps();void 0===e&&(e=this.getViewportProps().zoom);let s=Math.log2(t);if(Array.isArray(e)){let[t,o]=e;switch(this.zoomAxis){case"X":t=(0,r7.clamp)(t+s,r,i);break;case"Y":o=(0,r7.clamp)(o+s,r,i);break;default:let n=Math.min(t+s,o+s);n<r&&(s+=r-n),(n=Math.max(t+s,o+s))>i&&(s+=i-n),t+=s,o+=s}return[t,o]}return(0,r7.clamp)(e+s,r,i)}},se=class extends e0{constructor(){super(...arguments),this.ControllerState=st,this.transition={transitionDuration:300,transitionInterpolator:new eH(["target","zoom"])},this.dragMode="pan"}_onPanRotate(){return!1}},si=class extends ek{constructor(t={}){super(t)}getViewportType(){return rH}get ControllerType(){return se}};si.displayName="OrthographicView";var sr=si,ss=i(5595),so=i(261),sn=class extends e3{applyConstraints(t){let{maxZoom:e,minZoom:i,zoom:r}=t;t.zoom=(0,ss.clamp)(r,i,e);let{longitude:s,latitude:o}=t;return(s<-180||s>180)&&(t.longitude=tU(s+180,360)-180),t.latitude=(0,ss.clamp)(o,-so.MAX_LATITUDE,so.MAX_LATITUDE),t}},sa=class extends e0{constructor(){super(...arguments),this.ControllerState=sn,this.transition={transitionDuration:300,transitionInterpolator:new eH(["longitude","latitude","zoom"])},this.dragMode="pan"}setProps(t){super.setProps(t),this.dragRotate=!1,this.touchRotate=!1}},sl=class extends ek{constructor(t={}){super(t)}getViewportType(t){return t.zoom>12?t1:rF}get ControllerType(){return sa}};sl.displayName="GlobeView";var sh=sl,sc=class{static get componentName(){return Object.prototype.hasOwnProperty.call(this,"extensionName")?this.extensionName:""}constructor(t){t&&(this.opts=t)}equals(t){return this===t||this.constructor===t.constructor&&eC(this.opts,t.opts,1)}getShaders(t){return null}getSubLayerProps(t){let{defaultProps:e}=t.constructor,i={updateTriggers:{}};for(let t in e)if(t in this.props){let r=e[t],s=this.props[t];i[t]=s,r&&"accessor"===r.type&&(i.updateTriggers[t]=this.props.updateTriggers[t],"function"==typeof s&&(i[t]=this.getSubLayerAccessor(s)))}return i}initializeState(t,e){}updateState(t,e){}onNeedsRedraw(t){}getNeedsPickingBuffer(t){return!1}draw(t,e){}finalizeState(t,e){}};sc.defaultProps={},sc.extensionName="LayerExtension";var sp=sc,sd=i(5595),su=i(261),sf={bearing:0,pitch:0,position:[0,0,0]},sg={speed:1.2,curve:1.414},sm=class extends eW{constructor(t={}){super({compare:["longitude","latitude","zoom","bearing","pitch","position"],extract:["width","height","longitude","latitude","zoom","bearing","pitch","position"],required:["width","height","latitude","longitude","zoom"]}),this.opts={...sg,...t}}interpolateProps(t,e,i){let r=(0,su.flyToViewport)(t,e,i,this.opts);for(let s in sf)r[s]=(0,sd.lerp)(t[s]||sf[s],e[s]||sf[s],i);return r}getDuration(t,e){let{transitionDuration:i}=e;return"auto"===i&&(i=(0,su.getFlyToDuration)(t,e,this.opts)),i}},s_=i(3957),sv=class{constructor(t){this.indexStarts=[0],this.vertexStarts=[0],this.vertexCount=0,this.instanceCount=0;let{attributes:e={}}=t;this.typedArrayManager=tk,this.attributes={},this._attributeDefs=e,this.opts=t,this.updateGeometry(t)}updateGeometry(t){Object.assign(this.opts,t);let{data:e,buffers:i={},getGeometry:r,geometryBuffer:s,positionFormat:o,dataChanged:n,normalize:a=!0}=this.opts;if(this.data=e,this.getGeometry=r,this.positionSize=s&&s.size||("XY"===o?2:3),this.buffers=i,this.normalize=a,s&&(eG(e.startIndices),this.getGeometry=this.getGeometryFromBuffer(s),a||(i.vertexPositions=s)),this.geometryBuffer=i.vertexPositions,Array.isArray(n))for(let t of n)this._rebuildGeometry(t);else this._rebuildGeometry()}updatePartialGeometry({startRow:t,endRow:e}){this._rebuildGeometry({startRow:t,endRow:e})}getGeometryFromBuffer(t){let e=t.value||t;return ArrayBuffer.isView(e)?iO(e,{size:this.positionSize,offset:t.offset,stride:t.stride,startIndices:this.data.startIndices}):null}_allocate(t,e){let{attributes:i,buffers:r,_attributeDefs:s,typedArrayManager:o}=this;for(let n in s)if(n in r)o.release(i[n]),i[n]=null;else{let r=s[n];r.copy=e,i[n]=o.allocate(i[n],t,r)}}_forEachGeometry(t,e,i){let{data:r,getGeometry:s}=this,{iterable:o,objectInfo:n}=iL(r,e,i);for(let e of o)n.index++,t(s?s(e,n):null,n.index)}_rebuildGeometry(t){if(!this.data)return;let{indexStarts:e,vertexStarts:i,instanceCount:r}=this,{data:s,geometryBuffer:o}=this,{startRow:n=0,endRow:a=1/0}=t||{},l={};if(t||(e=[0],i=[0]),this.normalize||!o)this._forEachGeometry((t,e)=>{let r=t&&this.normalizeGeometry(t);l[e]=r,i[e+1]=i[e]+(r?this.getGeometrySize(r):0)},n,a),r=i[i.length-1];else if(r=(i=s.startIndices)[s.length]||0,ArrayBuffer.isView(o))r=r||o.length/this.positionSize;else if(o instanceof s_.Buffer){let t=4*this.positionSize;r=r||o.byteLength/t}else if(o.buffer){let t=o.stride||4*this.positionSize;r=r||o.buffer.byteLength/t}else if(o.value){let t=o.value,e=o.stride/t.BYTES_PER_ELEMENT||this.positionSize;r=r||t.length/e}this._allocate(r,!!t),this.indexStarts=e,this.vertexStarts=i,this.instanceCount=r;let h={};this._forEachGeometry((t,s)=>{let o=l[s]||t;h.vertexStart=i[s],h.indexStart=e[s],h.geometrySize=(s<i.length-1?i[s+1]:r)-i[s],h.geometryIndex=s,this.updateGeometryAttributes(o,h)},n,a),this.vertexCount=e[e.length-1]}};function sw(t,e){e&&Object.entries(e).map(([e,i])=>{e.startsWith("--")?t.style.setProperty(e,i):t.style[e]=i})}function sy(t,e){e&&Object.keys(e).map(e=>{e.startsWith("--")?t.style.removeProperty(e):t.style[e]=""})}}}]);