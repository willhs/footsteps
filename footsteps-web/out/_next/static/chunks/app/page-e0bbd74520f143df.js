(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{1180:(e,t,r)=>{Promise.resolve().then(r.bind(r,8161))},8161:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>eh});var n=r(56),l=r(4068);let a=[-1e4,-9e3,-8e3,-7e3,-6e3,-5e3,-4e3,-3e3,-2e3,-1e3,0,100,200,300,400,500,600,700,800,900,1e3];function o(e){return e<0?"".concat(Math.abs(e)," BC"):0===e?"1 CE":"".concat(e," CE")}let i=a[0],s=a[a.length-1];function u(e){return 100*(1-Math.log(s-e+800)/Math.log(s-i+800))}let c=u(s);function d(e){return u(Math.min(Math.max(e,i),s))/c*100}function h(e){let t,r=((t=Math.exp((1-Math.min(Math.max(e,0),100)/100*c/100*c/c)*Math.log(s-i+800))-800)<0&&(t=0),Math.round(s-t)),n=a[0],l=Math.abs(r-n);for(let e of a){let t=Math.abs(r-e);t<l&&(l=t,n=e)}return n}let m="globe-view-mode",p=l.memo(function(e){let{loading:t=!1,dotCount:r,totalPopulation:a,viewState:i,lodLevel:s,progressiveRenderStatus:u,year:c}=e,[d,h]=(0,l.useState)(a),m=(0,l.useRef)(null),p=(0,l.useRef)(null),[g,f]=(0,l.useState)(r),b=(0,l.useRef)(null),y=(0,l.useRef)(null),[v,x]=(0,l.useState)(!1),[w,T]=(0,l.useState)(!1),[C,N]=(0,l.useState)(!1),M=(0,l.useRef)(null),S=(0,l.useRef)(null),E=(0,l.useRef)(null),[j,L]=(0,l.useState)({hits:0,misses:0,tiles:0,bytes:0});return(0,l.useEffect)(()=>{let e=e=>{let t=e.detail;t&&"number"==typeof t.hits&&L(t)};globalThis.addEventListener("pmtiles-cache-stats",e);try{let e=globalThis;e.__pmtilesFeatureStats&&L(e.__pmtilesFeatureStats)}catch(e){}return()=>globalThis.removeEventListener("pmtiles-cache-stats",e)},[]),(0,l.useEffect)(()=>{if(m.current&&(window.clearTimeout(m.current),m.current=null),p.current&&(window.clearTimeout(p.current),p.current=null),!t)return a>0?m.current=window.setTimeout(()=>{h(a)},120):p.current=window.setTimeout(()=>{h(0)},500),()=>{m.current&&(window.clearTimeout(m.current),m.current=null),p.current&&(window.clearTimeout(p.current),p.current=null)}},[t,a]),(0,l.useEffect)(()=>{if(b.current&&(window.clearTimeout(b.current),b.current=null),y.current&&(window.clearTimeout(y.current),y.current=null),!t)return r>0?b.current=window.setTimeout(()=>{f(r)},120):y.current=window.setTimeout(()=>{f(0)},500),()=>{b.current&&(window.clearTimeout(b.current),b.current=null),y.current&&(window.clearTimeout(y.current),y.current=null)}},[t,r]),(0,l.useEffect)(()=>(M.current&&window.clearTimeout(M.current),x(!0),M.current=window.setTimeout(()=>x(!1),180),()=>{M.current&&window.clearTimeout(M.current)}),[c]),(0,l.useEffect)(()=>(S.current&&window.clearTimeout(S.current),T(!0),S.current=window.setTimeout(()=>T(!1),120),()=>{S.current&&window.clearTimeout(S.current)}),[d]),(0,l.useEffect)(()=>(E.current&&window.clearTimeout(E.current),N(!0),E.current=window.setTimeout(()=>N(!1),120),()=>{E.current&&window.clearTimeout(E.current)}),[g]),(0,n.jsxs)("div",{className:"absolute backdrop-blur-md bg-black/40 bg-opacity-50 rounded-md p-3 text-slate-200 font-sans",style:{top:"1rem",left:"1rem",zIndex:30},children:[(0,n.jsx)("div",{className:"text-2xl font-normal text-slate-400 mb-1 year-text metric-value ".concat(v?"metric-flash":""),"aria-live":"polite",children:o(c)}),(0,n.jsx)("div",{className:"text-xl font-semibold mb-2",children:(0,n.jsx)("span",{className:"metric-value ".concat(w?"metric-flash":""),children:d>=1e9?"".concat(Math.round(d/1e9).toLocaleString(),"B people"):d>=1e6?"".concat(Math.round(d/1e6).toLocaleString(),"M people"):d>=1e3?"".concat(Math.round(d/1e3).toLocaleString(),"K people"):"".concat(Math.round(d).toLocaleString()," people")})}),u&&u.rendered<u.total&&(0,n.jsxs)("div",{className:"text-xs text-slate-300 mt-2",children:["Loading settlements:"," ",(u.rendered/u.total*100).toFixed(0),"%"]}),(0,n.jsxs)("div",{className:"mt-2 pt-2 border-t border-slate-700/60 text-xs text-slate-500 space-y-1",children:[(0,n.jsxs)("div",{children:["Zoom: ",i.zoom.toFixed(1),"x • LOD: ",s]}),(0,n.jsxs)("div",{children:["Dots drawn:"," ",(0,n.jsx)("span",{className:"metric-value ".concat(C?"metric-flash":""),children:g.toLocaleString()})]}),(0,n.jsxs)("div",{children:["Cache:"," ",(0,n.jsx)("span",{title:"Tiles held in memory",children:j.tiles})," ","tiles •"," ",(0,n.jsx)("span",{title:"Approximate memory used",children:(e=>{if(!e||e<1024)return"".concat(e||0," B");let t=["KB","MB","GB"],r=e,n=-1;do r/=1024,n++;while(r>=1024&&n<t.length-1);return"".concat(r.toFixed(r>=100?0:r>=10?1:2)," ").concat(t[n])})(j.bytes)})," ","•"," ",(0,n.jsxs)("span",{title:"Memory cache hits / misses",children:[j.hits,"/",j.misses]})," ",(0,n.jsxs)("span",{title:"Memory cache hit rate",children:["(",j.hits+j.misses>0?Math.round(j.hits/(j.hits+j.misses)*100):0,"% )"]})]})]})]})});var g=r(4396),f=r.n(g),b=r(7673);let y="1"===r(354).env.NEXT_PUBLIC_DEBUG_LOGS;function v(e){let{mode:t,viewState:r,onViewStateChange:a,layers:o,children:i}=e,s="3d"===t,u=(0,l.useRef)(null),[c,d]=(0,l.useState)({width:800,height:600}),h=(0,l.useMemo)(()=>new b._GlobeView({width:c.width,height:c.height}),[c.width,c.height]),m=(0,l.useMemo)(()=>new b.MapView({width:c.width,height:c.height}),[c.width,c.height]),p=(0,l.useMemo)(()=>({dragPan:!0,dragRotate:!0,scrollZoom:!0,touchZoom:!0,touchRotate:!0,keyboard:!1}),[]);return(0,l.useEffect)(()=>{let e=u.current;if(!e)return;let t=()=>{let t=e.getBoundingClientRect(),r={width:Math.floor(t.width),height:Math.floor(t.height)};y&&console.log("[DECK-SIZE] Container size:",r),d(r)};t();let r=new ResizeObserver(t);return r.observe(e),()=>{r.disconnect()}},[]),y&&console.log("[DECK-SIZE] Rendering with dimensions:",c),y&&console.log("[DECK-SIZE] Key for recreation:","".concat(c.width,"x").concat(c.height)),(0,n.jsx)("div",{ref:u,style:{width:"100%",height:"100%",position:"relative"},children:(0,n.jsxs)(f(),{views:s?h:m,viewState:r,onViewStateChange:a,controller:!!s||p,layers:o,getCursor:()=>"crosshair",width:c.width,height:c.height,style:{position:"absolute",top:"0px",left:"0px",background:s?"#000010":"#000810"},children:[(0,n.jsx)("div",{style:{position:"absolute",width:"100%",height:"100%",background:s?"radial-gradient(circle at center, #000020 0%, #000000 100%)":"radial-gradient(circle at center, #001122 0%, #000000 100%)",zIndex:-1}}),i]},"".concat(c.width,"x").concat(c.height))})}function x(e){let[t,r]=(0,l.useState)(!1),n=(0,l.useRef)(null),a=(0,l.useCallback)(()=>{r(!0),n.current&&clearTimeout(n.current),n.current=setTimeout(()=>{r(!1),n.current=null},e)},[e]);return(0,l.useEffect)(()=>()=>{n.current&&clearTimeout(n.current)},[]),[t,a]}let w="inline-flex items-center gap-0 rounded-full bg-gray-700/70 p-0 backdrop-blur-md shadow-lg ring-1 ring-gray-600/40";function T(e){let{pressed:t,onClick:r,label:l,title:a,activeClassName:o,children:i}=e;return(0,n.jsx)("button",{onClick:r,className:"".concat("w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center rounded-full leading-none text-2xl transition-colors duration-200"," ").concat(t?o:"text-gray-200 hover:text-white hover:bg-white/10"),title:null!=a?a:l,"aria-pressed":t,"aria-label":l,children:i})}function C(e){let{showTerrain:t,onToggle:r}=e;return(0,n.jsxs)("div",{className:w,role:"group","aria-label":"Background style",children:[(0,n.jsx)(T,{pressed:t,onClick:()=>r(!0),label:"Terrain",title:"\uD83C\uDFD4️ Show terrain imagery",activeClassName:"bg-emerald-500 text-white shadow-md",children:"\uD83C\uDFD4️"}),(0,n.jsx)(T,{pressed:!t,onClick:()=>r(!1),label:"Plain",title:"⚫️ Plain background for dot clarity",activeClassName:"bg-emerald-500 text-white shadow-md",children:"⚫️"})]})}let N={white:{name:"White",colors:{highest:[255,255,255,240],high:[240,240,240,220],medium:[220,220,220,200],low:[200,200,200,180]}},cyan:{name:"Cyan",colors:{highest:[0,255,255,240],high:[0,220,255,220],medium:[0,180,255,200],low:[100,200,255,180]}},violet:{name:"Violet",colors:{highest:[138,43,226,240],high:[148,70,230,220],medium:[160,100,235,200],low:[180,140,240,180]}},black:{name:"Black",colors:{highest:[0,0,0,240],high:[40,40,40,220],medium:[80,80,80,200],low:[120,120,120,180]}}};function M(e){let{colorScheme:t,onSchemeChange:r,className:l}=e;return(0,n.jsx)("div",{className:"flex justify-center gap-1 ".concat(l||""),role:"group","aria-label":"Color scheme",children:["cyan","white","black","violet"].map(e=>{let l=N[e],a=t===e,o=l.colors.highest,i="rgb(".concat(o[0],", ").concat(o[1],", ").concat(o[2],")");return(0,n.jsx)("button",{onClick:()=>r(e),title:"".concat(l.name," - Click to use this color scheme for human dots"),className:"w-3 h-3 rounded-full border ".concat("white"===e?a?"border-blue-400":"border-gray-300":a?"border-blue-400":"border-gray-600"),style:{backgroundColor:i},"aria-label":l.name},e)})})}function S(e){let{showTerrain:t,onToggle:r,is3DMode:l,onModeChange:a,colorScheme:o,onColorSchemeChange:i,className:s}=e;return(0,n.jsxs)("div",{className:"flex flex-col gap-3 ".concat(s||""),children:[(0,n.jsxs)("div",{className:w,role:"group","aria-label":"View mode",children:[(0,n.jsx)(T,{pressed:!l,onClick:()=>a(!1),label:"Map view",title:"\uD83D\uDDFA️ 2D Map view",activeClassName:"bg-blue-500 text-white shadow-md",children:"\uD83D\uDDFA️"}),(0,n.jsx)(T,{pressed:l,onClick:()=>a(!0),label:"Globe view",title:"\uD83C\uDF0D 3D Globe view",activeClassName:"bg-blue-500 text-white shadow-md",children:"\uD83C\uDF0D"})]}),(0,n.jsx)(C,{showTerrain:t,onToggle:r}),(0,n.jsx)(M,{colorScheme:o,onSchemeChange:i})]})}function E(e){var t;let{data:r,onClose:a}=e,[o,i]=(0,l.useState)(!1),s=(0,l.useCallback)(()=>{i(!1),setTimeout(()=>{a()},200)},[a]);if((0,l.useEffect)(()=>{if(r){i(!0);let e=setTimeout(()=>{s()},5e3);return()=>clearTimeout(e)}},[r,s]),(0,l.useEffect)(()=>{let e=e=>{"Escape"===e.key&&s()};if(r)return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[r,s]),!r)return null;let u=function(e,t){var r;let n=e.x+16,l=e.y-100-16,a=window.innerWidth,o=(r=void 0,window.innerHeight);return void 0!==a&&void 0!==o&&(n+260>a-16&&(n=e.x-260-16),l<16&&(l=e.y+16),l+100>o-16&&(l=o-100-16),n<16&&(n=16)),{left:n,top:l}}(r.clickPosition),c=(t=r.population)>1e6?{scale:"Megacity",icon:"\uD83C\uDFD9️",significance:"Major urban center"}:t>5e5?{scale:"Metropolis",icon:"\uD83C\uDF06",significance:"Large city"}:t>1e5?{scale:"City",icon:"\uD83C\uDFD8️",significance:"Urban settlement"}:t>5e4?{scale:"Large Town",icon:"\uD83C\uDFD8️",significance:"Regional center"}:t>1e4?{scale:"Town",icon:"\uD83C\uDFD8️",significance:"Local hub"}:t>2e3?{scale:"Village",icon:"\uD83C\uDFE0",significance:"Rural community"}:t>500?{scale:"Hamlet",icon:"\uD83C\uDFE1",significance:"Small settlement"}:{scale:"Outpost",icon:"⛺",significance:"Remote presence"},d=Math.round(r.population),h=1===d?"person":"people";return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:"fixed pointer-events-none transition-all duration-200 ease-out z-50 ".concat(o?"opacity-100 scale-100":"opacity-0 scale-95"),style:{left:"".concat(u.left,"px"),top:"".concat(u.top,"px"),minWidth:"220px",maxWidth:"260px"},children:(0,n.jsxs)("div",{className:"pointer-events-auto bg-slate-900/95 backdrop-blur-sm rounded-md p-3 pr-4 text-white shadow-xl border border-slate-700/40",children:[(0,n.jsx)("div",{className:"mb-2",children:(0,n.jsxs)("div",{className:"text-3xl font-semibold text-orange-300 leading-none tracking-tight",children:[(0,n.jsx)("span",{className:"font-mono",children:d.toLocaleString()})," ",(0,n.jsx)("span",{className:"text-base font-normal text-slate-300",children:h})]})}),(0,n.jsxs)("div",{className:"flex items-center justify-between mb-2 gap-2",children:[(0,n.jsx)("div",{className:"text-xs text-slate-400 truncate",children:r.year<0?"".concat(Math.abs(r.year)," BC"):"".concat(r.year," CE")}),(0,n.jsxs)("div",{className:"flex items-center gap-2 flex-shrink-0",children:[(0,n.jsx)("div",{className:"text-[10px] px-1.5 py-0.5 rounded border border-slate-700 bg-slate-800 text-slate-300",children:c.scale}),(0,n.jsx)("button",{onClick:s,className:"text-slate-400 hover:text-white hover:bg-slate-700/50 transition-all duration-200 text-base leading-none w-6 h-6 flex items-center justify-center rounded",title:"Close (ESC)","aria-label":"Close tooltip",children:"\xd7"})]})]}),(0,n.jsx)("div",{className:"text-[11px] text-slate-400",children:function(e){let[t,r]=e;return"".concat(Math.abs(r).toFixed(2),"\xb0").concat(r>=0?"N":"S",", ").concat(Math.abs(t).toFixed(2),"\xb0").concat(t>=0?"E":"W")}(r.coordinates)})]})})})}let j=(0,l.createContext)(void 0);function L(e){let{children:t}=e,[r,a]=(0,l.useState)(null);return(0,n.jsxs)(j.Provider,{value:{setTooltipData:a},children:[t,(0,n.jsx)(E,{data:r,onClose:()=>a(null)})]})}class k{calculateRadius(e,t){return e}getName(){return"linear"}}class R{calculateRadius(e,t){return e*this.getZoomMultiplier(t)}getZoomMultiplier(e){return e<3?6:e<5?3:1.5}getName(){return"zoom-adaptive"}}class _{calculateRadius(e,t){let r=Math.max(.5*e,5e3);return t<-2?2.5*r:t<0?2*r:t<2?1.5*r:t<4?1.2*r:+r}getName(){return"globe-3d"}}let A={linear:new k,zoomAdaptive:new R,globe3D:new _};var F=r(878),D=r(4379),P=r(354);let B="1"===P.env.NEXT_PUBLIC_DEBUG_LOGS;function z(e,t){try{if(!e||"FeatureCollection"!==e.type||!Array.isArray(e.features))return{type:"FeatureCollection",features:[]};let t=e.features.filter(e=>{try{let t=null==e?void 0:e.geometry;if(!t||"Polygon"!==t.type&&"MultiPolygon"!==t.type)return!1;let r=t.coordinates,n=e=>"number"==typeof e&&Number.isFinite(e),l=e=>Array.isArray(e)&&e.length>=4&&e.every(e=>{let t,r;return Array.isArray(e)&&n(e[0])&&n(e[1])&&(t=e[0])>=-180&&t<=180&&(r=e[1])>=-85&&r<=85});if("Polygon"===t.type)return l((null==r?void 0:r[0])||[]);if("MultiPolygon"===t.type)return Array.isArray(r)&&r.some(e=>l((null==e?void 0:e[0])||[]));return!1}catch(e){return!1}});return{type:"FeatureCollection",features:t}}catch(e){return{type:"FeatureCollection",features:[]}}}function U(e){let t=function(){let e="https://pmtiles.willhs.me".replace(/\/+$/,"");return/^https?:\/\//i.test(e)?e:"https://pmtiles.willhs.me"}();return"".concat(t,"/humans_").concat(e,".pmtiles")}P.env.NEXT_PUBLIC_ENABLE_CONTINENTS;var O=r(1643),I=r(354);class G{getKey(){return this.baseUrl}setHeaders(e){this.customHeaders=e}buildUrl(e,t){try{let r=new URL(this.baseUrl,window.location.origin);return r.searchParams.set("rk","".concat(e,"-").concat(e+t-1)),r.toString()}catch(n){let r=this.baseUrl.includes("?")?"&":"?";return"".concat(this.baseUrl).concat(r,"rk=").concat(e,"-").concat(e+t-1)}}async getBytes(e,t,r,n){let l=new Headers(this.customHeaders);l.set("range","bytes=".concat(e,"-").concat(e+t-1)),l.set("accept-encoding","identity");let a=this.buildUrl(e,t),o=I.env.NEXT_PUBLIC_PM_FETCH_CACHE||"default",i=await fetch(a,{signal:r,headers:l,cache:o}),s=i.headers.get("Content-Length");if(200===i.status&&(!s||+s>t))throw Error("Server returned full body for a Range request; byte serving unsupported");let u=i.headers.get("Etag")||void 0;if(u&&u.startsWith("W/")&&(u=void 0),416===i.status||n&&u&&u!==n)throw new O.WM("ETag mismatch on ranged request");if(i.status>=300)throw Error("Bad response code: ".concat(i.status));return{data:await i.arrayBuffer(),etag:u,cacheControl:i.headers.get("Cache-Control")||void 0,expires:i.headers.get("Expires")||void 0}}constructor(e,t){this.baseUrl=e,this.customHeaders=new Headers(t)}}var H=r(5174),W=r(8305),V=r(354);let Z=new Map,X=globalThis,K=X.__pmtilesCache||new O.j1(2e3);X.__pmtilesCache=K;let q=Number(V.env.NEXT_PUBLIC_PM_LRU_TILES||1500),Y=Number(V.env.NEXT_PUBLIC_PM_LRU_BYTES||0x8000000),J=X.__pmtilesFeatureCache||{map:new Map,bytes:0};X.__pmtilesFeatureCache=J;let $=X.__pmtilesFeatureStats||{hits:0,misses:0,tiles:0,bytes:0};function Q(){try{var e,t;$.tiles=J.map.size,$.bytes=J.bytes;let r=new CustomEvent("pmtiles-cache-stats",{detail:{...$}});null==(e=(t=globalThis).dispatchEvent)||e.call(t,r)}catch(e){}}X.__pmtilesFeatureStats=$;class ee extends D.A{renderSubLayers(e){let{data:t}=e.tile;return t&&0!==t.length?new F.GeoJsonLayer({...this.getSubLayerProps(e),id:"".concat(this.props.id,"-geojson-").concat(e.tile.index.x,"-").concat(e.tile.index.y,"-").concat(e.tile.index.z),data:t,pointType:"circle",getPointRadius:this.props.getPointRadius,getFillColor:this.props.getFillColor,pointRadiusUnits:this.props.pointRadiusUnits||"meters",opacity:this.props.opacity,pickable:this.props.pickable,onClick:this.props.onClick,onHover:this.props.onHover,updateTriggers:this.props.updateTriggers,transitions:this.props.transitions,parameters:this.props.parameters}):null}constructor(...e){super(...e),this.getTileData=async e=>{var t,r,n,l;let{x:a,y:o,z:i}=e.index,s=null==e?void 0:e.signal,u=function(e){let t,r=Z.get(e);if(r)return r;let n="true"===(V.env.NEXT_PUBLIC_PM_ADD_RK||"false");/^https?:\/\//i.test(e),t=n?new G(e):new O.i$(e);let l=new O.HC(t,K);return Z.set(e,l),l}(this.props.pmtilesUrl),c=(null==(t=this.props.mvtLayers)?void 0:t[0])||"humans",d="".concat(this.props.pmtilesUrl,"|").concat(c,"|").concat(i,"|").concat(a,"|").concat(o),h=function(e){let t=J.map.get(e);return t?(J.map.delete(e),J.map.set(e,t),t.features):null}(d);if(h){if($.hits+=1,Q(),"true"===(V.env.NEXT_PUBLIC_DEBUG_LOGS||"false"))try{console.debug("[PMTilesTileLayer] cache HIT",{z:i,x:a,y:o})}catch(e){}return h}$.misses+=1,Q();try{let e=await u.getZxy(i,a,o,s);if(!e||!e.data)return null;let t=await (0,H.q)(e.data,W.h,{mvt:{coordinates:"wgs84",tileIndex:{x:a,y:o,z:i},shape:"geojson"}}),h=[];if(Array.isArray(t))h=t;else if(t&&"object"==typeof t)if((null==t?void 0:t.type)==="FeatureCollection"&&Array.isArray(t.features))h=t.features;else if(Array.isArray(t.features))h=t.features;else if((null==(r=t[c])?void 0:r.type)==="FeatureCollection"&&Array.isArray(null==(n=t[c])?void 0:n.features))h=t[c].features;else if(Array.isArray(t[c]))h=t[c];else{let e=[];for(let r of Object.keys(t)){let n=t[r];if(n)if(Array.isArray(n))for(let t of n)t&&"object"==typeof t&&("Feature"===t.type||t.geometry)&&e.push(t);else"FeatureCollection"===n.type&&Array.isArray(n.features)&&e.push(...n.features)}if(e.length)h=e;else{let e=Object.keys(t);e.length>0&&e.every(e=>/^\d+$/.test(e))&&(h=e.map(e=>t[e]))}}if("true"===(V.env.NEXT_PUBLIC_DEBUG_LOGS||"false"))try{console.debug("[PMTilesTileLayer] features",{z:i,x:a,y:o,count:h.length})}catch(e){}let m=0;try{let t=null==e?void 0:e.data;t&&"object"==typeof t&&("number"==typeof t.byteLength?m=Number(t.byteLength):"number"==typeof(null==t||null==(l=t.buffer)?void 0:l.byteLength)&&(m=Number(t.buffer.byteLength)))}catch(e){}return!function(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:q,l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Y;if(!t||0===t.length)return;let a=J.map.get(e);a&&(J.bytes-=a.bytes,J.map.delete(e));let o=Math.max(r||0,200*t.length);for(J.map.set(e,{key:e,features:t,bytes:o}),J.bytes+=o;J.map.size>n||J.bytes>l;){let e=J.map.keys().next().value;if(!e)break;let t=J.map.get(e);t&&(J.bytes-=t.bytes),J.map.delete(e)}Q()}(d,h,m),h}catch(e){if((null==e?void 0:e.name)==="AbortError"||(null==e?void 0:e.message)==="AbortError")return null;return console.warn("[PMTilesTileLayer] Failed to load tile:",{z:i,x:a,y:o,error:e}),null}}}}function et(e,t){var r;if(null==e?void 0:e.object){let n=(null==(r=e.object.properties)?void 0:r.population)||0;return{population:n,coordinates:e.coordinate||[0,0],year:t,clickPosition:{x:e.x||0,y:e.y||0}}}return null}ee.layerName="PMTilesTileLayer",ee.defaultProps={...D.A.defaultProps,data:[]};let er="true"===(r(354).env.NEXT_PUBLIC_ENABLE_PLAIN_BASEMAP||"true");function en(e){let{year:t}=e,r=function(){let e=(0,l.useContext)(j);if(!e)throw Error("useTooltipOverlay must be used within TooltipOverlay");return e.setTooltipData}(),[a,o]=(0,l.useState)(()=>(function(){if("undefined"==typeof document)return!1;try{var e;let t=null==(e=document.cookie.split("; ").find(e=>e.startsWith("".concat(m,"="))))?void 0:e.split("=")[1];return"true"===t}catch(e){return console.warn("Failed to read view mode cookie:",e),!1}})()),[i,s]=(0,l.useState)("cyan"),{viewState:u,onViewStateChange:c,isZooming:d,isPanning:h}=function(){let[e,t]=(0,l.useState)(()=>(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";try{let t=new URLSearchParams(e),r=t.get("lat"),n=t.get("lon")||t.get("lng"),l=t.get("zoom")||t.get("z"),a=null!==r?Number(r):NaN,o=null!==n?Number(n):NaN,i=null!==l?Number(l):NaN;return{longitude:Number.isFinite(o)?o:0,latitude:Number.isFinite(a)?a:20,zoom:Number.isFinite(i)?i:1.5,pitch:0,bearing:0}}catch(e){}return{longitude:0,latitude:20,zoom:1.5,pitch:0,bearing:0}})(window.location.search)),r=(0,l.useRef)(e),[n,a]=x(800),[o,i]=x(600),s=(0,l.useRef)(n);return(0,l.useEffect)(()=>{s.current=n},[n]),{viewState:e,isZooming:n,isPanning:o,onViewStateChange:(0,l.useCallback)(e=>{var n,l;let{viewState:o}=e,u={longitude:o.longitude,latitude:o.latitude,zoom:o.zoom,pitch:null!=(n=o.pitch)?n:0,bearing:null!=(l=o.bearing)?l:0},c=r.current;r.current=u,t(u),"number"==typeof u.zoom&&Math.abs(u.zoom-c.zoom)>.01&&a(),(Math.abs(u.longitude-c.longitude)>.1||Math.abs(u.latitude-c.latitude)>.1)&&!s.current&&i()},[a,i])}}(),[g,f]=(0,l.useState)(!0),[b,y]=(0,l.useState)(!0),[w,T]=(0,l.useState)(0),[C,M]=(0,l.useState)(0),[E,L]=(0,l.useState)(()=>Date.now()),{backgroundLayers:k,showTerrain:R,setShowTerrain:_}=function(){let[e,t]=(0,l.useState)(()=>!er);return{backgroundLayers:(0,l.useMemo)(()=>e?[new D.A({id:"terrain-layer",data:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",maxZoom:8,minZoom:0,onTileLoad:()=>{},onViewportLoad:()=>{},onTileError:()=>{},renderSubLayers:e=>{var t,r,n,l,a;if(!e.data)return null;let{boundingBox:o}=null!=(a=e.tile)?a:{};return o&&Number.isFinite(null==(t=o[0])?void 0:t[0])&&Number.isFinite(null==(r=o[0])?void 0:r[1])&&Number.isFinite(null==(n=o[1])?void 0:n[0])&&Number.isFinite(null==(l=o[1])?void 0:l[1])?new F.BitmapLayer(e,{id:"".concat(e.id,"-bitmap"),data:void 0,image:e.data,bounds:[o[0][0],o[0][1],o[1][0],o[1][1]],updateTriggers:{image:e.data}}):(B&&console.warn("[terrain-layer] invalid boundingBox, skipping sub-layer",o),null)},pickable:!1,opacity:1,parameters:{depthTest:!0,depthMask:!0,blend:!1}})]:[new F.PolygonLayer({id:"plain-sea",data:[{id:"sea",polygon:[[-179,-85],[179,-85],[179,85],[-179,85],[-179,-85]]}],getPolygon:e=>e.polygon,filled:!0,stroked:!1,getFillColor:[20,30,45,255],pickable:!1,opacity:1,wrapLongitude:!0,parameters:{depthTest:!1,depthMask:!1,blend:!0,blendFunc:[770,771]}}),new F.GeoJsonLayer({id:"plain-continents",data:"/world-simple.geojson",dataTransform:z,filled:!0,stroked:!1,getFillColor:[15,15,15,255],pickable:!1,opacity:1,wrapLongitude:!0,parameters:{depthTest:!1,depthMask:!1,blend:!0,blendFunc:[770,771]}})],[e]),showTerrain:e,setShowTerrain:t}}(),{layers:P,stableLODLevel:O}=function(e){let{year:t,is3DMode:r,viewState:n,isZooming:a,isPanning:o,colorScheme:i,setTileLoading:s,setMetricsLoading:u,setFeatureCount:c,setTotalPopulation:d,setTooltipData:h}=e,{previousYear:m,currentOpacity:p,previousOpacity:g,newLayerHasTileRef:f}={previousYear:null,currentOpacity:1,previousOpacity:0,newLayerReadyRef:{current:!0},newLayerHasTileRef:(0,l.useRef)(!1),startCrossfade:()=>{}},b=Math.floor(n.zoom),y=(0,l.useMemo)(()=>b<2?0:b<4?1:b<6?2:3,[b]),v=(0,l.useMemo)(()=>(function(e){let{is3DMode:t,layerViewState:r,isZooming:n,isPanning:l,newLayerHasTileRef:a,callbacks:o,metrics:i,tileFadeMs:s=1e3,colorScheme:u="white"}=e;return function(e,c,d,h,m){return function(e,t,r){var n,l,a,o,i,s,u,c,d;let h=arguments.length>3&&void 0!==arguments[3]?arguments[3]:A.zoomAdaptive,m=arguments.length>4?arguments[4]:void 0,p=arguments.length>5?arguments[5]:void 0,g=arguments.length>6?arguments[6]:void 0,f=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,b=arguments.length>8?arguments[8]:void 0,y=(null==r?void 0:r.zoom)||1,v=(null==g?void 0:g.tileOptions)||{},x=(null==g?void 0:g.colorScheme)||"orange";return new ee({...{id:b||"human-tiles-".concat(e,"-").concat(h.getName(),"-").concat(x),mvtLayers:["humans"],minZoom:0,maxZoom:12,extent:[-180,-85,180,85],refinementStrategy:null!=(l=v.refinementStrategy)?l:"best-available",maxCacheSize:null!=(a=v.maxCacheSize)?a:1e3,maxCacheByteSize:null!=(o=v.maxCacheByteSize)?o:0x8000000,debounceTime:null!=(i=v.debounceTime)?i:0,maxRequests:null!=(s=v.maxRequests)?s:12,pickable:!0,onClick:m||(()=>{}),onHover:p||(()=>{}),onTileLoad:(d=null==g?void 0:g.onTileLoad,e=>{try{let t=e&&"content"in e?e.content:void 0,r="number"==typeof(null==t?void 0:t.byteLength)&&Number.isFinite(t.byteLength);if(t&&!r){let e=0;try{e="string"==typeof t?t.length:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?t.byteLength||0:JSON.stringify(t).length}catch(e){}if(Number.isFinite(e)&&e>0)try{t.byteLength=e}catch(e){}}}catch(e){}"function"==typeof d&&d(e)}),onViewportLoad:(null==g?void 0:g.onViewportLoad)||(()=>{}),onTileError:(null==g?void 0:g.onTileError)||(e=>{console.error("[PMTILES-TILE-ERROR]",e)}),pointRadiusUnits:"meters",getPointRadius:e=>{try{var t;let r=function(e){let t=[{threshold:100,radius:2e3},{threshold:1e3,radius:4e3},{threshold:5e3,radius:8e3},{threshold:2e4,radius:15e3},{threshold:5e4,radius:25e3},{threshold:1e5,radius:4e4},{threshold:1e6,radius:6e4}],r=(e,t,r)=>{let n=Math.min(1,Math.max(0,(r-e)/(t-e)));return n*n*(3-2*n)},n=1e3;for(let l=0;l<t.length;l++){let{threshold:a,radius:o}=t[l],i=.85*a,s=1.15*a;if(e<i)break;if(e<=s)return n+(o-n)*r(i,s,e);n=o}return n}(Number((null==e||null==(t=e.properties)?void 0:t.population)||0));return h.calculateRadius(r,y)}catch(e){return console.error("[RADIUS-ERROR]:",e),2e3}},getFillColor:e=>(function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"white";try{var n;let l,a=Number((null==e||null==(n=e.properties)?void 0:n.population)||0),o=N[r];if(l=a>2e4?o.colors.highest:a>5e3?o.colors.high:a>1e3?o.colors.medium:o.colors.low,t&&Array.isArray(t)){let e=e=>Math.max(0,Math.min(255,e)),r=e(l[0]+t[0]),n=e(l[1]+t[1]),a=e(l[2]+t[2]);return[r,n,a,l[3]]}return l}catch(e){return(N[r]||N.white).colors.low}})(e,null==g?void 0:g.debugTint,null==g?void 0:g.colorScheme),updateTriggers:{getPointRadius:[e,t,Math.floor(4*(y||0))/4,h.getName()],getFillColor:[e,t,null==g||null==(n=g.debugTint)?void 0:n.join(","),null==g?void 0:g.colorScheme],getTileData:[e,U(e),"humans"]},opacity:f,parameters:{depthTest:!1,depthMask:!1,blend:!0,blendFunc:[770,771]},transitions:{opacity:{duration:null!=(u=v.fadeMs)?u:300,easing:v.easing||(e=>e*e*(3-2*e))},getPointRadius:{duration:null!=(c=v.radiusTransitionMs)?c:250,easing:v.easing||(e=>e*e*(3-2*e))}}},data:[],pmtilesUrl:U(e)})}(e,c,r,t?A.globe3D:A.zoomAdaptive,t=>{let r=et(t,e);r&&o.setTooltipData(r)},t=>{o.setTooltipData(et(t,e))},{onTileLoad:e=>{m&&(o.setTileLoading(!1),a.current||(a.current=!0))},onViewportLoad:t=>{try{if(m){var r,n,l;let e=0,s=0;for(let l of t){let t=null==l?void 0:l.data;if(Array.isArray(t)){for(let n of(e+=t.length,t)){let e=(null==n||null==(r=n.properties)?void 0:r.population)||0;s+=e}continue}let a=function(e){try{var t,r,n,l,a,o,i,s,u,c,d;let h=(null==e||null==(t=e.content)?void 0:t.data)||(null==e?void 0:e.data)||(null==e||null==(r=e.content)?void 0:r.data)||(null==e?void 0:e.content)||e,m=null!=(i=null==h?void 0:h.layers)?i:h,p=null!=(s=null==m?void 0:m.humans)?s:m;if(!p&&m&&"object"==typeof m){let e=Object.keys(m);p=m[e.find(e=>e.includes("humans"))||e[0]]}let g=null!=(u=null==p?void 0:p.points)?u:p,f=null!=(c=null==g||null==(n=g.positions)?void 0:n.value)?c:null==g?void 0:g.positions,b=null==g?void 0:g.properties,y=null!=(d=null==g||null==(a=g.numericProps)||null==(l=a.population)?void 0:l.value)?d:null==g||null==(o=g.numericProps)?void 0:o.population,v=0;f&&"number"==typeof f.length&&(v=Math.max(v,Math.floor(f.length/2))),Array.isArray(b)&&(v=Math.max(v,b.length)),y&&"number"==typeof y.length&&(v=Math.max(v,Number(y.length)));let x=[],w=e=>{var t;if(y&&"number"==typeof y.length)return Number(y[e])||0;let r=null==b||null==(t=b[e])?void 0:t.population;return Number(r)||0};for(let e=0;e<v;e++){let t;if(f&&"number"==typeof f.length){let r=f[2*e],n=f[2*e+1];"number"==typeof r&&"number"==typeof n&&(t=[r,n])}x.push({properties:{population:w(e)},coordinates:t})}return x}catch(e){return console.error("[BINARY-FEATURES-ERROR]:",e),[]}}(l);if(a.length)for(let t of(e+=a.length,a))s+=(null==(n=t.properties)?void 0:n.population)||0}if(i.setFeatureCount(e),i.setTotalPopulation(s),a.current||e>0||s>0)try{null==(l=o.setMetricsLoading)||l.call(o,!1)}catch(e){}o.setTileLoading(!1)}}catch(t){console.error("[VIEWPORT-LOAD-ERROR] Year: ".concat(e,", LOD: ").concat(c,":"),t),o.setTileLoading(!1)}},onTileError:t=>{var r,n,l;let a=(null==t||null==(r=t.tile)?void 0:r.index)||(null==t?void 0:t.index)||{},i=(null==t||null==(n=t.tile)?void 0:n.url)||(null==t?void 0:t.url)||"unknown",s=(null==t||null==(l=t.response)?void 0:l.status)||(null==t?void 0:t.status)||"unknown";console.error("[TILE-ERROR] Failed to load tile:",{year:e,lodLevel:c,coords:"".concat(a.z,"/").concat(a.x,"/").concat(a.y),url:i,status:s,error:(null==t?void 0:t.message)||(null==t?void 0:t.error)||t}),o.setTileLoading(!1)},tileOptions:{fadeMs:s,refinementStrategy:n||l?"no-overlap":"best-available",debounceTime:n||l?80:10,maxRequests:12,radiusTransitionMs:250*!m},debugTint:void 0,colorScheme:u},d,h)}})({is3DMode:r,layerViewState:n,isZooming:a,isPanning:o,newLayerHasTileRef:f,callbacks:{setTileLoading:s,setMetricsLoading:u,setTooltipData:h},metrics:{setFeatureCount:c,setTotalPopulation:d},colorScheme:i}),[r,n,a,o,f,s,u,h,c,d,i]),x=(0,l.useMemo)(()=>v(t,y,p,"human-layer-current-".concat(i),!0),[v,t,y,p,i]),w=(0,l.useMemo)(()=>null!==m?v(m,y,g,"human-layer-previous-".concat(i),!1):null,[v,m,y,g,i]);return{layers:w?[w,x]:[x],stableLODLevel:y}}({year:t,is3DMode:a,viewState:u,isZooming:d,isPanning:h,colorScheme:i,setTileLoading:f,setMetricsLoading:y,setFeatureCount:T,setTotalPopulation:M,setTooltipData:r});(0,l.useEffect)(()=>{if("undefined"!=typeof document)try{document.cookie="".concat(m,"=").concat(a,"; max-age=").concat(31536e3,"; path=/; SameSite=Lax")}catch(e){console.warn("Failed to set view mode cookie:",e)}},[a]),(0,l.useEffect)(()=>{f(!0),y(!0),T(0),L(Date.now())},[t]);let I=[...k,...P];return(0,n.jsxs)("div",{className:"relative w-full h-full",children:[(0,n.jsx)(v,{mode:a?"3d":"2d",viewState:u,onViewStateChange:c,layers:I}),(0,n.jsx)(p,{loading:b||Date.now()-E<1e3&&0===C,dotCount:w,totalPopulation:C,viewState:u,lodLevel:O,lodEnabled:!1,toggleLOD:()=>{},renderMetrics:{loadTime:0,processTime:0,renderTime:0,lastUpdate:0},cacheSize:1,progressiveRenderStatus:void 0,viewportBounds:null,is3DMode:a,year:t}),(0,n.jsx)("div",{className:"absolute top-4 right-4 z-10 flex flex-col gap-2",children:(0,n.jsx)(S,{is3DMode:a,onModeChange:o,showTerrain:R,onToggle:_,colorScheme:i,onColorSchemeChange:s})})]})}r(354).env.NEXT_PUBLIC_DEBUG_LOGS;let el=(0,l.memo)(function(e){return(0,n.jsx)(L,{children:(0,n.jsx)(en,{...e})})});var ea=r(3188);let eo=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return t?e<=-1e3&&e%1e3==0?"".concat(Math.abs(e/1e3),"kBC"):e<0?"".concat(Math.abs(e),"BC"):e>=1e3&&e%100==0?"".concat((e/1e3).toFixed(+(e%1e3!=0)),"k"):e.toString():e<0?"".concat(Math.abs(e)," BC"):0===e?"0":e>=1e3&&e%1e3==0&&1e3!==e?"".concat(e/1e3,"k"):e.toString()},ei=[...a].sort((e,t)=>e-t),es=ei.reduce((e,t)=>(e[t]=d(t),e),{});function eu(e,t,r,n){let a=e<0?"".concat(Math.abs(e)," BC"):"".concat(e);return(0,l.createElement)("span",{role:"button",tabIndex:0,"aria-label":"Jump to ".concat(a),onMouseDown:e=>{e.stopPropagation(),null==n||n(t)},onTouchStart:e=>{e.stopPropagation(),null==n||n(t)},onKeyDown:e=>{("Enter"===e.key||" "===e.key)&&(e.preventDefault(),e.stopPropagation(),null==n||n(t))},"data-year":e},r||"\xa0")}function ec(e){let{value:t,onChange:r,onBeforeChange:a,onChangeComplete:o}=e,[i,s]=(0,l.useState)(!1),u=function(e,t){let r=function(){let[e,t]=(0,l.useState)(1024);return(0,l.useEffect)(()=>{let e=null,r=()=>{null!==e&&cancelAnimationFrame(e),e=requestAnimationFrame(()=>{t(window.innerWidth),e=null})};return r(),window.addEventListener("resize",r),()=>{window.removeEventListener("resize",r),null!==e&&cancelAnimationFrame(e)}},[]),e}(),n=r<640,a=(0,l.useMemo)(()=>(e=>{let t=70/e*100,r=[];return ei.forEach(e=>{let n=es[e],l=Math.abs(e)>=1e3&&Math.abs(e)%1e3==0;(!r.some(e=>Math.abs(n-es[e])<t)||l)&&r.push(e)}),r})(r),[r]),o=(0,l.useMemo)(()=>{let e={};ei.forEach(r=>{let n=es[r];e[n]||(e[n]={label:eu(r,n,"",t),style:{opacity:.85}})});let r=e=>{if(e>=0)return!0;let t=Math.abs(e);return!(t>=7e3)||t%2e3==0};return a.forEach(l=>{let a=es[l],o=Math.abs(l)>=1e3&&Math.abs(l)%1e3==0;e[a]={label:r(l)?eu(l,a,eo(l,n),t):eu(l,a,"",t),style:r(l)?{color:o?"#38bdf8":"#f1f5f9",fontWeight:o?500:400,fontSize:n?"0.7rem":void 0,opacity:o?.95:n?.8:.85,letterSpacing:n?"0.01em":"0.015em",transition:"all 200ms ease-out"}:{opacity:.85}}}),e},[a,n,t]);return(0,l.useMemo)(()=>{let r=h(e),l=es[r],a={...o};a[l]?a[l]={...a[l],label:eu(r,l,eo(r,n),t),style:{...a[l].style,color:"#0ea5e9",fontWeight:700,fontSize:n?"0.9rem":"1.125rem",textShadow:n?"0 0 8px rgba(14, 165, 233, 0.35)":"0 0 20px rgba(14, 165, 233, 0.5)",opacity:1}}:a[l]={label:eu(r,l,eo(r,n),t),style:{color:"#0ea5e9",fontWeight:700,fontSize:n?"0.9rem":"1.125rem",textShadow:n?"0 0 8px rgba(14, 165, 233, 0.35)":"0 0 20px rgba(14, 165, 233, 0.5)",opacity:1,letterSpacing:n?"0.005em":"0.01em"}};let i=ei.indexOf(r);return[ei[i-1],ei[i+1]].filter(e=>"number"==typeof e).forEach(e=>{let t=es[e];a[t]&&a[t].label&&(a[t]={...a[t],style:{...a[t].style,color:"#38bdf8",fontWeight:600,fontSize:n?"0.8rem":"1rem",opacity:.95}})}),a},[e,o,n,t])}(t,(0,l.useCallback)(e=>{r(e)},[r])),c=(0,l.useRef)(null),d=(0,l.useRef)(null),m=(0,l.useCallback)(()=>{c.current=null,null!=d.current&&(r(d.current),d.current=null)},[r]),p=(0,l.useCallback)(e=>{let t=Array.isArray(e)?e[0]:e;i?(d.current=t,null==c.current&&(c.current=requestAnimationFrame(m))):r(t)},[m,i,r]),g=(0,l.useCallback)(()=>{s(!0),null==a||a()},[a]),f=(0,l.useCallback)(()=>{s(!1),null!=c.current&&cancelAnimationFrame(c.current),c.current=null,null!=d.current&&(r(d.current),d.current=null),null==o||o()},[r,o]);return(0,n.jsx)("div",{className:"time-slider-container",children:(0,n.jsx)("div",{className:"w-full",children:(0,n.jsx)("div",{className:"py-6",children:(0,n.jsx)(ea.A,{min:0,max:100,value:t,onChange:p,onBeforeChange:g,onChangeComplete:f,marks:u,step:null,dots:!0,included:!0,className:"time-slider w-full","aria-label":"Time slider"})})})})}class ed extends l.Component{static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("Globe rendering error:",e,t)}render(){if(this.state.hasError){var e;return(0,n.jsx)("div",{className:"w-full h-full flex items-center justify-center bg-gray-900",children:(0,n.jsxs)("div",{className:"bg-black/90 backdrop-blur-sm rounded-lg p-8 text-white text-center max-w-md",children:[(0,n.jsx)("div",{className:"text-4xl mb-4",children:"⚠️"}),(0,n.jsx)("div",{className:"text-xl font-bold mb-2",children:"Rendering Error"}),(0,n.jsx)("div",{className:"text-gray-400 mb-4",children:"The visualization encountered an error. This usually happens with large datasets."}),(0,n.jsxs)("div",{className:"text-sm text-left bg-gray-800 rounded p-3 font-mono",children:[(0,n.jsxs)("div",{className:"text-red-400 mb-2",children:["Error: ",null==(e=this.state.error)?void 0:e.message]}),(0,n.jsx)("div",{className:"text-blue-400 mb-1",children:"# Try refreshing the page"}),(0,n.jsx)("div",{className:"text-blue-400",children:"# Or reduce the dataset size"})]}),(0,n.jsx)("button",{onClick:()=>window.location.reload(),className:"mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white",children:"Refresh Page"})]})})}return this.props.children}constructor(e){super(e),this.state={hasError:!1}}}function eh(){let{year:e,sliderValue:t,updateSlider:r}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,[t,r]=(0,l.useState)(e),[n,a]=(0,l.useState)(d(e));return{year:t,sliderValue:n,updateYear:(0,l.useCallback)(e=>{r(e),a(d(e))},[]),updateSlider:(0,l.useCallback)(e=>{let t=h(e);a(e),r(t)},[]),formattedYear:o(t)}}(-1e3);return(0,n.jsxs)("main",{className:"relative w-full h-full overflow-hidden bg-black",children:[(0,n.jsx)(ed,{children:(0,n.jsx)(el,{year:e})}),(0,n.jsx)(ec,{value:t,onChange:r})]})}},9120:()=>{}},e=>{e.O(0,[737,824,813,947,798,524,46,358],()=>e(e.s=1180)),_N_E=e.O()}]);